diff --git a/.gitignore b/.gitignore
index b8bd026..b083bb8 100644
--- a/.gitignore
+++ b/.gitignore
@@ -26,3 +26,6 @@
 *.exe
 *.out
 *.app
+
+# Vim
+*.swp 
diff --git a/Classes/AbilityButton.cpp b/Classes/AbilityButton.cpp
new file mode 100644
index 0000000..18e0f9e
--- /dev/null
+++ b/Classes/AbilityButton.cpp
@@ -0,0 +1,127 @@
+#include "AbilityButton.h"
+
+using namespace cocos2d;
+
+#define FIRE "firebutton.png"
+#define WATER "waterbutton.png"
+#define WOOD "woodbutton.png"
+#define FIRE_DOWN "firebuttondown.png"
+#define WATER_DOWN "waterbuttondown.png"
+#define WOOD_DOWN "woodbuttondown.png"
+
+	
+bool AbilityButton::init()
+{
+	srand(time(0));
+	return true;
+}
+
+void AbilityButton::CreateButton()
+{
+	/* Õý³£×´Ì¬ÏÂµÄ°´Å¥Í¼Æ¬ */
+	CCScale9Sprite* btnfire = CCScale9Sprite::create(FIRE);
+	CCScale9Sprite* btnwater = CCScale9Sprite::create(WATER);
+	CCScale9Sprite* btnwood = CCScale9Sprite::create(WOOD);
+	/* µã»÷×´Ì¬ÏÂµÄ°´Å¥Í¼Æ¬ */  
+    CCScale9Sprite* btnfireDown = CCScale9Sprite::create(FIRE_DOWN); 
+	CCScale9Sprite* btnwaterDown = CCScale9Sprite::create(WATER_DOWN); 
+	CCScale9Sprite* btnwoodDown = CCScale9Sprite::create(WOOD_DOWN); 
+	/* °´Å¥±êÌâ */  
+	firetitle = CCLabelTTF::create("@@", "Marker Felt", 80);  
+	watertitle = CCLabelTTF::create("@@", "Marker Felt", 80);  
+	woodtitle = CCLabelTTF::create("@@", "Marker Felt", 80);  
+
+//	fireBtn->setPreferredSize(CCSize(100, 100));
+//	waterBtn->setPreferredSize(CCSize(100, 100));
+//	woodBtn->setPreferredSize(CCSize(100, 100));
+	/* °´Å¥µÄ´óÐ¡»á¸ù¾Ý±êÌâ×Ô¶¯µ÷Õû */
+	fireBtn = CCControlButton::create(firetitle, btnfire);  
+	waterBtn = CCControlButton::create(watertitle, btnwater); 
+	woodBtn = CCControlButton::create(woodtitle, btnwood); 
+	/* ÉèÖÃ°´Å¥°´ÏÂÊ±µÄÍ¼Æ¬ */  
+	fireBtn->setBackgroundSpriteForState(btnfireDown, CCControlStateSelected);  
+	waterBtn->setBackgroundSpriteForState(btnwaterDown, CCControlStateSelected);  
+	woodBtn->setBackgroundSpriteForState(btnwoodDown, CCControlStateSelected);  
+	
+	this->addChild(fireBtn); 
+	this->addChild(waterBtn); 
+	this->addChild(woodBtn); 
+
+	BindButtonEvent();
+}
+
+void AbilityButton::setButtonPosition(CCPoint pos)
+{
+	fireBtn->setPosition(ccp(pos.x,pos.y));  
+	waterBtn->setPosition(ccp(pos.x+100,pos.y));  
+	woodBtn->setPosition(ccp(pos.x+200,pos.y));  
+}
+
+void AbilityButton::BindButtonEvent()
+{
+	fireBtn->addTargetWithActionForControlEvents(this,cccontrol_selector(AbilityButton::fireTouchUpOutside),CCControlEventTouchUpInside);
+	waterBtn->addTargetWithActionForControlEvents(this,cccontrol_selector(AbilityButton::waterTouchUpOutside),CCControlEventTouchUpInside);
+	woodBtn->addTargetWithActionForControlEvents(this,cccontrol_selector(AbilityButton::woodTouchUpOutside),CCControlEventTouchUpInside);
+}
+
+void AbilityButton::LockButtonTouch()
+{
+	fireBtn->setTouchEnabled(false);
+	waterBtn->setTouchEnabled(false);
+	woodBtn->setTouchEnabled(false);
+}
+
+void AbilityButton::UnlockButtonTouch()
+{
+	fireBtn->setTouchEnabled(true);
+	waterBtn->setTouchEnabled(true);
+	woodBtn->setTouchEnabled(true);
+}
+
+void AbilityButton::fireTouchUpOutside(CCObject* pSender, CCControlEvent event)
+{
+	this->isTouch = true;
+	tag = fire;
+	CCLOG("fire");
+}
+void AbilityButton::waterTouchUpOutside(CCObject* pSender, CCControlEvent event)
+{
+	this->isTouch = true;
+	tag = water;
+}
+void AbilityButton::woodTouchUpOutside(CCObject* pSender, CCControlEvent event)
+{
+	this->isTouch = true;
+	tag = wood;
+}
+
+void AbilityButton::updateDamage(int level)
+{
+
+	//Ë¢ÐÂÉËº¦Ëã·¨
+	fireDamage = (int)(CCRANDOM_0_1()*(40+level));
+	waterDamage = (int)(CCRANDOM_0_1()*(40+level));
+	woodDamage = (int)(CCRANDOM_0_1()*(40+level));
+	//labelÏÔÊ¾
+	char fireDamageString[10];
+	char waterDamageString[10];
+	char woodDamageString[10];
+	sprintf(fireDamageString,"%d",fireDamage);
+	sprintf(waterDamageString,"%d",waterDamage);
+	sprintf(woodDamageString,"%d",woodDamage);
+	firetitle->setString(fireDamageString);
+	watertitle->setString(waterDamageString);
+	woodtitle->setString(woodDamageString);
+}
+
+int AbilityButton::getDamageByTag(int tag)
+{
+	if (tag==fire)
+		return fireDamage;
+	else if (tag==water)
+		return waterDamage;
+	else if (tag==wood)
+		return woodDamage;
+	else
+		return 0;
+}
\ No newline at end of file
diff --git a/Classes/AbilityButton.h b/Classes/AbilityButton.h
new file mode 100644
index 0000000..68f681c
--- /dev/null
+++ b/Classes/AbilityButton.h
@@ -0,0 +1,52 @@
+ï»¿#ifndef __ABILITY_BUTTON_H__
+#define __ABILITY_BUTTON_H__
+#include "cocos2d.h"
+#include "cocos-ext.h"
+#include "time.h"
+
+USING_NS_CC;
+USING_NS_CC_EXT; 
+
+typedef enum{
+	fire,
+	water,
+	wood,
+	metal
+}tagForButton;
+
+class AbilityButton :public CCNode
+{
+public:
+	CREATE_FUNC(AbilityButton);
+public:
+	virtual bool init();
+	//åˆ›å»ºæŒ‰é’®
+	void CreateButton();
+	//è®¾ç½®ä½ç½®
+	void setButtonPosition(CCPoint pos);
+	//ç»‘å®šäº‹ä»¶
+	void BindButtonEvent();
+	//
+	void fireTouchUpOutside(CCObject* pSender, CCControlEvent event);
+	void waterTouchUpOutside(CCObject* pSender, CCControlEvent event);
+	void woodTouchUpOutside(CCObject* pSender, CCControlEvent event);
+	//é”å®šè§¦æ‘¸
+	void LockButtonTouch();
+	//è§£é”è§¦æ‘¸
+	void UnlockButtonTouch();
+	//åˆ·æ–°æŠ€èƒ½ä¼¤å®³
+	void updateDamage(int level);
+	//èŽ·å–ä¼¤å®³å€¼
+	int getDamageByTag(int tag);
+	bool isTouch;
+	int tag;
+	int fireDamage,waterDamage,woodDamage;
+private:
+	CCControlButton* fireBtn; 
+	CCControlButton* waterBtn; 
+	CCControlButton* woodBtn; 
+	CCLabelTTF *firetitle;
+	CCLabelTTF *watertitle;
+	CCLabelTTF *woodtitle;
+};
+#endif
\ No newline at end of file
diff --git a/Classes/AnimLib.cpp b/Classes/AnimLib.cpp
new file mode 100644
index 0000000..7461d51
--- /dev/null
+++ b/Classes/AnimLib.cpp
@@ -0,0 +1,100 @@
+#include "AnimLib.h"
+
+//update:2014-10-3 01:30:47
+
+CCFiniteTimeAction* AnimLib::getAction(int choice,CCSize size)
+{
+	CCFiniteTimeAction* action=NULL;
+	switch(choice)
+	{
+	case TAISHANYADING:
+		{
+		CCMoveBy* dun=CCMoveBy::create(0.20f,ccp(0,-size.height/2));
+		CCMoveBy* qi=CCMoveBy::create(0.20f,ccp(0,size.height/2));
+		CCMoveBy* tui=CCMoveBy::create(0.20f,ccp(size.width/2,0));
+		CCMoveBy* hui=CCMoveBy::create(0.20f,ccp(-size.width/2,0));
+		action=CCSequence::create(dun,qi,tui,hui,NULL);
+		}
+		break;
+	case STAGGER:
+		{
+		CCMoveBy* yao=CCMoveBy::create(0.28f,ccp(size.width,0));
+		CCMoveBy* bai=CCMoveBy::create(0.28f,ccp(-size.width,0));
+		action=CCSequence::create(yao,bai,yao,bai,NULL);
+		}
+	case STRIKE:
+		{
+		CCMoveBy* yao=CCMoveBy::create(0.10f,ccp(size.width/2,0));
+		CCMoveBy* bai=CCMoveBy::create(0.10f,ccp(-size.width/2,0));
+		action=CCSequence::create(yao,bai,NULL);
+		}
+		break;
+	case ATTACK:
+		{
+		CCMoveBy* yao=CCMoveBy::create(0.15f,ccp(size.width/2,0));
+		CCMoveBy* bai=CCMoveBy::create(0.15f,ccp(-size.width/2,0));
+		action=CCSequence::create(yao,bai,NULL);
+		}
+		break;
+	case UP:
+		{
+		CCMoveBy* up=CCMoveBy::create(0.35f,ccp(0,size.height));
+		action=up;
+		}
+		break;
+	case DOWN:
+		{
+		CCMoveBy* down=CCMoveBy::create(1.0f,ccp(0,-size.height));
+		action=down;
+		}
+		break;
+	case TELEPORTOUT:
+		{
+		CCBlink* shan=CCBlink::create(0.20f,2);
+		CCHide* hide=CCHide::create();
+		action=CCSequence::create(shan,hide,NULL);
+		}
+		break;
+	case TELEPORTIN:
+		{
+		CCBlink* shan=CCBlink::create(0.20f,2);
+		CCShow* show=CCShow::create();
+		action=CCSequence::create(shan,show,NULL);
+		}
+		break;
+	case STEALTHOUT:
+		{
+		CCFadeTo* fadeOut=CCFadeTo::create(0.50f,75);
+		action=fadeOut;
+		}
+		break;
+	case STEALTHIN:
+		{
+		CCFadeIn* fadeIn=CCFadeIn::create(0.50f);
+		action=fadeIn;
+		}
+		break;
+	case SWAY:
+		{
+		CCRotateTo* rotate = CCRotateTo::create(0.2,10,10);
+		CCRotateTo* rotate1 = CCRotateTo::create(0.2,-10,-10);
+		CCRotateTo* rotate2 = CCRotateTo::create(0.2,0,0);
+		action = CCSequence::create(rotate,rotate1,rotate2,NULL);
+		}
+		break;
+	case FADEOUT:
+		{
+			CCFadeTo* fadeTo = CCFadeTo::create(0.5,0);
+			action = fadeTo;
+		}
+		break;
+	case FADEIN:
+		{
+			CCFadeTo* fadeTo = CCFadeTo::create(0.5,255);
+			action = fadeTo;
+		}
+	default:
+		break;
+	}
+	return action;
+}
diff --git a/Classes/AnimLib.h b/Classes/AnimLib.h
new file mode 100644
index 0000000..bc3a39a
--- /dev/null
+++ b/Classes/AnimLib.h
@@ -0,0 +1,28 @@
+#ifndef _ANIMLIB_H_
+#define _ANIMLIB_H_
+#include "cocos2d.h"
+using namespace cocos2d;
+
+#define TAISHANYADING 1
+#define STAGGER 2
+#define STRIKE 3
+#define DOWN 5
+#define UP 4
+#define ATTACK 0
+#define STEALTH 6
+#define TELEPORTOUT 7
+#define TELEPORTIN 8
+#define STEALTHOUT 9
+#define STEALTHIN 10
+#define SWAY 11
+#define FADEOUT 12
+#define FADEIN 13
+
+
+class AnimLib
+{
+public:
+	static CCFiniteTimeAction* getAction(int choice,CCSize size);
+};
+
+#endif
diff --git a/Classes/Animation.cpp b/Classes/Animation.cpp
deleted file mode 100644
index 1cd707a..0000000
--- a/Classes/Animation.cpp
+++ /dev/null
@@ -1,94 +0,0 @@
-#include "Animation.h"
-
-//update:2014-10-3 01:30:47
-
-CCFiniteTimeAction* Animation::getAction(int choice,CCSize size)
-{
-	CCFiniteTimeAction* action=NULL;
-	switch(choice)
-	{
-	case TAISHANYADING:
-		{
-		CCMoveBy* dun=CCMoveBy::create(0.20f,ccp(0,-size.height/2));
-		CCMoveBy* qi=CCMoveBy::create(0.20f,ccp(0,size.height/2));
-		CCMoveBy* tui=CCMoveBy::create(0.20f,ccp(size.width/2,0));
-		CCMoveBy* hui=CCMoveBy::create(0.20f,ccp(-size.width/2,0));
-		action=CCSequence::create(dun,qi,tui,hui,NULL);
-		}
-		break;
-	case STAGGER:
-		{
-		CCMoveBy* yao=CCMoveBy::create(0.28f,ccp(size.width,0));
-		CCMoveBy* bai=CCMoveBy::create(0.28f,ccp(-size.width,0));
-		action=CCSequence::create(yao,bai,yao,bai,NULL);
-		}
-	case STRIKE:
-		{
-		CCMoveBy* yao=CCMoveBy::create(0.10f,ccp(size.width/2,0));
-		CCMoveBy* bai=CCMoveBy::create(0.10f,ccp(-size.width/2,0));
-		action=CCSequence::create(yao,bai,NULL);
-		}
-		break;
-	case ATTACK:
-		{
-		CCMoveBy* yao=CCMoveBy::create(0.15f,ccp(size.width/2,0));
-		CCMoveBy* bai=CCMoveBy::create(0.15f,ccp(-size.width/2,0));
-		action=CCSequence::create(yao,bai,NULL);
-		}
-		break;
-	case UP:
-		{
-		CCMoveBy* up=CCMoveBy::create(0.35f,ccp(0,size.height));
-		action=up;
-		}
-		break;
-	case DOWN:
-		{
-		CCMoveBy* down=CCMoveBy::create(1.0f,ccp(0,-size.height));
-		action=down;
-		}
-		break;
-	case TELEPORTOUT:
-		{
-		CCBlink* shan=CCBlink::create(0.20f,2);
-		CCHide* hide=CCHide::create();
-		action=CCSequence::create(shan,hide,NULL);
-		}
-		break;
-	case TELEPORTIN:
-		{
-		CCBlink* shan=CCBlink::create(0.20f,2);
-		CCShow* show=CCShow::create();
-		action=CCSequence::create(shan,show,NULL);
-		}
-		break;
-	case STEALTHOUT:
-		{
-		CCFadeTo* fadeOut=CCFadeTo::create(0.50f,75);
-		action=fadeOut;
-		}
-		break;
-	case STEALTHIN:
-		{
-		CCFadeIn* fadeIn=CCFadeIn::create(0.50f);
-		action=fadeIn;
-		}
-		break;
-	case SWAY:
-		{
-		CCRotateTo* rotate = CCRotateTo::create(0.2,10,10);
-		CCRotateTo* rotate1 = CCRotateTo::create(0.2,-10,-10);
-		CCRotateTo* rotate2 = CCRotateTo::create(0.2,0,0);
-		action = CCSequence::create(rotate,rotate1,rotate2,NULL);
-		}
-		break;
-	case FADEOUT:
-		{
-			CCFadeOut* fadeOut = CCFadeOut::create(0.5);
-			action = fadeOut;
-		}
-	default:
-		break;
-	}
-	return action;
-}
\ No newline at end of file
diff --git a/Classes/Animation.h b/Classes/Animation.h
deleted file mode 100644
index 3ed3c30..0000000
--- a/Classes/Animation.h
+++ /dev/null
@@ -1,27 +0,0 @@
-#ifndef _ANIMATION_H_
-#define _ANIMATION_H_
-#include "cocos2d.h"
-using namespace cocos2d;
-
-#define TAISHANYADING 1
-#define STAGGER 2
-#define STRIKE 3
-#define DOWN 5
-#define UP 4
-#define ATTACK 0
-#define STEALTH 6
-#define TELEPORTOUT 7
-#define TELEPORTIN 8
-#define STEALTHOUT 9
-#define STEALTHIN 10
-#define SWAY 11
-#define FADEOUT 12
-
-
-class Animation
-{
-public:
-	static CCFiniteTimeAction* getAction(int choice,CCSize size);
-};
-
-#endif
\ No newline at end of file
diff --git a/Classes/AppMacros.h b/Classes/AppMacros.h
index 0d69bf1..2bf6d22 100644
--- a/Classes/AppMacros.h
+++ b/Classes/AppMacros.h
@@ -57,6 +57,9 @@
 #define FACEDIR_MRCD "FaceDirection"
 #define MAPNO_MRCD "MapNo"
 #define STORYCNT_MRCD "StoryCnt"
+#define HAS_SHADOW_MRCD "HasShadow"
+#define SH_STAND_P_MRCD "ShStandPos"
+#define STORY_TIME_MRCD "StoryTime"
 #define EVENTDONE_MRCD "EventDone"
 
 #define SPEED_SRCD "Speed"
@@ -66,6 +69,8 @@
 #define FLASH_SRCD "Flash"
 #define ALL_SUPERPOWER_SRCD "AllSuperPower"
 
+#define EXP_CRCD "Exp"
+
 //ÓÎÏ·¼ÇÂ¼µÄ³õÊ¼ÖµÃüÃû·¨ÊÇÊôÐÔÃû¼Ó_INI
 #define FIRSTSAVE_INI true
 #define POSITIONX_INI 63
@@ -73,8 +78,13 @@
 #define FACEDIR_INI 0
 #define MAPNO_INI MAP11
 #define STORYCNT_INI 0
+#define HAS_SHADOW_INI false
+#define SH_STAND_P_INI 2
+#define STORY_TIME_INI 10
 #define EVENTDONE_INI ""
 
+#define EXP_INI 0
+
 #define SPEED_INI 2.0
 #define TELEPORT_INI false
 #define STEALTH_INI false
@@ -82,6 +92,8 @@
 #define FLASH_INI false
 #define ALL_SUPERPOWER_INI false
 
+
+
 #define MAX_DONE_LIST 100
 #define DEFUALT_DELIM ','
 
@@ -114,6 +126,7 @@
 #define IDY_ATT "idy"
 
 #define CHANGESCENE_EVT "change scene"
+#define MAP10 18
 #define MAP11 19
 #define MAP12 20
 #define EVENT_MAP11 0
@@ -166,14 +179,31 @@
 #define STAND_TRIG 1
 #define STAND_TRIG_IMGNO -10
 #define ATRIG_NO_MAN_IMGNO -1
+#define MAP_SCALER 100
 
 //Event Ids
 #define NO_EVENT_FLAG -1
 #define TALKMAN_EVT 0
 #define GET_SUP_EVT 1
 #define DIALOG_EVT 2
+#define SHADOW_EVT 3
+#define RELOAD_EVT 4
 
+//Notification Center
+#define HERO_STEP_UP_MSG "HeroStepUp"
 typedef enum{kNone=1,kWall=17,kEvent=41}CollisionType;
 typedef enum{Down=0,Left=1,Right=2,Up=3}FaceDirection;
 
+//zorders
+#define HERO_ON_MAP_ZOR 5
+#define HERO_MOVE_BACK_ZOR 3
+#define NPC_ON_MAP_BACK_ZOR 4
+#define NPC_ON_MAP_FRON_ZOR 6
+#define HERO_ON_PANEL_ZOR 3
+#define PANEL_ON_MAPLYR_ZOR 15
+#define WIN_ON_PANEL_ZOR 11
+
+//switches
+#define DEBUG_MODE true
+#define HERO_COVER_MODE FALSE
 #endif /* __APPMACROS_H__ */
diff --git a/Classes/Blood.cpp b/Classes/Blood.cpp
new file mode 100644
index 0000000..91dc9a2
--- /dev/null
+++ b/Classes/Blood.cpp
@@ -0,0 +1,31 @@
+ï»¿#include "Blood.h"
+USING_NS_CC;
+
+bool Blood::init()
+{
+	return true;
+}
+void Blood::setBloodSlider()
+{
+	this->bloodSlider = CCControlSlider::create(CCSprite::create(BLOODBACKGROUND),
+										  CCSprite::create(BLOOD),
+										  CCSprite::create(SLIDERTHUMB));
+	this->addChild(bloodSlider,2);
+	bloodSlider->setTouchEnabled(false);
+}
+
+void Blood::setSliderPosition(CCPoint pos)
+{
+	bloodSlider->setPosition(ccp(pos.x,pos.y));
+}
+
+void Blood::setTotalBlood(float total)
+{
+	bloodSlider->setMaximumValue(total);
+	bloodSlider->setMinimumValue(0);
+}
+
+void Blood::setCurrentBlood(float currentHp)
+{
+	bloodSlider->setValue(currentHp);
+}
diff --git a/Classes/Blood.h b/Classes/Blood.h
new file mode 100644
index 0000000..212b5ae
--- /dev/null
+++ b/Classes/Blood.h
@@ -0,0 +1,26 @@
+ï»¿#ifndef __BLOOD_H__
+#define __BLOOD_H__
+#include "cocos2d.h"
+#include "cocos-ext.h"
+using namespace cocos2d;
+USING_NS_CC_EXT; 
+
+#define BLOODBACKGROUND "bloodbackground.png"
+#define BLOOD "blood.png"
+#define SLIDERTHUMB "thumb.png"
+
+class Blood : public CCNode
+{
+public:
+	CREATE_FUNC(Blood);
+public:
+	virtual bool init();
+    void setBloodSlider();
+	void setSliderPosition(CCPoint pos);
+	void setTotalBlood(float total);
+	void setCurrentBlood(float currentHp);
+private:
+	CCControlSlider* bloodSlider;
+};
+
+#endif
\ No newline at end of file
diff --git a/Classes/ButtonA.cpp b/Classes/ButtonA.cpp
index dab6904..781f009 100644
--- a/Classes/ButtonA.cpp
+++ b/Classes/ButtonA.cpp
@@ -1,5 +1,5 @@
 #include "ButtonA.h"
-#include "Animation.h"//$
+#include "AnimLib.h"//$
 
 //update:2014-9-26 01:59:07
 
diff --git a/Classes/CPlayer.cpp b/Classes/CPlayer.cpp
new file mode 100644
index 0000000..1cde45f
--- /dev/null
+++ b/Classes/CPlayer.cpp
@@ -0,0 +1,33 @@
+#include "CPlayer.h"
+
+bool CPlayer::init()
+{
+	exp = sGlobal->playerState->exp;
+	CCLOG("exp:%d",exp);
+	exp2Level(exp);
+	healthPoint=100+level*2;
+	currentHp=healthPoint;
+	
+	return true;
+}
+void CPlayer::setPlayer()
+{
+	 CCSize visibleSize = CCDirector::sharedDirector()->getVisibleSize();
+	player = CCSprite::create(PLAYER);
+	player->setPosition(ccp(100,visibleSize.height-200));
+	this->addChild(player);
+}
+
+void CPlayer::exp2Level(int exp)
+{
+	if (exp<2)
+		level=1;
+	else if (exp>=2&&exp<=30)
+		level=1+exp/2;
+	else if(exp>30&&exp<=60)
+		level = 16+(exp-30)/3;
+	else if(exp>60&&exp<=180)
+		level = 26+(exp-60)/5;
+	else
+		level = 50;
+}
\ No newline at end of file
diff --git a/Classes/CPlayer.h b/Classes/CPlayer.h
new file mode 100644
index 0000000..a5fb35e
--- /dev/null
+++ b/Classes/CPlayer.h
@@ -0,0 +1,22 @@
+#ifndef __CPLAYER_H__
+#define __CPLAYER_H__
+#include "Role.h"
+#include "GlobalState.h"
+
+using namespace cocos2d;
+ 
+#define PLAYER "player.png"
+
+class CPlayer:public Role
+{
+public:
+	CREATE_FUNC(CPlayer);
+public:
+	virtual bool init();
+	void setPlayer();
+	void attack();
+	void exp2Level(int exp);
+private:
+	CCSprite* player;
+};
+#endif 
\ No newline at end of file
diff --git a/Classes/CombatAnimation.cpp b/Classes/CombatAnimation.cpp
new file mode 100644
index 0000000..e7f2432
--- /dev/null
+++ b/Classes/CombatAnimation.cpp
@@ -0,0 +1,85 @@
+#include "CombatAnimation.h"
+
+void CombatAnimation::fireParticle(int direction)
+{
+	CCParticleSystemQuad *m_emitter=new CCParticleSystemQuad();
+	m_emitter->initWithTotalParticles(40);//900¸öÁ£×Ó¶ÔÏó
+	//ÉèÖÃÍ¼Æ¬
+	m_emitter->setTexture(CCTextureCache::sharedTextureCache()->addImage("particleFire.png"));
+	//ÉèÖÃ·¢ÉäÁ£×ÓµÄ³ÖÐøÊ±¼ä-1±íÊ¾Ò»Ö±·¢Éä£¬0Ã»ÓÐÒâÒå£¬ÆäËûÖµ±íÊ¾³ÖÐøÊ±¼ä
+	m_emitter->setDuration(3);
+
+
+
+	/*
+	//ÉèÖÃÖÐÐÄ·½Ïò,Õâ¸öµêÊÇÏà¶Ô·¢Éäµã£¬xÕý·½ÏòÎªÓÒ£¬yÕý·½ÏòÎªÉÏ
+	m_emitter->setGravity(CCPoint(0,-240));
+
+
+	//ÉèÖÃ½Ç¶È£¬½Ç¶ÈµÄ±ä»¯ÂÊ
+	m_emitter->setAngle(90);
+	m_emitter->setAngleVar(360);
+
+
+	//ÉèÖÃ¾¶Ïò¼ÓËÙ¶È£¬¾¶Ïò¼ÓËÙ¶ÈµÄ±ä»¯ÂÊ
+	m_emitter->setRadialAccel(50);
+	m_emitter->setRadialAccelVar(0);
+
+	//ÉèÖÃÁ£×ÓµÄÇÐÏò¼ÓËÙ¶È£¬ÇÐÏò¼ÓËÙ¶ÈµÄ±ä»¯ÂÊ
+	m_emitter->setTangentialAccel(30);
+	m_emitter->setTangentialAccelVar(0);
+
+
+	//ÉèÖÃÁ£×ÓµÄÎ»ÖÃ£¬Î»ÖÃµÄ±ä»¯ÂÊ
+	m_emitter->setPosition(CCPoint(400,500));
+	m_emitter->setPosVar(CCPoint(400,0));
+
+	//ÉèÖÃÁ£×ÓÉùÃ÷£¬ÉúÃüµÄ±ä»¯ÂÊ
+	m_emitter->setLife(4);
+	m_emitter->setLifeVar(2);
+
+
+	//ÉèÖÃÁ£×Ó¿ªÊ¼µÄ×ÔÐý×ªËÙ¶È£¬¿ªÊ¼×ÔÐý×ªËÙ¶ÈµÄ±ä»¯ÂÊ
+	m_emitter->setStartSpin(30);
+	m_emitter->setStartSpinVar(60);
+
+	//ÉèÖÃ½áÊøµÄÊ±ºòµÄ×ÔÐý×ªÒÔ¼°×ÔÐý×ªµÄ±ä»¯ÂÊ
+	m_emitter->setEndSpin(60);
+	m_emitter->setEndSpinVar(60);
+
+	ccColor4F cc;
+	cc.a=1.0f;
+	cc.b=255.0f;
+	cc.g=255.0f;
+	cc.r=255.0f;
+	ccColor4F cc2;
+	cc2.a=0;
+	cc2.b=0;
+	cc2.g=0;
+	cc2.r=0;
+	//ÉèÖÃ¿ªÊ¼µÄÊ±ºòµÄÑÕÉ«ÒÔ¼°ÑÕÉ«µÄ±ä»¯ÂÊ
+	m_emitter->setStartColor(cc);
+	m_emitter->setStartColorVar(cc2);
+
+
+
+	//ÉèÖÃ½áÊøµÄÊ±ºòµÄÑÕÉ«ÒÔ¼°ÑÕÉ«µÄ±ä»¯ÂÊ
+	m_emitter->setEndColor(cc);
+	m_emitter->setEndColorVar(cc2);
+
+	//ÉèÖÃ¿ªÊ¼Ê±ºòÁ£×ÓµÄ´óÐ¡£¬ÒÔ¼°´óÐ¡µÄ±ä»¯ÂÊ
+	m_emitter->setStartSize(30);
+	m_emitter->setStartSizeVar(0);
+
+
+	//ÉèÖÃÁ£×Ó½áÊøµÄÊ±ºòµÄ´óÐ¡£¬ÒÔ¼°´óÐ¡µÄ±ä»¯ÂÊ
+	m_emitter->setEndSize(20.0f);
+	m_emitter->setEndSizeVar(0);
+
+	//ÉèÖÃÃ¿ÃëÖÓ²úÉúÁ£×ÓµÄÊýÄ¿
+	m_emitter->setEmissionRate(100);
+
+	*/
+
+	this->addChild(m_emitter);
+}
\ No newline at end of file
diff --git a/Classes/CombatAnimation.h b/Classes/CombatAnimation.h
new file mode 100644
index 0000000..a48edbe
--- /dev/null
+++ b/Classes/CombatAnimation.h
@@ -0,0 +1,14 @@
+#ifndef __COMBAT_ANIMATION_H__
+#define __COMBAT_ANIMATION_H__
+#include "cocos2d.h"
+#include "cocos-ext.h"
+using namespace cocos2d;
+USING_NS_CC_EXT; 
+class CombatAnimation:public CCNode
+{
+public:
+	CREATE_FUNC(CombatAnimation);
+public:
+	void fireParticle(int direction);
+};
+#endif 
\ No newline at end of file
diff --git a/Classes/CombatScene.cpp b/Classes/CombatScene.cpp
index 0af66d0..b4d3380 100644
--- a/Classes/CombatScene.cpp
+++ b/Classes/CombatScene.cpp
@@ -1,149 +1,345 @@
-#include "AppMacros.h"//$
-#include "CombatScene.h"
-USING_NS_CC;
+ï»¿#include "CombatScene.h"
 
-//update:2014-10-4 19:37:38
+USING_NS_CC;
 
-CCScene* Combat::scene() {
-	CCScene *scene = CCScene::create();
-	Combat *layer = Combat::create();
-	scene->addChild(layer);
-	// return the scene
-	return scene;
+CCScene* Combat::scene()
+{
+    // 'scene' is an autorelease object
+    CCScene *scene = CCScene::create();
+    // 'layer' is an autorelease object
+    Combat *layer = Combat::create();
+    // add layer as a child to scene
+    scene->addChild(layer);
+    // return the scene
+    return scene;
 }
 
-bool Combat::init() {
+// on "init" you need to initialize your instance
+bool Combat::init()
+{
+    //////////////////////////////
+    // 1. super init first
+    if ( !CCLayer::init() )
+    {
+        return false;
+    }
+	//
+    isPlayingAnimation = false;
 
-	if (!CCLayer::init()) {
-		return false;
-	}
+    CCSize visibleSize = CCDirector::sharedDirector()->getVisibleSize();
+    CCPoint origin = CCDirector::sharedDirector()->getVisibleOrigin();
+	//è§’è‰²åˆ›å»º
+	cplayer = CPlayer::create();
+	cplayer->setPlayer();
+	this->addChild(cplayer);
+	monster = Monster::create();
+	monsterType = 0;//ä¸´æ—¶
+	monster->setMonster(monsterType);
+	
 
-	//²»ÒªÎÊÎÒ´ÓÄÄÀïÀ´
-	cc_timeval psv;
-	CCTime::gettimeofdayCocos2d(&psv,NULL);
-	unsigned long int rand_seed = psv.tv_sec*1000+psv.tv_usec/1000;
-	srand(rand_seed);
+	this->addChild(monster);
+	//è¡€æ¡åˆ›å»º
+	playerblood = Blood::create();
+	playerblood->setBloodSlider();
+	playerblood->setSliderPosition(ccp(150,visibleSize.height-50));
+	playerblood->setTotalBlood(cplayer->healthPoint);
+	playerblood->setCurrentBlood(cplayer->currentHp);	
+	monsterblood = Blood::create();
+	monsterblood->setBloodSlider();
+	monsterblood->setSliderPosition(ccp(visibleSize.width-150,visibleSize.height-50));
+	monsterblood->setTotalBlood(monster->healthPoint);
+	monsterblood->setCurrentBlood(monster->currentHp);
+	this->addChild(playerblood);
+	this->addChild(monsterblood);
 
-	initSprite();
-	initLabel();
-	show();
-	return true;
-}
+	//ç­‰çº§ä¸Žå½“å‰è¡€é‡label
+	/*ç­‰çº§*/
+	char level[10],blood[10];
+	sprintf(level,"Lv:%d",cplayer->level);
+	plevelLabel = CCLabelTTF::create(level, "Heiti SC",20);
+	plevelLabel->setPosition(ccp(60,visibleSize.height-20));
+	this->addChild(plevelLabel,2);
+	sprintf(level,"Lv:%d",monster->level);
+	mlevelLabel = CCLabelTTF::create(level, "Heiti SC",20);
+	mlevelLabel->setPosition(ccp(visibleSize.width-60,visibleSize.height-20));
+	this->addChild(mlevelLabel,2);
+	/*è¡€é‡*/
+	sprintf(blood,"Hp:%d",cplayer->currentHp);
+	pbloodLabel = CCLabelTTF::create(blood, "Heiti SC",20);
+	pbloodLabel->setPosition(ccp(240,visibleSize.height-20));
+	this->addChild(pbloodLabel,2);
+	sprintf(blood,"Hp:%d",monster->currentHp);
+	mbloodLabel = CCLabelTTF::create(blood, "Heiti SC",20);
+	mbloodLabel->setPosition(ccp(visibleSize.width-240,visibleSize.height-20));
+	this->addChild(mbloodLabel,2);
 
 
-void Combat::initSprite(){
-	background = CCSprite::create(COMBAT_IMG_PATH);//$
-	background->setPosition(ccp(background->getContentSize().width/2, background->getContentSize().height/2));
-	background->setTag(BACKGROUND);
-	addChild(background, 0);
 
-	player = Player1::create();
-	player->setPosition(ccp(-(player->getChildByTag(IMGSP)->getContentSize().width+150), 
-	player->getChildByTag(IMGSP)->getContentSize().height));
-	addChild(player);
+	//æŒ‰é’®åˆ›å»º
+	playerbutton = AbilityButton::create();
+	monsterbutton = AbilityButton::create();
+	playerbutton->CreateButton();
+	playerbutton->setButtonPosition(ccp(50,50));
+	playerbutton->updateDamage(cplayer->level);
+	monsterbutton->CreateButton();
+	monsterbutton->setButtonPosition(ccp(420,50));
+	monsterbutton->LockButtonTouch();
+	monsterbutton->updateDamage(monster->level);
+	this->addChild(playerbutton);
+	this->addChild(monsterbutton);
 
-	enemy = Enemy::create();
-	enemy->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width - enemy->getChildByTag(IMGSP)->getContentSize().width-150,
-		CCDirector::sharedDirector()->getVisibleSize().height -enemy->getChildByTag(IMGSP)->getContentSize().height));
-	addChild(enemy);	
+	//æ¸¸æˆç»“æŸLabel
+	winLabel = CCLabelTTF::create("YOU WIN!", "Heiti SC", 80);
+	loseLabel = CCLabelTTF::create("YOU LOSE", "Heiti SC", 80);
+	winLabel->setPosition(ccp(visibleSize.width/2-20,visibleSize.height/2+20));
+	loseLabel->setPosition(ccp(visibleSize.width/2-20,visibleSize.height/2+20));
+	winLabel->setVisible(false);
+	loseLabel->setVisible(false);
+	this->addChild(winLabel);
+	this->addChild(loseLabel);
+
+	//scheduleç›‘å¬ï¼Œæ¯å¸§åˆ·æ–°ä¸€æ¬¡
+	this->scheduleUpdate();
+
+	//è®¢é˜…æ’­æ”¾åŠ¨ç”»çš„æ¶ˆæ¯
+	CCNotificationCenter::sharedNotificationCenter()->addObserver(this,callfuncO_selector(Combat::playAnimation),"animation",NULL);
+	//è®¢é˜…æ¸¸æˆç»“æŸ
+	CCNotificationCenter::sharedNotificationCenter()->addObserver(this,callfuncO_selector(Combat::gameOver),"gameover",NULL);
 
-	CombatCtrl* menu = CombatCtrl::create();
-	menu->setPointers(player,enemy,background);
-	addChild(menu);
-}
 
-//@labelÏÔÊ¾
-void Combat::initLabel(){
-	CCNotificationCenter::sharedNotificationCenter()->addObserver(this,callfuncO_selector(Combat::ScaleBlood),"gethurt",NULL);
-	
-	//ÏÔÊ¾×Ô¼ºÓëµÐÈËµÄÑªÌõÍ¼Æ¬
-	pBlood = CCSprite::create(BLOOD_IMG_PATH);//$
-	pBlood->setPosition(ccp(1047, 250));//138
-	pBlood->setAnchorPoint(ccp(1, 1));pBlood->setTag(12);
-	pBlood->setScaleX(1);
-	addChild(pBlood,1);
-	eBlood = CCSprite::create(BLOOD_IMG_PATH);//$
-	eBlood->setPosition(ccp(478, 558));
-	eBlood->setAnchorPoint(ccp(1, 1));eBlood->setTag(22);
-	eBlood->setScale(1);
-	addChild(eBlood,1);
-
-	//ÏÔÊ¾Ë«·½ÑªÁ¿Öµ
-	CCPoint pBloodPos = pBlood->getPosition();CCPoint eBloodPos = eBlood->getPosition();
-	char playerHp[10];char enemyHp[10];
-	sprintf(playerHp, "%d/%d",player->Hp,player->Hp);
-	pBloodLabel = CCLabelTTF::create("" ,"Heiti SC", 30);pBloodLabel->setString(playerHp);pBloodLabel->setPosition(ccp(pBloodPos.x-10,pBloodPos.y-22));pBloodLabel->setAnchorPoint(ccp(1, 0.5));pBloodLabel->setTag(13);
-	addChild(pBloodLabel,2);
-	sprintf(enemyHp, "%d/%d",enemy->Hp,enemy->Hp);
-	eBloodLabel = CCLabelTTF::create("", "Heiti SC", 30);eBloodLabel->setString(enemyHp);eBloodLabel->setPosition(ccp(eBloodPos.x-250,eBloodPos.y-22));eBloodLabel->setAnchorPoint(ccp(1, 0.5));eBloodLabel->setTag(23);
-	addChild(eBloodLabel,2);
-
-	//ÏÔÊ¾Ë«·½µÈ¼¶
-	char level[10];
-	sprintf(level,"Lv.%d",player->level);
-	CCLabelTTF *plevel = CCLabelTTF::create("","Heiti SC",30);plevel->setFontFillColor(ccBLACK);plevel->setString(level);plevel->setPosition(ccp(pBloodPos.x-13,pBloodPos.y+32));plevel->setAnchorPoint(ccp(1,1));plevel->setTag(33);
-	addChild(plevel,2);
-	sprintf(level,"Lv.%d",enemy->level);
-	CCLabelTTF *elevel = CCLabelTTF::create("","Heiti SC",30);plevel->setFontFillColor(ccBLACK);elevel->setString(level);elevel->setPosition(ccp(eBloodPos.x-320,eBloodPos.y+32));elevel->setAnchorPoint(ccp(1,1));elevel->setTag(33);
-	addChild(elevel,2);
-
-	//ÏÔÊ¾Ãû×Ö
-	const char* pname;
-	const char* ename;
-	CCLabelTTF *pName = CCLabelTTF::create("","Heiti SC",30);
-	pname = player->name.getCString();
-	pName->setString(pname);
-	pName->setFontFillColor(ccBLACK);pName->setPosition(ccp(pBloodPos.x-300,pBloodPos.y+32));pName->setAnchorPoint(ccp(1,1));pName->setTag(33);
-	addChild(pName,2);
-	CCLabelTTF *eName = CCLabelTTF::create("","Heiti SC",30);
-	ename = enemy->name.getCString();
-	eName->setString(ename);
-	eName->setFontFillColor(ccBLACK);eName->setString(enemy->name.getCString());eName->setPosition(ccp(eBloodPos.x-10,eBloodPos.y+35));eName->setAnchorPoint(ccp(1,1));eName->setTag(33);
-	addChild(eName,2);
-
-	//¾­ÑéÖµ
 
+    return true;
 }
 
-void Combat::show(){
 
-	CCActionInterval* moveTo1 = CCMoveTo::create(1.5,ccp((player->getChildByTag(IMGSP)->getContentSize().width+150), 
-		player->getChildByTag(IMGSP)->getContentSize().height));
-	player->runAction(moveTo1);
 
-	CCAction* enemyUp = Animation::getAction(SWAY,enemy->getChildByTag(IMGSP)->getContentSize());
-	CCSequence* seq = CCSequence::create(CCDelayTime::create(1.5),enemyUp,NULL);
-	enemy->runAction(seq);
+void Combat::update(float delta)
+{
+	if (playerbutton->isTouch==true&&isPlayingAnimation==false)
+	{
+		//é”å®šplayerbuttonè§¦æ‘¸
+		playerbutton->LockButtonTouch();
+		//æ€ªç‰©é€‰æ‹©button
+		monsterButtonTag = monster->chooseButton();
+		//åˆ¤æ–­å±žæ€§èƒœè´Ÿ
+		winnerNum = checkButtonTag(playerbutton->tag,monsterButtonTag);
+		CCLOG("win:%d",winnerNum);
+		//ä¼¤å®³è®¡ç®—
+		damage = damageCompute(winnerNum);
+		CCLOG("damage:%d",damage);
+		//æ’­æ”¾æˆ˜æ–—åŠ¨ç”»
+		//postæ¶ˆæ¯
+		CCNotificationCenter::sharedNotificationCenter()->postNotification("animation",NULL);
+		//æ›´æ–°è¡€æ¡
+		updateBlood(winnerNum,damage);
+		playerbutton->isTouch=false;
+		//åˆ¤æ–­æ˜¯å¦ç»“æŸ
+		checkGameOver();
+		
+	}
+	
 }
 
+//åˆ¤æ–­åŒæ–¹é€‰æ‹©å±žæ€§çš„èƒœè´Ÿ
+int Combat::checkButtonTag(int playerTag,int monsterTag)
+{
+	CCLOG("tag:%d  tag:%d",playerTag,monsterTag);
+	//å¹³å±€
+	if (playerTag==monsterTag)
+	{
+		if(playerbutton->getDamageByTag(playerTag)>=monsterbutton->getDamageByTag(monsterTag))
+			return playerWin;
+		else
+			return monsterWin;
+	}
+	else if ((playerTag==0&&monsterTag==2)||(playerTag==1&&monsterTag==0)||(playerTag==2&&monsterTag==1))
+	{
+		return playerWin;
+	}
+	else
+	{
+		return monsterWin;
+	}
+}
 
+//ä¼¤å®³è®¡ç®—
+int Combat::damageCompute(int winnerNum)
+{
+	int damage,pdamage,mdamage;
+	//å¹³å±€æƒ…å†µä¼¤å®³ä¸ºåŒæ–¹å·®å€¼
+	if (playerbutton->tag==monsterButtonTag)
+	{
+		pdamage = playerbutton->getDamageByTag(playerbutton->tag);
+		mdamage = monsterbutton->getDamageByTag(monsterButtonTag);
+		damage = abs(pdamage-mdamage);
+	}
+	//éžå¹³å±€æƒ…å†µä¼¤å®³å€¼
+	else
+	{
+		if (winnerNum==playerWin)
+		{
+			damage = playerbutton->getDamageByTag(playerbutton->tag);
+		}
+		else if (winnerNum==monsterWin)
+		{
+			damage = monsterbutton->getDamageByTag(monsterButtonTag);
+		}
+	}
+	return damage;
+}
 
+//åˆ·æ–°è¡€æ¡
+void Combat::updateBlood(int winnerNum,int damage)
+{
+	if (winnerNum==playerWin)
+	{
+		monster->currentHp-=damage; 
+		if(monster->currentHp<=0)
+			monster->currentHp=0;
+	}
+	else
+	{
+		cplayer->currentHp-=damage;
+		if(cplayer->currentHp<=0)
+			cplayer->currentHp=0;
+	}
 
+	playerblood->setCurrentBlood(cplayer->currentHp);
+	monsterblood->setCurrentBlood(monster->currentHp);
+	char blood[10];
+	sprintf(blood,"Hp:%d",cplayer->currentHp);
+	pbloodLabel->setString(blood);
+	sprintf(blood,"Hp:%d",monster->currentHp);
+	mbloodLabel->setString(blood);
+}
+//åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ
+void Combat::checkGameOver()
+{
+	if (cplayer->currentHp<=0)
+	{
+			gameWinner = 1;
+		CCNotificationCenter::sharedNotificationCenter()->postNotification("gameover",NULL);
+	
+		CCLOG("monster win!");
+	}
+	else if (monster->currentHp<=0)
+	{
+		gameWinner = 0;
+		CCNotificationCenter::sharedNotificationCenter()->postNotification("gameover",NULL);
+		
+		CCLOG("player win!");
+		cplayer->exp++;
+		sGlobal->playerState->exp = cplayer->exp;
+	}
+	else
+	{
+		//åˆ·æ–°ä¸€æ¬¡button
+		playerbutton->updateDamage(cplayer->level);
+		monsterbutton->updateDamage(monster->level);
+	}
+		
+}
 
 
-void Combat::ScaleBlood(CCObject* character){
-	Character* p = (Character*)character;
+void Combat::playAnimation(CCObject* psender)
+{
+	int pZorder,mZorder;
+	isPlayingAnimation=true;
+	animationDone = false;
+	CCBlink* blk = CCBlink::create(0.5,3);
+	CCSequence* pblink = CCSequence::create(CCDelayTime::create(1.2),blk,NULL);
+	playerAttack = Particles::create();
+	monsterAttack = Particles::create();
+	if (playerbutton->tag==0)
+	{
+		playerAttack->setFireParticle();
+		playerAttack->playerAttack();
+	}
+	if (playerbutton->tag==1)
+	{
+		playerAttack->setWaterParticle();
+		playerAttack->playerAttack();
+	}
+	if (playerbutton->tag==2)
+	{
+		playerAttack->setWoodParticle();
+		playerAttack->playerAttack();
+	}
+	//monster
+	if (monsterButtonTag==0)
+	{
+		monsterAttack->setFireParticle();
+		monsterAttack->monsterAttack();
+	}
+	if (monsterButtonTag==1)
+	{
+		monsterAttack->setWaterParticle();
+		monsterAttack->monsterAttack();
+	}
+	if (monsterButtonTag==2)
+	{
+		monsterAttack->setWoodParticle();
+		monsterAttack->monsterAttack();
+	}
+	
+	if (winnerNum==1)
+	{//monster win
+		pZorder=1;
+		mZorder=2;
+		playerAttack->setParticleLife(0.5);
+		cplayer->runAction(pblink);
 
-	int ht = p->Hp-p->remainHp;
+	}
+	else
+	{
+		pZorder=2;
+		mZorder=1;
+		monsterAttack->setParticleLife(0.5);
+		monster->runAction(pblink);
+	}
 
-	float st =  (float)p->remainHp/(float)p->Hp;
-	
-	CCScaleTo *Scale =CCScaleTo::create(0.5,st,1.0f);
 
+	CCSequence* seq = CCSequence::create(CCDelayTime::create(1.5),CCCallFunc::create(this,callfunc_selector(Combat::setSignal)),NULL);
 
-	char blood[10];
-	if (p->ishero)
+	playerbutton->runAction(seq);
+ 
+	addChild(playerAttack,pZorder);
+	addChild(monsterAttack,mZorder);
+}
+
+void Combat::setSignal()
+{
+	isPlayingAnimation=false;
+	//æ¢å¤æŒ‰é’®å¯è§¦æ‘¸çŠ¶æ€
+	playerbutton->UnlockButtonTouch();
+}
+
+void Combat::gameOver(CCObject* psender)
+{
+	if (gameWinner==0)
 	{
-		Player1* player0=(Player1*)p;
-		sprintf(blood, "%d/%d", player0->remainHp,player0->Hp);
-		pBloodLabel->setString(blood);
-		pBlood->runAction(Scale);
+		winLabel->setVisible(true);
+
 	}
 	else
 	{
-		Enemy* enemy0=(Enemy*) p;
-		sprintf(blood, "%d/%d", enemy0->remainHp,enemy0->Hp);
-		eBloodLabel->setString(blood);
-		eBlood->runAction(Scale);
+		loseLabel->setVisible(true);
 	}
+	CCSequence* seq = CCSequence::create(CCDelayTime::create(3.5),CCCallFunc::create(this,callfunc_selector(Combat::popCombat)),NULL);
+	playerbutton->runAction(seq);
 }
+
+void Combat::popCombat()
+{
+	//å­˜æ¡£
+
+
+	//ä¿å­˜ï¼šç»éªŒå€¼exp
+
+
+	//ç§»é™¤è§‚å¯Ÿè€…
+	CCNotificationCenter::sharedNotificationCenter()->removeAllObservers(this);
+	//popScene
+	CCEGLView::sharedOpenGLView()->setDesignResolutionSize(672,448, kResolutionExactFit);
+	CCDirector::sharedDirector()->popScene();
+}
\ No newline at end of file
diff --git a/Classes/CombatScene.cpp~ b/Classes/CombatScene.cpp~
index ea695b0..4e99c93 100644
--- a/Classes/CombatScene.cpp~
+++ b/Classes/CombatScene.cpp~
@@ -56,7 +56,7 @@ void Combat::showPlayer(){
 
 void Combat::showEnemy(){
 	
-	CCAction* enemyUp = Animation::getAction(SWAY,enemy->getChildByTag(IMGSP)->getContentSize());
+	CCAction* enemyUp = AnimLib::getAction(SWAY,enemy->getChildByTag(IMGSP)->getContentSize());
 	CCSequence* seq = CCSequence::create(CCDelayTime::create(1.5),enemyUp,NULL);
 	enemy->runAction(seq);
 }
diff --git a/Classes/CombatScene.h b/Classes/CombatScene.h
index 5145303..8ce4671 100644
--- a/Classes/CombatScene.h
+++ b/Classes/CombatScene.h
@@ -1,43 +1,69 @@
-//
-//  CombatScene.h
-//  è¡€è‰²æ˜Žè¿œæ¹–
-//
-//  Created by Ring King on 14-4-22.
-//
-//
-
-#ifndef _________CombatScene__
-#define _________CombatScene__
+ï»¿#ifndef __COMBAT_SCENE_H__
+#define __COMBAT_SCENE_H__
 
 #include "cocos2d.h"
-#include "Player1.h"
-#include "Enemy.h"
-#include "CombatCtrl .h"
-#include "Animation.h"
-//update:2014-10-4 19:37:23
+#include "Blood.h"
+#include "CPlayer.h"
+#include "Monster.h"
+#include "AbilityButton.h"
+#include "Particles.h"
+
+using namespace cocos2d;
+
+typedef enum{
+	playerWin,
+	monsterWin,
+	drawTie
+}chechResult;
+
 
 class Combat : public cocos2d::CCLayer
 {
 public:
+    // Here's a difference. Method 'init' in cocos2d-x returns bool, instead of returning 'id' in cocos2d-iphone
+    virtual bool init();  
+    // there's no 'id' in cpp, so we recommend returning the class instance pointer
     static cocos2d::CCScene* scene();
+    // a selector callback
+    void menuCloseCallback(CCObject* pSender);
+    // implement the "static node()" method manually
     CREATE_FUNC(Combat);
-	virtual bool init();
-   
-	void initSprite();
-    void initLabel();
-	void show();
-
-	void ScaleBlood(CCObject* character);
+	virtual void update(float delta);
+	int checkButtonTag(int playerTag,int monsterTag);
+	int damageCompute(int winner);
+	//åˆ·æ–°è¡€æ¡
+	void updateBlood(int winnerNum,int damage);
+	void checkGameOver();
+	void playAnimation(CCObject* psender);
+	void setSignal();
+	void gameOver(CCObject* psender);
+	void popCombat();
+	//
+	int monsterType;
 private:
-    Player1* player;
-	Enemy* enemy;
-	CCSprite *background;
-	CCSprite *pBlood;
-	CCSprite *eBlood;
-	CCLabelTTF *pBloodLabel;
-	CCLabelTTF *eBloodLabel;
-};
+	CPlayer* cplayer;
+	Monster* monster;
+	Blood* playerblood;
+	Blood* monsterblood;
+	AbilityButton* playerbutton;
+	AbilityButton* monsterbutton;
+	Particles* playerAttack;
+	Particles* monsterAttack;
+	CCLabelTTF* winLabel;
+	CCLabelTTF* loseLabel;
+	CCLabelTTF* pbloodLabel;
+	CCLabelTTF* mbloodLabel;
+	CCLabelTTF* plevelLabel;
+	CCLabelTTF* mlevelLabel;
 
-#endif /* defined(_________CombatScene__) */
+	int monsterButtonTag;
+	int damage;
+	int winnerNum;
+	int gameWinner;
+	bool isPlayingAnimation;
+	bool animationDone;
 
 
+};
+
+#endif // __Combat_SCENE_H__
diff --git a/Classes/ControlPanel.cpp b/Classes/ControlPanel.cpp
index f3b2f27..07d8791 100644
--- a/Classes/ControlPanel.cpp
+++ b/Classes/ControlPanel.cpp
@@ -67,7 +67,7 @@ void ControlPanel::initControllerListeners()
 	rwindow->setPosition(ccp(CCDirector::sharedDirector()->getWinSize().width/2,
 		CCDirector::sharedDirector()->getWinSize().height/2));
 	rGlobal->rwindow=rwindow;
-	this->addChild(rwindow,11);
+	this->addChild(rwindow,WIN_ON_PANEL_ZOR);
 
 	//bigwindow=BigWindow::create();
 	//this->setTag(BIGWINDOW);this->addChild(bigwindow,11);
@@ -75,7 +75,7 @@ void ControlPanel::initControllerListeners()
 
 	diawindow=DiaWindow::create();
 	rGlobal->diawindow=diawindow;
-	this->setTag(DIAWINDOW);this->addChild(diawindow,11);
+	this->setTag(DIAWINDOW);this->addChild(diawindow,WIN_ON_PANEL_ZOR);
 }
 
 void ControlPanel::initControllers()
@@ -108,6 +108,9 @@ void ControlPanel::initNightBg()
 	CCSprite* nightBg = CCSprite::create(NIGHTBG_IMG_PATH);
 	rGlobal->nightBg = nightBg;
 	nightBg->setPosition(ccp(nightBg->getContentSize().width / 2, nightBg->getContentSize().height / 2));
-	nightBg->setOpacity(150);
 	this->addChild(nightBg);
+
+	int hour = TimeUtil::getHour();
+	if (hour>=18 || hour<=7) nightBg->setOpacity(150);
+	else nightBg->setOpacity(0);
 }
diff --git a/Classes/ControlPanel.h b/Classes/ControlPanel.h
index cf081bc..6028291 100644
--- a/Classes/ControlPanel.h
+++ b/Classes/ControlPanel.h
@@ -7,6 +7,7 @@
 #include "ButtonA.h"
 #include "TouchScreen.h"
 #include "Menu.h"
+#include "TimeUtil.h"
 using namespace cocos2d;
 
 //update£º2014-9-26 01:33:57
diff --git a/Classes/CrossMapEvent.cpp b/Classes/CrossMapEvent.cpp
new file mode 100644
index 0000000..a476214
--- /dev/null
+++ b/Classes/CrossMapEvent.cpp
@@ -0,0 +1,36 @@
+#include "CrossMapEvent.h"
+#include "Hero.h"
+
+void CrossMapEvent::happen()
+{
+	//choose map 
+	CCString* path; CCPoint heroTilePos=rGlobal->getHeroTilePos();
+	int mapNo=sGlobal->mapState->mapNo; CCPoint delt=ccp(1,0);
+
+	if(mapNo==MAP11) path=CCString::create(MAP11_PATH), delt=ccp(1,0);
+	else path=CCString::create(MAP12_PATH), delt=ccp(-1,0);
+
+	//re-create hero
+	if(HERO_COVER_MODE)
+	{
+		rGlobal->hero=Hero::create();
+		//rGlobal->hero->gotFocusT();
+		rGlobal->hero->setFaceDirection(rGlobal->hero->dir);
+	}
+
+	//change map
+	Map* map = (Map*)rGlobal->map;
+	map->removeAllChildrenWithCleanup(true);
+	map=Map::create(path->getCString());
+	map->crossMap(heroTilePos,mapNo);
+	rGlobal->hero->addChild(map);
+	rGlobal->map=map;
+
+	//re-create rGlobal->shadow
+	if(rGlobal->shadow==NULL) return;
+	rGlobal->shadow = ShadowingMan::create();
+	CCPoint heroPos = heroTilePos + delt;
+	CCPoint tPos = map->positionFromTileCoord(heroPos);
+	rGlobal->shadow->setPosition(tPos);
+	map->addChild(rGlobal->shadow,5);
+}
diff --git a/Classes/CrossMapEvent.h b/Classes/CrossMapEvent.h
new file mode 100644
index 0000000..1dd4148
--- /dev/null
+++ b/Classes/CrossMapEvent.h
@@ -0,0 +1,12 @@
+#ifndef _CROSS_MAP_EVENT_H_
+#define _CROSS_MAP_EVENT_H_
+#include "Event.h"
+
+//re-init resources after map crossing
+class CrossMapEvent //: public Event
+{
+public:
+    static void happen();
+};
+#endif
+
diff --git a/Classes/EventLoader.cpp b/Classes/EventLoader.cpp
index 85d197a..095ef3a 100644
--- a/Classes/EventLoader.cpp
+++ b/Classes/EventLoader.cpp
@@ -2,6 +2,8 @@
 #include "TalkManEvent.h"
 #include "GetSuPEvent.h"
 #include "DiaEvent.h"
+#include "GetShdwEvent.h"
+#include "ReloadEvent.h"
 
 CCArray* EventLoader::start(const char* sFilePath)
 {
@@ -24,6 +26,10 @@ CCArray* EventLoader::start(const char* sFilePath)
 				event=GetSuPEvent::create(); break;
 			case DIALOG_EVT:
 				event=DiaEvent::create(); break;
+			case SHADOW_EVT:
+				event=GetShdwEvent::create(); break;
+			case RELOAD_EVT:
+				event=ReloadEvent::create(); break;
 				/*case ITEM_EVT:
 				  event=ItemEvent::create(); break;
 				  case COMBAT_EVT:
@@ -96,6 +102,5 @@ CCArray* EventLoader::start(const char* sFilePath)
 		}
 		eventSet->addObject(event);
 	}
-	eventSet->retain();
 	return eventSet;
 }
diff --git a/Classes/EventManager.cpp b/Classes/EventManager.cpp
index 67124ec..82c79a6 100644
--- a/Classes/EventManager.cpp
+++ b/Classes/EventManager.cpp
@@ -1,9 +1,12 @@
 #include "AppMacros.h"
 #include "EventManager.h"
 
-void EventManager::load(int sTime)
+void EventManager::load(int fnmapNo, int weekday)
 {
-	loadAllEvents(sTime);
+	events=CCArray::create();
+	events->retain();
+	loadAllEvents(fnmapNo*MAP_SCALER+weekday);
+	loadAllEvents(fnmapNo*MAP_SCALER+sGlobal->mapState->sTime);
 	loadEmap();
 }
 
@@ -46,7 +49,7 @@ ControllerListener* EventManager::happen(CCPoint coord, int ent)
 
 		curPtr=findEventById(event->next);
 	}
-	while(curPtr==NULL);
+	while(curPtr!=NULL);
 
 	return subject;
 }
@@ -69,7 +72,6 @@ void EventManager::release()
 
 EventManager::~EventManager()
 {
-	events->release();
 	release();
 }
 
@@ -106,10 +108,10 @@ ControllerListener* EventManager::listener(int type)
     return NULL;
 }
 
-void EventManager::loadAllEvents(int sTime)
+void EventManager::loadAllEvents(int fileCode)
 {
-	CCString* str=CCString::createWithFormat(EVENT_CSV_PATH,sTime);
-	events=EventLoader::start(str->getCString());
+	CCString* str=CCString::createWithFormat(EVENT_CSV_PATH,fileCode);
+	events->addObjectsFromArray(EventLoader::start(str->getCString())); 
 }
 
 void EventManager::loadEmap()
@@ -128,7 +130,7 @@ void EventManager::loadEmap()
 int EventManager::isInstant(Event* event)
 {
 	const int nn=2;
-	const int instant[nn]={GET_SUP_EVT};
+	const int instant[nn]={GET_SUP_EVT,SHADOW_EVT};
 	for(int i=0;i<nn;i++)
 		if(event->id==instant[i])
 			return TRUE;
diff --git a/Classes/EventManager.h b/Classes/EventManager.h
index 07777d3..bd4279a 100644
--- a/Classes/EventManager.h
+++ b/Classes/EventManager.h
@@ -15,7 +15,7 @@ using namespace cocos2d;
 class EventManager
 {
 public:
-    void load(int sTime);
+    void load(int fnmapNo, int weekday);
     ControllerListener* happen(CCPoint coord, int ent);//entrance through hero or buttonA
 	void next();
 	int isInstant(Event* event);
@@ -29,7 +29,7 @@ public:
 private:
     Event* findEventById(int id);
     ControllerListener* listener(int type);
-    void loadAllEvents(int sTime);
+    void loadAllEvents(int fileCode);
     void loadEmap();
     void markHappened(Event* event);
 };
diff --git a/Classes/GetShdwEvent.cpp b/Classes/GetShdwEvent.cpp
new file mode 100644
index 0000000..96c6496
--- /dev/null
+++ b/Classes/GetShdwEvent.cpp
@@ -0,0 +1,30 @@
+#include "GlobalState.h"
+#include "GetShdwEvent.h"
+#include "ShadowingMan.h"
+#include "Map.h"
+
+void GetShdwEvent::happen() 
+{
+	//extract starting pos
+	CCInteger* intgx=(CCInteger*)args->lastObject();
+	int dir=-1;
+	if(intgx!=NULL) dir=intgx->getValue();
+	CCPoint pos=ccp(1,0);
+	switch(dir)
+	{
+		case Down: pos=ccp(0,1); break;
+		case Left: pos=ccp(-1,0); break;
+		case Right: pos=ccp(1,0); break;
+		case Up: pos=ccp(0,-1); break;
+		default: CCLog("Unexpected Shadow pos. Using default.");
+	}
+
+	Map* map = (Map*)rGlobal->map;
+	rGlobal->shadow = ShadowingMan::create(); 
+	CCPoint  heroTilePos=map->tileCoordFromPosition(
+			rGlobal->hero->getPosition() - map->getPosition() );
+	CCPoint heroPos = heroTilePos + pos;
+	CCPoint tPos = map->positionFromTileCoord(heroPos);
+	rGlobal->shadow->setPosition(tPos);
+	rGlobal->map->addChild(rGlobal->shadow,5);
+}
diff --git a/Classes/GetShdwEvent.h b/Classes/GetShdwEvent.h
new file mode 100644
index 0000000..44f31c9
--- /dev/null
+++ b/Classes/GetShdwEvent.h
@@ -0,0 +1,13 @@
+#ifndef _GET_SHADOW_EVENT_H_
+#define _GET_SHADOW_EVENT_H_
+#include "Event.h"
+
+//Hero gets Shadowing Boyfriend instantly after event
+class GetShdwEvent: public Event
+{
+public:
+    CREATE_FUNC(GetShdwEvent);
+public:
+    void happen();
+};
+#endif
diff --git a/Classes/GlobalPath.h b/Classes/GlobalPath.h
index a84ede9..d3556e4 100644
--- a/Classes/GlobalPath.h
+++ b/Classes/GlobalPath.h
@@ -35,9 +35,13 @@
 #define NAME_PATH  "txt/names.txt"
 #define SCRIPT_PATH "txt/Script0"
 #define SCRIPT_PATH_LEN 10
+#define FINAL_SCRIPT_PATH "txt/Fin1"
+#define FINAL_SCRIPT_PATH_LEN 7
 #define CLOSEN_IMG_PATH "img/story/CloseNormal.png"
 #define CLOSES_IMG_PATH "img/story/CloseSelected.png"
-#define BGNAME_IMG_PATH "img/story/bg_x00.jpg"
+#define CONFIRM_BACKGROUND_IMG_PATH "img/story/ConfirmBackground.png"
+#define CONFIRM_BUTTOM_IMG_PATH "img/story/ConfirmButton.png"
+#define BGNAME_IMG_PATH "img/story/bg_%s.jpg"
 #define BGNAME_PATH_LEN 13
 #define DUIHUAKUANG_IMG_PATH "img/story/Duihuakuang.png"
 #define PLIST_IMG_PATH "img/story/vdrawing.plist"
@@ -46,7 +50,8 @@
 #define STAFFBG_IMG_PATH "img/story/staff_bg.png"
 #define STAFF_IMG_PATH "img/story/staff.png"
 #define BLACK_IMG_PATH "img/story/black.png"
-#define LEAFLET_IMG_PATH "img/story/leafletsclose.png"
+#define LEAFLET_IMG_PATH "img/story/leaflet.png"
+#define LEAFLET_CLOSE_IMG_PATH "img/story/leafletsclose.png"
 
 //new combat
 #define PLAYER_IMG_PATH "img/new combat/hero.png"
diff --git a/Classes/GlobalRes.h b/Classes/GlobalRes.h
index d31c247..4d61171 100644
--- a/Classes/GlobalRes.h
+++ b/Classes/GlobalRes.h
@@ -14,6 +14,7 @@ public:
     Window* rwindow;
     DiaWindow* diawindow;
     Backpack* backpack;
+	HumanEntity* shadow;
 };
 //note that when an event wish to walk the hero, do as follow:
 //WalkingMan* walkHero=(WalkingMan*)rGloble->hero;
diff --git a/Classes/GlobalState.cpp b/Classes/GlobalState.cpp
index 4f44622..0171927 100644
--- a/Classes/GlobalState.cpp
+++ b/Classes/GlobalState.cpp
@@ -13,21 +13,27 @@ void GlobalState::load()
     loadSuperPower();
     loadPlayerState();
     loadDoneList();
+	loadPlayerState();
 }
 
 void GlobalState::save()
 {
-   SAVE_INT(POSITIONX_MRCD, mapState->positionX);
-   SAVE_INT(POSITIONY_MRCD, mapState->positionY);
-   SAVE_INT(FACEDIR_MRCD, mapState->faceDir);
-   SAVE_INT(MAPNO_MRCD, mapState->mapNo);
-   SAVE_INT(STORYCNT_MRCD, mapState->storyCnt);
-
-   SAVE_INT(SPEED_SRCD, superPower->speed);
-   SAVE_BOOL(TELEPORT_SRCD, superPower->teleport);
-   SAVE_BOOL(STEALTH_SRCD, superPower->stealth);
-   SAVE_BOOL(SURF_SRCD, superPower->surf);
-   saveDoneList();
+	SAVE_INT(POSITIONX_MRCD, mapState->positionX);
+	SAVE_INT(POSITIONY_MRCD, mapState->positionY);
+	SAVE_INT(FACEDIR_MRCD, mapState->faceDir);
+	SAVE_INT(MAPNO_MRCD, mapState->mapNo);
+	SAVE_INT(STORYCNT_MRCD, mapState->storyCnt);
+	SAVE_BOOL(HAS_SHADOW_MRCD, mapState->hasSh);
+	SAVE_INT(SH_STAND_P_MRCD, mapState->standPos);
+	SAVE_INT(STORY_TIME_MRCD, mapState->sTime);
+
+	SAVE_INT(SPEED_SRCD, superPower->speed);
+	SAVE_BOOL(TELEPORT_SRCD, superPower->teleport);
+	SAVE_BOOL(STEALTH_SRCD, superPower->stealth);
+	SAVE_BOOL(SURF_SRCD, superPower->surf);
+
+	SAVE_INT(EXP_CRCD,playerState->exp);
+	saveDoneList();
 }
 
 void GlobalState::newr()
@@ -37,6 +43,9 @@ void GlobalState::newr()
 	SAVE_INT(FACEDIR_MRCD,FACEDIR_INI);
 	SAVE_INT(MAPNO_MRCD,MAPNO_INI);
 	SAVE_INT(STORYCNT_MRCD,STORYCNT_INI);
+	SAVE_BOOL(HAS_SHADOW_MRCD,HAS_SHADOW_INI);
+	SAVE_INT(SH_STAND_P_MRCD,SH_STAND_P_INI);
+	SAVE_INT(STORY_TIME_MRCD,STORY_TIME_INI);
 
 	SAVE_INT(SPEED_SRCD,SPEED_INI);
 	SAVE_BOOL(TELEPORT_SRCD,TELEPORT_INI);
@@ -60,6 +69,9 @@ void GlobalState::loadMapState()
     mapState->faceDir= LOAD_INT(FACEDIR_MRCD, FACEDIR_INI);
     mapState->mapNo = LOAD_INT(MAPNO_MRCD, MAPNO_INI);
     mapState->storyCnt = LOAD_INT(STORYCNT_MRCD, STORYCNT_INI);
+	mapState->hasSh = LOAD_BOOL(HAS_SHADOW_MRCD, HAS_SHADOW_INI);
+	mapState->standPos= LOAD_INT(SH_STAND_P_MRCD, SH_STAND_P_INI);
+	mapState->sTime= LOAD_INT(STORY_TIME_MRCD, STORY_TIME_INI);
 }
 
 void GlobalState::loadSuperPower()
@@ -85,10 +97,6 @@ void GlobalState::loadDoneList()
 	}
 }
 
-void GlobalState::loadPlayerState()
-{
-
-}
 
 void GlobalState::saveDoneList()
 {
@@ -103,3 +111,12 @@ void GlobalState::saveDoneList()
 		}
 	RcdUtil::saveList(list,DEFUALT_DELIM);
 }
+
+
+
+
+void GlobalState::loadPlayerState()
+{
+	playerState = new PlayerState;
+	playerState->exp = LOAD_INT(EXP_CRCD,EXP_INI);
+}
diff --git a/Classes/GlobalState.h b/Classes/GlobalState.h
index 1f82c2b..c83b313 100644
--- a/Classes/GlobalState.h
+++ b/Classes/GlobalState.h
@@ -5,8 +5,9 @@
 #include "Singleton.hpp"
 #include "MapState.h"
 #include "SuperPower.h"
-#include "CombatUnit.h"
+//#include "CombatUnit.h"
 #include "BagRecord.h"
+#include "PlayerState.h"
 using namespace cocos2d;
 
 //Record of the state of the game in the memory
@@ -17,8 +18,9 @@ class GlobalState: public Singleton<GlobalState>
 public:
     MapState* mapState;
     SuperPower* superPower;
-    CombatUnit* playerState;
+    //CombatUnit* playerState;
     BagRecord* bagRecord;
+	PlayerState* playerState;
     bool doneList[MAX_DONE_LIST];
 public:
     void load();
@@ -31,6 +33,7 @@ private:
     void loadDoneList();
     void loadPlayerState();
 	void saveDoneList();
+	//void savePlayerState();
 };
 #define sGlobal GlobalState::instance()
 #endif
diff --git a/Classes/HelloWorldScene.cpp b/Classes/HelloWorldScene.cpp
index d13db9f..043e98b 100644
--- a/Classes/HelloWorldScene.cpp
+++ b/Classes/HelloWorldScene.cpp
@@ -1,4 +1,5 @@
 #include "HelloWorldScene.h"
+#include "TimeUtil.h"
 USING_NS_CC;
 
 //last: 20140925.2257
@@ -38,14 +39,13 @@ Map* HelloWorld::initMap()
 	Map* map;
 	if(mapNo==MAP11)map=Map::create(MAP11_PATH);//¶ÁÈ¡µØÍ¼ºÅmap11
 	else map=Map::create(MAP12_PATH);//¶ÁÈ¡µØÍ¼ºÅmap12	
-	//@eManager
 	sGlobalRes::instance()->map=map;
-	eManager->load(0);//@rGlobal->mapState->sTime
+	
+	//@eManager
+	eManager->load(mapNo-MAP10, TimeUtil::getWeekDay());
 	map->initNPC();
 	map->setGameStartPos();
 
-	
-
 	CCLayer* mapLayer=CCLayer::create();
 	map->setTag(MAP);
 	mapLayer->addChild(map);
@@ -59,16 +59,21 @@ void HelloWorld::initControlPanel(Map* map)
 	ControlPanel* panel=ControlPanel::create(map);
 	//rGlobal->panel=panel;
 	panel->hero->setTag(HERO);
-	this->getChildByTag(MAPLAYER)->addChild(panel->hero,3);
+	this->addChild(panel,PANEL_ON_MAPLYR_ZOR);
+
+	if(HERO_COVER_MODE)
+		map->addChild(panel->hero,HERO_ON_MAP_ZOR);
+	else 
+		this->getChildByTag(MAPLAYER)->addChild(panel->hero,HERO_ON_PANEL_ZOR);
 
 	//shadow init
-	panel->hero->shadow = ShadowingMan::create();
-	CCPoint heroPos = panel->hero->getHeroTilePos() + ccp(0, 1);
+	Hero* hero = panel->hero;
+	rGlobal->shadow=NULL;
+	if(!sGlobal->mapState->hasSh) return;
+	rGlobal->shadow = ShadowingMan::create();
+	CCPoint heroPos = hero->getHeroTilePos() + ccp(1, 0);
 	CCPoint tPos = map->positionFromTileCoord(heroPos);
-	panel->hero->shadow->setPosition(tPos);
-	//this->getChildByTag(MAPLAYER)->addChild(panel->hero->shadow,5);
-	map->addChild(panel->hero->shadow,5);
-
-	this->addChild(panel,15);
+	rGlobal->shadow->setPosition(tPos);
+	map->addChild(rGlobal->shadow,HERO_ON_MAP_ZOR);
 }
 
diff --git a/Classes/Hero.cpp b/Classes/Hero.cpp
index 5e4016f..e827bec 100644
--- a/Classes/Hero.cpp
+++ b/Classes/Hero.cpp
@@ -2,7 +2,7 @@
 
 bool Hero::init() 
 {
-	setID(0); picNo=0; isWalking=false;  
+	setID(0); picNo=0; isWalking=false; 
 	map=(Map*)rGlobal->map;
 	dir=sGlobal->mapState->faceDir;
 
@@ -44,36 +44,22 @@ void Hero::doEvent(CCPoint heroTilePos)
 		{
 			case 0:case 1:case 2:case 3:case 4:
 			case 5:case 6:case 7:case 8:case 9:
+				if(id==sGlobal->mapState->storyCnt)
 				{
-					if(id==sGlobal->mapState->storyCnt)
-					{
-						touchEnded=dir;walkEnd();//endWalking
-						this->focus=false;
-						CCEGLView::sharedOpenGLView()->setDesignResolutionSize(JX_RESOLUWID, JX_RESOLUHEI, kResolutionExactFit);
-						CCScene* story=StoryWorld::scene();
-						CCDirector::sharedDirector()->pushScene(story);
-						this->gotFocusT();
-						sGlobal->mapState->storyCnt++;
-						sGlobal->save();
-					}
+					touchEnded=dir;walkEnd();//endWalking
+					this->focus=false;
+					CCEGLView::sharedOpenGLView()->setDesignResolutionSize(JX_RESOLUWID, JX_RESOLUHEI, kResolutionExactFit);
+					CCScene* story=StoryWorld::scene();
+					CCTransitionFade *scenetrans = CCTransitionFade::create(0.7, story);
+					CCDirector::sharedDirector()->pushScene(scenetrans);
+					this->gotFocusT();
+					sGlobal->mapState->storyCnt++;
+					sGlobal->save();
 				}
 				break;
 
-			case MAP11:
-				touchEnded=dir;walkEnd();
-				map->removeAllChildrenWithCleanup(true);
-				map=Map::create(MAP12_PATH);//@
-				map->crossMap(heroTilePos,MAP11);
-				this->getParent()->addChild(map);
-				break;
-
-			case MAP12:
-				touchEnded=dir;walkEnd();
-				map->removeAllChildrenWithCleanup(true);
-				map=Map::create(MAP11_PATH);//@
-				map->crossMap(heroTilePos,MAP12);
-				this->getParent()->addChild(map);
-				break;
+			case MAP11: crossToMap(MAP12); break;
+			case MAP12: crossToMap(MAP11); break;
 			default:break;
 		}
 	}
@@ -85,8 +71,9 @@ void Hero::doEvent(CCPoint heroTilePos)
 			touchEnded=dir;walkEnd();//endWalking
 			this->focus=false;
 			CCEGLView::sharedOpenGLView()->setDesignResolutionSize(JX_RESOLUWID, JX_RESOLUHEI, kResolutionExactFit);
-			CCScene* combat=Combat::scene();
-			CCDirector::sharedDirector()->pushScene(combat);//@
+//			CCScene* combat=Combat::scene();
+			//CCTransitionFade *scenetrans = CCTransitionFade::create(0.7, combat);
+//			CCDirector::sharedDirector()->pushScene(scenetrans);//@
 		}
 		this->focus=true;
 		;}
@@ -129,36 +116,6 @@ void Hero::endRespond()
 	touchEnded=dir;
 }
 
-void Hero::stepDown()
-{
-	if (checkEvent(getHeroTilePos())==kEvent)
-		doEvent(getHeroTilePos());
-	walkEnd();
-}
-
-void Hero::stepUp()
-{
-	CCPoint heroCoord=getHeroTilePos();
-	CCPoint moveCoord=move/map->getTileSize().height;
-	if(checkCollision(ccp(heroCoord.x+moveCoord.x,
-					heroCoord.y-moveCoord.y))==kWall)
-	{
-		touchEnded=dir; walkEnd();
-	}
-}
-
-void Hero::followMe()
-{
-	if(touchEnded<=-1)
-	{
-		CCArray* heroPos = CCArray::create();
-		CCPoint heroCoord=getHeroTilePos();
-		heroPos->addObject(CCInteger::create(heroCoord.x));
-		heroPos->addObject(CCInteger::create(heroCoord.y));
-		CCNotificationCenter::sharedNotificationCenter()->postNotification("shadow", (CCObject*)heroPos);
-	}
-}
-
 void Hero::walkEnd()
 {
 	if(touchEnded>-1)
@@ -207,6 +164,7 @@ void Hero::initAction(int dir)
 	CCCallFunc* stepD=CCCallFunc::create(this,callfunc_selector(Hero::stepDown));
 	//CCSpawn* animJ=CCSpawn::create(anim,jump,NULL);
 	CCSequence* revAct = CCSequence::create(stepU, delay, follM, revShift, stepD, NULL);
+
 	moveLegs=CCRepeatForever::create(anim);
 	moveMap=CCRepeatForever::create(revAct);
 }
@@ -215,6 +173,40 @@ void Hero::initAction(int dir)
 
 
 
+void Hero::stepUp()
+{
+	CCPoint heroCoord=getHeroTilePos();
+	CCPoint moveCoord=move/map->getTileSize().height;
+	if(checkCollision(ccp(heroCoord.x+moveCoord.x,
+					heroCoord.y-moveCoord.y))==kWall)
+	{
+		touchEnded=dir; walkEnd();
+	}
+}
+
+void Hero::followMe()
+{
+	if(touchEnded<=-1)
+	{
+		CCArray* heroPos = CCArray::create();
+		CCPoint heroCoord=getHeroTilePos();
+		heroPos->addObject(CCInteger::create(heroCoord.x));
+		heroPos->addObject(CCInteger::create(heroCoord.y));
+		CCNotificationCenter::sharedNotificationCenter()->postNotification(HERO_STEP_UP_MSG, (CCObject*)heroPos);
+	}
+}
+
+void Hero::stepDown()
+{
+	if (checkEvent(getHeroTilePos())==kEvent)
+		doEvent(getHeroTilePos());
+	walkEnd();
+}
+
+
+
+
+
 
 
 
@@ -255,3 +247,30 @@ void Hero::gotFocusT()
 {
 	focus=true;
 }
+
+void Hero::crossToMap(int mapNo)
+{
+	//choose map 
+	CCString* path; CCPoint heroTilePos=getHeroTilePos();
+	CCPoint delt=ccp(1,0);
+	if(mapNo==MAP11) //arrive at MAP11
+		path=CCString::create(MAP11_PATH), delt=ccp(1,0);
+	else 
+		path=CCString::create(MAP12_PATH), delt=ccp(-1,0);
+
+	//change map
+	touchEnded=dir;walkEnd();
+	map->removeAllChildrenWithCleanup(true);
+	map=Map::create(path->getCString());
+	rGlobal->map=map;
+	map->crossMap(heroTilePos,mapNo);
+	this->getParent()->addChild(map);
+
+	//re-create rGlobal->shadow
+	if(rGlobal->shadow==NULL) return;
+	rGlobal->shadow = ShadowingMan::create();
+	CCPoint heroPos = getHeroTilePos() + delt;
+	CCPoint tPos = map->positionFromTileCoord(heroPos);
+	rGlobal->shadow->setPosition(tPos);
+	map->addChild(rGlobal->shadow,5);
+}
diff --git a/Classes/Hero.h b/Classes/Hero.h
index 4c23566..6c7ee2f 100644
--- a/Classes/Hero.h
+++ b/Classes/Hero.h
@@ -25,7 +25,6 @@ public:
 public:
     Map* map;
     CCPoint move;
-	ShadowingMan* shadow;
 private:
     bool init();
     void initAction(int dir);
@@ -35,9 +34,13 @@ private:
     void walkEnd();
     CollisionType checkEvent(CCPoint tileCoord);
     void doEvent(CCPoint heroPosition);
+	void crossToMap(int mapNo); 
     cocos2d::CCAction* moveMap;
     cocos2d::CCAction* moveLegs;
     int touchEnded;
     bool focus;
+
+	CCAction* moveHero;
+	void stepForward();
 };
 #endif
diff --git a/Classes/Map.cpp b/Classes/Map.cpp
index 8dfdc47..1e2780a 100644
--- a/Classes/Map.cpp
+++ b/Classes/Map.cpp
@@ -39,20 +39,13 @@ void Map::initNPC()
 
 Map* Map::crossMap(CCPoint tileBirthPoint,int mapNo)
 {
-	if(mapNo==MAP11)
-	{
+	if(mapNo==MAP12) //Arriving to the right piece: MAP12
 		tileBirthPoint=ccp(2+3,tileBirthPoint.y);
-		sGlobal->mapState->mapNo=MAP12;
-		eManager->release();
-		eManager->load(EVENT_MAP11);
-	}
 	else
-	{
 		tileBirthPoint=ccp(this->getMapSize().width-3-3,tileBirthPoint.y);
-		sGlobal->mapState->mapNo=MAP11;
-		eManager->release();
-		eManager->load(EVENT_MAP12);
-	}
+	sGlobal->mapState->mapNo=mapNo;
+	eManager->release();
+	eManager->load(mapNo-MAP10,TimeUtil::getWeekDay());
 	this->setPosition(this->humanPosForTileMove(tileBirthPoint));
 	initNPC();
 	return this;
diff --git a/Classes/Map.h b/Classes/Map.h
index f9c47d4..dc9a8b0 100644
--- a/Classes/Map.h
+++ b/Classes/Map.h
@@ -7,6 +7,7 @@
 #include "WalkingMan.h"
 #include "NPCUtil.h"
 #include "Emap.h"
+#include "TimeUtil.h"
 using namespace cocos2d;
 //displays the game Map and NPCs
 //stores the NPCs to respond to Events
diff --git a/Classes/MapState.h b/Classes/MapState.h
index 5a0a8a0..d8e0f7e 100644
--- a/Classes/MapState.h
+++ b/Classes/MapState.h
@@ -10,5 +10,7 @@ public:
    int positionY;
    int faceDir;
    int sTime;
+   bool hasSh;
+   int standPos;
 };
 #endif
diff --git a/Classes/MenuLayer.cpp b/Classes/MenuLayer.cpp
index d500c1e..aac120b 100644
--- a/Classes/MenuLayer.cpp
+++ b/Classes/MenuLayer.cpp
@@ -27,7 +27,7 @@ bool MenuLayer::init()
 	diawindow->setControllerListener(hero);
 	addChild(diawindow,5);
 	sGlobalRes::instance()->diawindow=diawindow;//@
-	eManager->load(0);
+	//eManager->load(0);
 
 	map->initNPC();
 	map->setGameStartPos();
diff --git a/Classes/Monster.cpp b/Classes/Monster.cpp
new file mode 100644
index 0000000..12ff5d1
--- /dev/null
+++ b/Classes/Monster.cpp
@@ -0,0 +1,52 @@
+#include "Monster.h"
+
+bool Monster::init()
+{
+	cc_timeval psv;
+	CCTime::gettimeofdayCocos2d(&psv,NULL);
+	unsigned long int rand_seed = psv.tv_sec*1000+psv.tv_usec/1000;
+	srand(rand_seed);
+	
+	return true;
+}
+void Monster::setMonster(int monType)
+{
+	CCSize visibleSize = CCDirector::sharedDirector()->getVisibleSize();
+	char monPath[20];
+	if (monType==0)
+	{
+		monsterNo = (int)(CCRANDOM_0_1()*6);
+		sprintf(monPath,"monster%d.png",monsterNo);
+		monster = CCSprite::create(monPath);
+		level = (int)(CCRANDOM_0_1()*20);
+	}
+	else
+	{
+		sprintf(monPath,"monster%d.png",monType);
+		monster = CCSprite::create(monPath);
+		level = 30;
+	}
+
+	healthPoint=100+level*2;
+	currentHp=healthPoint;
+	
+	
+	monster->setPosition(ccp(visibleSize.width-100,visibleSize.height-200));
+	this->addChild(monster);
+}
+
+int Monster::chooseButton()
+{
+	//srand((unsigned)time(NULL));
+	//Ñ¡buttonËã·¨
+	int tag;
+	float rdm = CCRANDOM_0_1();
+	CCLOG("%f",rdm);
+	if (rdm<0.3)
+		tag=0;
+	else if (rdm>=0.3&&rdm<0.6)
+		tag=1;
+	else if (rdm>=0.6&&rdm<=1)
+		tag=2;
+	return tag;
+}
\ No newline at end of file
diff --git a/Classes/Monster.h b/Classes/Monster.h
new file mode 100644
index 0000000..aaa694e
--- /dev/null
+++ b/Classes/Monster.h
@@ -0,0 +1,23 @@
+#ifndef __MONSTER_H__
+#define __MONSTER_H__
+#include "Role.h"
+#include "cocos-ext.h"
+#include "time.h"
+using namespace cocos2d;
+USING_NS_CC_EXT; 
+
+#define MONSTER "monster.png"
+class Monster:public Role
+{
+public:
+	CREATE_FUNC(Monster);
+public:
+	int monsterNo;
+	virtual bool init();
+	void setMonster(int monType);
+	int chooseButton();
+	//void attack();
+private:
+	CCSprite* monster;
+};
+#endif 
\ No newline at end of file
diff --git a/Classes/NPCUtil.cpp b/Classes/NPCUtil.cpp
index 7caac06..34f02ed 100644
--- a/Classes/NPCUtil.cpp
+++ b/Classes/NPCUtil.cpp
@@ -15,7 +15,8 @@ CCArray* NPCUtil::initNPC()
 			int cat=event->category;
 			int arg0;
 			HumanEntity* man;
-			CCInteger* intg=(CCInteger*)args->objectAtIndex(INDEX_ZERO);
+			CCInteger* intg;
+			if(args->count()!=0) intg = (CCInteger*)args->objectAtIndex(INDEX_ZERO);
 			switch(cat)
 			{
 			case STANDING:
@@ -41,7 +42,7 @@ CCArray* NPCUtil::initNPC()
 			default:break;
 			}
 			man->setTag(MAN_START+event->id);
-			rGlobal->map->addChild(man,4);
+			rGlobal->map->addChild(man,NPC_ON_MAP_BACK_ZOR);
 			NPCs->addObject(man);
 		}
 	}
diff --git a/Classes/Particles.cpp b/Classes/Particles.cpp
new file mode 100644
index 0000000..07e8b25
--- /dev/null
+++ b/Classes/Particles.cpp
@@ -0,0 +1,57 @@
+#include "Particles.h"
+
+bool Particles::init()
+{
+	mSystem = new CCParticleSystemQuad();
+	
+	this->addChild(mSystem);
+	return true;
+}
+
+void Particles::setFireParticle()
+{
+	mSystem->initWithFile("FireParticle.plist");//plistÎÄ¼þ¿ÉÒÔÍ¨¹ýÀý×Ó±à¼­Æ÷»ñµÃ
+	mSystem->setTextureWithRect(CCTextureCache::sharedTextureCache()->addImage("particleFire.png")
+		,CCRectMake(0,0,64,64));//¼ÓÔØÍ¼Æ¬£¬µÚÒ»¸ö²ÎÊýÊÇÎÆÀí£¬µÚ¶þ¸ö²ÎÊýÊÇÑ¡ÔñÍ¼Æ¬ÉÏµÄÎ»ÖÃ
+	mSystem->setBlendAdditive(true);//Õâ¸öµ÷ÓÃ±Ø²»¿ÉÉÙ
+	//mSystem->setPosition(ccp(200,200));//ÉèÖÃÎ»ÖÃ	
+}
+
+void Particles::setWaterParticle()
+{
+	mSystem->initWithFile("WaterParticle.plist");//plistÎÄ¼þ¿ÉÒÔÍ¨¹ýÀý×Ó±à¼­Æ÷»ñµÃ
+	mSystem->setTextureWithRect(CCTextureCache::sharedTextureCache()->addImage("particleNapalm.png")
+		,CCRectMake(0,0,64,64));//¼ÓÔØÍ¼Æ¬£¬µÚÒ»¸ö²ÎÊýÊÇÎÆÀí£¬µÚ¶þ¸ö²ÎÊýÊÇÑ¡ÔñÍ¼Æ¬ÉÏµÄÎ»ÖÃ
+	mSystem->setBlendAdditive(true);//Õâ¸öµ÷ÓÃ±Ø²»¿ÉÉÙ
+	//mSystem->setPosition(ccp(200,200));//ÉèÖÃÎ»ÖÃ
+}
+
+void Particles::setWoodParticle()
+{
+	mSystem->initWithFile("WoodParticle.plist");//plistÎÄ¼þ¿ÉÒÔÍ¨¹ýÀý×Ó±à¼­Æ÷»ñµÃ
+	mSystem->setTextureWithRect(CCTextureCache::sharedTextureCache()->addImage("leave.png")
+		,CCRectMake(0,0,64,64));//¼ÓÔØÍ¼Æ¬£¬µÚÒ»¸ö²ÎÊýÊÇÎÆÀí£¬µÚ¶þ¸ö²ÎÊýÊÇÑ¡ÔñÍ¼Æ¬ÉÏµÄÎ»ÖÃ
+	mSystem->setBlendAdditive(true);//Õâ¸öµ÷ÓÃ±Ø²»¿ÉÉÙ
+	//mSystem->setPosition(ccp(200,200));//ÉèÖÃÎ»ÖÃ
+}
+
+void Particles::playerAttack()
+{
+	//mSystem->setAngle(180);
+	mSystem->setPosition(ccp(200,240));//ÉèÖÃÎ»ÖÃ
+}
+
+void Particles::monsterAttack()
+{
+	mSystem->setAngle(180);
+	mSystem->setPosition(ccp(470,240));//ÉèÖÃÎ»ÖÃ
+}
+
+void Particles::setParticleDuration(float dt)
+{
+	mSystem->setDuration(dt);
+}
+void Particles::setParticleLife(float dt)
+{
+	mSystem->setLife(dt);
+}
\ No newline at end of file
diff --git a/Classes/Particles.h b/Classes/Particles.h
new file mode 100644
index 0000000..8d77f6e
--- /dev/null
+++ b/Classes/Particles.h
@@ -0,0 +1,25 @@
+#ifndef __PARTICLES_H__
+#define __PARTICLES_H__
+#include "cocos2d.h"
+#include "cocos-ext.h"
+using namespace cocos2d;
+USING_NS_CC_EXT; 
+class Particles:public CCNode
+{
+public:
+	CREATE_FUNC(Particles);
+public:
+    virtual bool init();
+	void setFireParticle();
+	void setWaterParticle();
+	void setWoodParticle();
+	void playerAttack();
+	void monsterAttack();
+	//void setDuration();
+	void setParticleDuration(float dt);
+	void setParticleLife(float dt);
+private:
+	CCParticleSystemQuad *m_emitter;
+	CCParticleSystemQuad* mSystem;
+};
+#endif 
\ No newline at end of file
diff --git a/Classes/PlayReader.cpp b/Classes/PlayReader.cpp
index a980175..db967a2 100644
--- a/Classes/PlayReader.cpp
+++ b/Classes/PlayReader.cpp
@@ -10,122 +10,119 @@
 #include "strtok_r.c"
 
 PlayReader::PlayReader() {
-    lineNum=0;
-    curLine=0;
-	//saver = *cocos2d::CCUserDefault::sharedUserDefault();
+  lineNum=0;
+  curLine=0;
+  //saver = *cocos2d::CCUserDefault::sharedUserDefault();
 }
 
 PlayReader::PlayReader(string filePath) {
-    ReadFileWithFullPath(filePath);
+  ReadFileWithFullPath(filePath);
 }
 
 void PlayReader::ReadFileWithFullPath(cocos2d::CCString filePath) {
-    unsigned char *buffer;
-    unsigned long bufSize;
-    buffer = cocos2d::CCFileUtils::sharedFileUtils()->getFileData(filePath.getCString(), "r", &bufSize);
-    split((char *)buffer, "\n", &dialogs);
-    lineNum = dialogs.size();
-    curLine = 0;
+  unsigned char *buffer;
+  unsigned long bufSize;
+  buffer = cocos2d::CCFileUtils::sharedFileUtils()->getFileData(filePath.getCString(), "r", &bufSize);
+  split((char *)buffer, "\n", &dialogs);
+  lineNum = dialogs.size();
+  curLine = 0;
 }
 
 vector<string> PlayReader::PlayerNames() {
-	unsigned char *buffer;
-    unsigned long bufSize;
-	vector<string> names;
-	std::string fullPath = cocos2d::CCFileUtils::sharedFileUtils()->fullPathForFilename("names.txt");
-    buffer = cocos2d::CCFileUtils::sharedFileUtils()->getFileData(fullPath.c_str(), "r", &bufSize);
-    split((char *)buffer, "\n", &names);
-	return names;
+  unsigned char *buffer;
+  unsigned long bufSize;
+  vector<string> names;
+  std::string fullPath = cocos2d::CCFileUtils::sharedFileUtils()->fullPathForFilename("names.txt");
+  buffer = cocos2d::CCFileUtils::sharedFileUtils()->getFileData(fullPath.c_str(), "r", &bufSize);
+  split((char *)buffer, "\n", &names);
+  return names;
 }
 
 string PlayReader::GetNextDialog() {
-    assert(curLine<=lineNum);
-    return dialogs[curLine++];
+  assert(curLine<=lineNum);
+  return dialogs[curLine++];
 }
 
 void PlayReader::ChangeFile(cocos2d::CCString filePath) {
-    dialogs.clear();
-    ReadFileWithFullPath(filePath);
+  dialogs.clear();
+  ReadFileWithFullPath(filePath);
 }
 
 void PlayReader::split(const char * str,const char * deli, vector<string> *list) {
-    char buff[200000];
-    //_snprintf(buff,sizeof(buff), str, NULL);
-	//for(int i=0;i<200000;i++)
-		//buff[i]=str[i];
-	strcpy(buff,str);
-    char * gg;
-    char *p = strtok_r(buff, deli, &gg);
-    
-    list->clear();
-    while(p !=NULL && gg!=NULL)
-    {
-        list->push_back(p);
-        p = strtok_r(NULL, deli, &gg);
-    };
+  char buff[200000];
+  strcpy(buff,str);
+  char * gg;
+  char *p = strtok_r(buff, deli, &gg);
+  
+  list->clear();
+  while(p !=NULL && gg!=NULL)
+  {
+    list->push_back(p);
+    p = strtok_r(NULL, deli, &gg);
+  };
 }
 
 int PlayReader::getCurLine() {
-    return (int)curLine;
+  return (int)curLine;
 }
 
 
 ProcessSaver::ProcessSaver() {
-    // Read the save
-    if (cocos2d::CCUserDefault::sharedUserDefault()->getBoolForKey("FisrtSave", true)) {
-        cocos2d::CCUserDefault::sharedUserDefault()->setBoolForKey("FisrtSave", false);
-        cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionX", 0);
-        cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionY", 0);
-        cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("MapProcess", 0);
-        cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("Process", '0');
-        cocos2d::CCUserDefault::sharedUserDefault()->flush();
-    } else {
-        _x = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("PositionX");
-        _y = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("PositionY");
-        _mapProcess = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("MapProcess");
-        _process = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("Process");
-    }
+  // Read the save
+  if (cocos2d::CCUserDefault::sharedUserDefault()->getBoolForKey("FisrtSave", true)) {
+    cocos2d::CCUserDefault::sharedUserDefault()->setBoolForKey("FisrtSave", false);
+    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionX", 0);
+    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionY", 0);
+    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("MapProcess", 0);
+    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("Process", '0');
+    cocos2d::CCUserDefault::sharedUserDefault()->flush();
+  } else {
+    _x = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("PositionX");
+    _y = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("PositionY");
+    _mapProcess = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("MapProcess");
+    _process = cocos2d::CCUserDefault::sharedUserDefault()->getIntegerForKey("Process");
+  }
 }
 
 void ProcessSaver::save(int x, int y, int mapProcess) {
-    _x = x; _y = y; _mapProcess = mapProcess;
-    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionX", _x);
-    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionY", _y);
-    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("MapProcess", _mapProcess);
-    cocos2d::CCUserDefault::sharedUserDefault()->flush();
+  _x = x; _y = y; _mapProcess = mapProcess;
+  cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionX", _x);
+  cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionY", _y);
+  cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("MapProcess", _mapProcess);
+  cocos2d::CCUserDefault::sharedUserDefault()->flush();
 }
 
 void ProcessSaver::savePosition(int x, int y) {
-    _x = x; _y = y;
-    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionX", _x);
-    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionY", _y);
-    cocos2d::CCUserDefault::sharedUserDefault()->flush();
+  _x = x; _y = y;
+  cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionX", _x);
+  cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("PositionY", _y);
+  cocos2d::CCUserDefault::sharedUserDefault()->flush();
 }
 
 void ProcessSaver::saveMapProcess(int mapProcess) {
-    _mapProcess = mapProcess;
-    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("MapProcess", _mapProcess);
-    cocos2d::CCUserDefault::sharedUserDefault()->flush();
+  _mapProcess = mapProcess;
+  cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("MapProcess", _mapProcess);
+  cocos2d::CCUserDefault::sharedUserDefault()->flush();
 }
 
 void ProcessSaver::saveProcess(int process) {
-    _process = process;
-    cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("Process", process);
-    cocos2d::CCUserDefault::sharedUserDefault()->flush();
+  _process = process;
+  cocos2d::CCUserDefault::sharedUserDefault()->setIntegerForKey("Process", process);
+  cocos2d::CCUserDefault::sharedUserDefault()->flush();
 }
 
 int ProcessSaver::getPositionX() {
-    return _x;
+  return _x;
 }
 
 int ProcessSaver::getPositionY() {
-    return _y;
+  return _y;
 }
 
 int ProcessSaver::getMapProcess() {
-    return _mapProcess;
+  return _mapProcess;
 }
 
 int ProcessSaver::getProcess() {
-    return _process;
+  return _process;
 }
\ No newline at end of file
diff --git a/Classes/PlayReader.h b/Classes/PlayReader.h
index ce8649b..1f0f80c 100644
--- a/Classes/PlayReader.h
+++ b/Classes/PlayReader.h
@@ -17,38 +17,37 @@
 using namespace std;
 class PlayReader {
 public:
-    PlayReader();
-    PlayReader(string filePath);
-    void ReadFileWithFullPath(cocos2d::CCString filePath);
-    string GetNextDialog();
-    void ChangeFile(cocos2d::CCString filePath);
-    int getCurLine();
-	vector<string> PlayerNames();
-    
+  PlayReader();
+  PlayReader(string filePath);
+  void ReadFileWithFullPath(cocos2d::CCString filePath);
+  string GetNextDialog();
+  void ChangeFile(cocos2d::CCString filePath);
+  int getCurLine();
+  vector<string> PlayerNames();
+  
 protected:
-    void split(const char * str,const char * deli, vector<string> *list);
-    
-    unsigned long lineNum;
-    unsigned long curLine;
-    vector<string> dialogs;
-    
+  void split(const char * str,const char * deli, vector<string> *list);
+  
+  unsigned long lineNum;
+  unsigned long curLine;
+  vector<string> dialogs;
+  
 };
 #endif /* defined(_________PlayReader__) */
 
 
 class ProcessSaver {
-    int _x, _y, _mapProcess;
-    int _process;
-    //cocos2d::CCUserDefault saver;
-    
+  int _x, _y, _mapProcess;
+  int _process;
+  
 public:
-    ProcessSaver();
-    void save(int x, int y, int mapProcess);
-    void savePosition(int x, int y);
-    void saveMapProcess(int mapProcess);
-    void saveProcess(int process);
-    int getPositionX();
-    int getPositionY();
-    int getMapProcess();
-    int getProcess();
+  ProcessSaver();
+  void save(int x, int y, int mapProcess);
+  void savePosition(int x, int y);
+  void saveMapProcess(int mapProcess);
+  void saveProcess(int process);
+  int getPositionX();
+  int getPositionY();
+  int getMapProcess();
+  int getProcess();
 };
\ No newline at end of file
diff --git a/Classes/PlayerState.h b/Classes/PlayerState.h
new file mode 100644
index 0000000..ea041ee
--- /dev/null
+++ b/Classes/PlayerState.h
@@ -0,0 +1,16 @@
+#ifndef _PLAYER_STATE_H_
+#define _PLAYER_STATE_H_
+#include "cocos2d.h"
+#include "AppMacros.h"
+
+using namespace cocos2d;
+
+//Record of the state of the game in the memory
+//contains pointer to playerState of Player
+//and pointer to bagRecord of Backpack
+class PlayerState
+{
+public:
+	int exp;
+};
+#endif
diff --git a/Classes/ReloadEvent.cpp b/Classes/ReloadEvent.cpp
new file mode 100644
index 0000000..22bbb23
--- /dev/null
+++ b/Classes/ReloadEvent.cpp
@@ -0,0 +1,29 @@
+#include "ReloadEvent.h"
+#include "GlobalRes.h"
+#include "AnimLib.h"
+#include "EventManager.h"
+#include "TimeUtil.h"
+#include "Map.h"
+
+void ReloadEvent::happen()
+{
+	CCSequence* blinkOfNight=CCSequence::create(
+			AnimLib::getAction(FADEIN,CCSize()),
+			CCDelayTime::create(1.5f),
+			AnimLib::getAction(FADEOUT,CCSize()),
+			NULL);
+	rGlobal->nightBg->runAction(blinkOfNight);
+
+	Map* map=(Map*)rGlobal->map;
+	for (int i = 0; i < map->NPCs->count(); i++)
+	{
+		CCNode* npc=(CCNode*)map->NPCs->objectAtIndex(i);
+		npc->removeFromParent();
+	}
+	map->NPCs->release();
+	sGlobal->mapState->sTime++;
+	eManager->release();
+	int mapNo=sGlobal->mapState->mapNo;
+	eManager->load(mapNo-MAP10,TimeUtil::getWeekDay());
+	map->initNPC();
+}
diff --git a/Classes/ReloadEvent.h b/Classes/ReloadEvent.h
new file mode 100644
index 0000000..6f55dda
--- /dev/null
+++ b/Classes/ReloadEvent.h
@@ -0,0 +1,14 @@
+#ifndef _RELOAD_EVENT_H_
+#define _RELOAD_EVENT_H_
+#include "Event.h"
+
+//Reloads all event on the map after a blink of night
+class ReloadEvent: public Event
+{
+public:
+    CREATE_FUNC(ReloadEvent);
+public:
+    void happen();
+};
+#endif
+
diff --git a/Classes/RestorationEvent.cpp b/Classes/RestorationEvent.cpp
index 9697ed4..c358d60 100644
--- a/Classes/RestorationEvent.cpp
+++ b/Classes/RestorationEvent.cpp
@@ -3,7 +3,7 @@
 void RestorationEvent::happen()
 {
     CCInteger* intg=(CCInteger*)args->objectAtIndex(NUM_ATTALT_INDEX);
-    CombatUnit* player=sGlobal->playerState;
+    PlayerState* player=sGlobal->playerState;
     for(int i=0;i<intg->getValue();i++)
     {
 	int index=NUM_ATTALT_INDEX+2*i;
diff --git a/Classes/Role.cpp b/Classes/Role.cpp
new file mode 100644
index 0000000..df5848c
--- /dev/null
+++ b/Classes/Role.cpp
@@ -0,0 +1,6 @@
+#include "Role.h"
+
+bool Role::init()
+{
+	return true;
+}
\ No newline at end of file
diff --git a/Classes/Role.h b/Classes/Role.h
new file mode 100644
index 0000000..afe6240
--- /dev/null
+++ b/Classes/Role.h
@@ -0,0 +1,19 @@
+#ifndef __Role_H__
+#define __Role_H__
+#include "cocos2d.h"
+#include "cocos-ext.h"
+using namespace cocos2d;
+USING_NS_CC_EXT; 
+class Role:public CCNode
+{
+public:
+	CREATE_FUNC(Role);
+public:
+	virtual bool init();
+	//int getHp();
+	int exp;
+	int level;
+	int healthPoint;
+	int currentHp;
+};
+#endif 
\ No newline at end of file
diff --git a/Classes/ShadowingMan.cpp b/Classes/ShadowingMan.cpp
index 0e7c06c..1c0bfcd 100644
--- a/Classes/ShadowingMan.cpp
+++ b/Classes/ShadowingMan.cpp
@@ -4,7 +4,7 @@
 
 bool ShadowingMan::init()
 {
-	CCNotificationCenter::sharedNotificationCenter()->addObserver(this,callfuncO_selector(ShadowingMan::shadow),"shadow",NULL);
+	CCNotificationCenter::sharedNotificationCenter()->addObserver(this,callfuncO_selector(ShadowingMan::shadow),HERO_STEP_UP_MSG,NULL);
 	this->picNo=9;
 	//this->setID(SHADOWN_FLAG_ID);
 	this->initSprite();
@@ -41,7 +41,13 @@ void ShadowingMan::shadow(CCObject* heroPos)
 	else
 		CCLog("Strange vect: (%f,%f)", vect.x, vect.y);
 
-	CCMoveBy* move=CCMoveBy::create(STD_WALK_DURATION*0.45,vect);
+	const float duration=STD_WALK_DURATION/sGlobal->superPower->speed;
+	CCMoveBy* move=CCMoveBy::create(duration*0.9,vect);
 	CCAnimate* anim=CCAnimate::create(walkAnimations[dir]);//è¡Œèµ°
 	sprite->runAction(anim); this->runAction(move);
 }
+
+ShadowingMan::~ShadowingMan()
+{
+	CCNotificationCenter::sharedNotificationCenter()->purgeNotificationCenter();
+}
diff --git a/Classes/ShadowingMan.h b/Classes/ShadowingMan.h
index 0f6afca..92668f7 100644
--- a/Classes/ShadowingMan.h
+++ b/Classes/ShadowingMan.h
@@ -11,6 +11,7 @@ public:
     CREATE_FUNC(ShadowingMan);
 	bool init();
 	void shadow(CCObject* direction);
+	~ShadowingMan();
 };
 #endif
 
diff --git a/Classes/Story.cpp b/Classes/Story.cpp
index d123494..480a61a 100644
--- a/Classes/Story.cpp
+++ b/Classes/Story.cpp
@@ -1,460 +1,512 @@
 #include "Story.h"
 
 USING_NS_CC;
-//update: 2014-9-30 13:29:52
+//update: 2015-7-26 13:44:52
 
 CCScene* StoryWorld::scene() {
-    CCScene *scene = CCScene::create();
-    StoryWorld *layer = StoryWorld::create();
-	layer->setTag(1);
-    scene->addChild(layer);
-    return scene;
+  CCScene *scene = CCScene::create();
+  StoryWorld *layer = StoryWorld::create();
+  layer->setTag(1);
+  scene->addChild(layer);
+  return scene;
 }
 
 bool StoryWorld::init() {
-    if ( !CCLayer::init() )
-    {
-        return false;
-    }
-
-    char theName[10][11]={"","ç©†å©§:", "å­è½©:", "å°‘æ°:", "å»ºå›½", "è·¯äººA:", "è·¯äººB:", "è·¯äººC:", "è€çˆ·çˆ·:", "æ±Ÿå§:"};
-    char play[20] = SCRIPT_PATH;
-    int current=sGlobal->mapState->storyCnt+'0';//stay
-    play[SCRIPT_PATH_LEN] = current;
-    reader.ReadFileWithFullPath(CCFileUtils::sharedFileUtils()->fullPathForFilename(play));
-    setTouchEnabled(true);
-    CCSize visibleSize = CCDirector::sharedDirector()->getVisibleSize();
-    CCPoint origin = CCDirector::sharedDirector()->getVisibleOrigin();
-    CCMenuItemImage *pCloseItem = CCMenuItemImage::create(
-                                        CLOSEN_IMG_PATH, CLOSES_IMG_PATH, this, menu_selector(StoryWorld::menuCloseCallback)); 
-	pCloseItem->setPosition(ccp(origin.x + visibleSize.width - pCloseItem->getContentSize().width/2 ,
-                                origin.y + pCloseItem->getContentSize().height/2));
-    
-    CCMenu* pMenu = CCMenu::create(pCloseItem, NULL);
-    pMenu->setPosition(CCPointZero);
-    addChild(pMenu, 2);
-    
-    char bg_name[30] = BGNAME_IMG_PATH;
-    bg_name[BGNAME_PATH_LEN] = current;
-    CCSprite* pBackground = CCSprite::create(bg_name);
-    pBackground->setPosition(ccp(visibleSize.width/2 + origin.x, visibleSize.height/2 + origin.y));
-    pBackground->setScale(1);
-    pBackground->setTag(108);
-    addChild(pBackground, 0);
-    
-    CCSprite* dialogBox = CCSprite::create(DUIHUAKUANG_IMG_PATH);
-    dialogBox->setPosition(ccp(visibleSize.width/2, dialogBox->getContentSize().height/2));
-    dialogBox->setOpacity(220);
-    addChild(dialogBox,1);
-    
-    CCLabelTTF* pName = CCLabelTTF::create(theName[0], "Heiti SC", 40);
-    pName->setTag(101);
-    pName->setPosition(ccp(pName->getContentSize().width/2, dialogBox->getContentSize().height - 2 * pName->getContentSize().height));
-    pName->setAnchorPoint(CCPointZero);
-    addChild(pName, 1);
-    
-    CCLabelTTF* pLabel = CCLabelTTF::create("Click to Start", "Heiti SC", 40);
-    pLabel->setTag(100);
-    pLabel->setPosition(ccp(40, origin.y + dialogBox->getContentSize().height - 3.4 * pLabel->getContentSize().height));
-    pLabel->setAnchorPoint(CCPointZero);
-    pLabel->setDimensions(CCSizeMake(1100, 0));
-    pLabel->setHorizontalAlignment(kCCTextAlignmentLeft);
-    addChild(pLabel, 1);
-    
+  if ( !CCLayer::init() ) {
+    return false;
+  }
+  char theName[10][11]={"","ç©†å©§:", "å­è½©:", "å°‘æ°:", "å»ºå›½", "è·¯äººA:", "è·¯äººB:", "è·¯äººC:", "è€çˆ·çˆ·:", "æ±Ÿå§:"};
+  char play[20] = SCRIPT_PATH;
+  int current=sGlobal->mapState->storyCnt+'0';//stay
+  play[SCRIPT_PATH_LEN] = current;
+  reader.ReadFileWithFullPath(CCFileUtils::sharedFileUtils()->fullPathForFilename(play));
+  setTouchEnabled(true);
+  CCSize visibleSize = CCDirector::sharedDirector()->getVisibleSize();
+  CCPoint origin = CCDirector::sharedDirector()->getVisibleOrigin();
+  CCMenuItemImage *pCloseItem = CCMenuItemImage::create(CLOSEN_IMG_PATH, CLOSES_IMG_PATH, this, menu_selector(StoryWorld::menuCloseCallback));
+  
+  pCloseItem->setPosition(ccp(origin.x + visibleSize.width - pCloseItem->getContentSize().width/2 , origin.y + pCloseItem->getContentSize().height/2));
+  
+  CCMenu* pMenu = CCMenu::create(pCloseItem, NULL);
+  pMenu->setPosition(CCPointZero);
+  addChild(pMenu, 2);
+  
+  char bg_name[30] = "" ;
+  char bg_num[4]="";
+  sprintf(bg_num, "%c00", current);
+  sprintf(bg_name, BGNAME_IMG_PATH, bg_num);
+  CCSprite* pBackground = CCSprite::create(bg_name);
+  pBackground->setPosition(ccp(visibleSize.width/2 + origin.x, visibleSize.height/2 + origin.y));
+  pBackground->setScale(1);
+  pBackground->setTag(108);
+  addChild(pBackground, 0);
+  
+  CCSprite* dialogBox = CCSprite::create(DUIHUAKUANG_IMG_PATH);
+  dialogBox->setPosition(ccp(visibleSize.width/2, dialogBox->getContentSize().height/2));
+  dialogBox->setOpacity(220);
+  addChild(dialogBox,1);
+  
+  CCLabelTTF* pName = CCLabelTTF::create(theName[0], "Heiti SC", 40);
+  pName->setTag(101);
+  pName->setPosition(ccp(pName->getContentSize().width/2, dialogBox->getContentSize().height - 2 * pName->getContentSize().height));
+  pName->setAnchorPoint(CCPointZero);
+  addChild(pName, 1);
+  
+  
+  CCLabelTTF* pLabel = CCLabelTTF::create("Click to Start", "Heiti SC", 40);
+  pLabel->setTag(100);
+  pLabel->setPosition(ccp(40, origin.y + dialogBox->getContentSize().height - 3.4 * pLabel->getContentSize().height));
+  pLabel->setAnchorPoint(CCPointZero);
+  pLabel->setDimensions(CCSizeMake(1100, 0));
+  pLabel->setHorizontalAlignment(kCCTextAlignmentLeft);
+  addChild(pLabel, 1);
+  
+  
     CCSpriteFrameCache::sharedSpriteFrameCache()->addSpriteFramesWithFile(PLIST_IMG_PATH);
     CCSpriteBatchNode *spriteBatch=CCSpriteBatchNode::create(VDRAWING_IMG_PATH);
-    spriteBatch->setTag(102);
-    addChild(spriteBatch, 0);
-    spriteBatch->setPosition(CCPointZero);
-
-    CCSprite *leftSprite=CCSprite::createWithSpriteFrameName("me_1.png");
-    leftSprite->setScale(0.8);
-    leftSprite->setPosition(ccp(leftSprite->getContentSize().width*0.8, leftSprite->getContentSize().height/2 *0.8));
-    leftSprite->setTag(1);
-    leftSprite->setOpacity(0);
-    spriteBatch->addChild(leftSprite, 0);
-    
-    CCSprite *rightSprite=CCSprite::createWithSpriteFrameName("blank.png");
-    rightSprite->setPosition(ccp(800, 130));
-    rightSprite->setTag(2);
-    rightSprite->setOpacity(0);
-    spriteBatch->addChild(rightSprite, 0);
-    
-    avgGame();
-    return true;
+  spriteBatch->setTag(102);
+  addChild(spriteBatch, 0);
+  spriteBatch->setPosition(CCPointZero);
+  
+  CCSprite *leftSprite=CCSprite::createWithSpriteFrameName("me_1.png");
+  leftSprite->setScale(0.8);
+  leftSprite->setPosition(ccp(leftSprite->getContentSize().width*0.8, leftSprite->getContentSize().height/2 *0.8));
+  leftSprite->setTag(1);
+  leftSprite->setOpacity(0);
+  spriteBatch->addChild(leftSprite, 0);
+  
+  CCSprite *rightSprite=CCSprite::createWithSpriteFrameName("blank.png");
+  //rightSprite->setScale(0.8);
+  rightSprite->setPosition(ccp(800, 130));
+  rightSprite->setTag(2);
+  rightSprite->setOpacity(0);
+  spriteBatch->addChild(rightSprite, 0);
+  
+  avgGame();
+  return true;
 }
 
 void StoryWorld::ccTouchesEnded(cocos2d::CCSet *pTouches, cocos2d::CCEvent *pEvent){
-    avgGame();
+  avgGame();
 }
 
 void StoryWorld::avgGame(void) {
-    CCLabelTTF* myDialog = (CCLabelTTF *)getChildByTag(100);
-    CCLabelTTF* myName = (CCLabelTTF *)getChildByTag(101);
-    CCSpriteBatchNode *spriteBatch = (CCSpriteBatchNode *)getChildByTag(102);
-    CCSprite *myLeftSprite = (CCSprite *)spriteBatch->getChildByTag(1);
-    CCSprite *myRightSprite = (CCSprite *)spriteBatch->getChildByTag(2);
-    
-    strcpy(dialog, reader.GetNextDialog().c_str());
-
-	char theName[10][11]={"","ç©†å©§1:", "å­è½©:", "å°‘æ°:", "å»ºå›½", "è·¯äººA:", "è·¯äººB:", "è·¯äººC:", "è€çˆ·çˆ·:", "æ±Ÿå§:"};
-
-	myName->setString(theName[dialog[0]-48]);
-    //ä»»åŠ¡ç«‹ç»˜åˆ‡æ¢
-    switch (dialog[0]) {
-        case '0': {   //æ— äºº
-            char b[10]="me_ .png";
-            b[3] = dialog[1]+1;
-            myLeftSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '1': {   //ME
-            char b[10]="me_ .png";
-            b[3] = dialog[1]+1;
-            myLeftSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '2': {   //å­è½©
-            char b[10]="zx_ .png";
-            b[3] = dialog[1]+1;
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '3': {   //å°‘æ°
-            char b[10]="sj_ .png";
-            b[3] = dialog[1];
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '4': {   //å»ºå›½
-            char b[10]="jg_ .png";
-            b[3] = dialog[1];
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '5': {  
-            char b[10]="la_ .png";
-            b[3] = dialog[1];
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '6': { 
-            char b[10]="lb_ .png";
-            b[3] = dialog[1];
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '7': {
-            char b[10]="lc_ .png";
-            b[3] = dialog[1];
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
-        }
-            break;
-        case '8': { 
-            char b[10]="yy_ .png";
-            b[3] = dialog[1];
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+  CCLabelTTF* myDialog = (CCLabelTTF *)getChildByTag(100);
+  CCLabelTTF* myName = (CCLabelTTF *)getChildByTag(101);
+  CCSpriteBatchNode *spriteBatch = (CCSpriteBatchNode *)getChildByTag(102);
+  CCSprite *myLeftSprite = (CCSprite *)spriteBatch->getChildByTag(1);
+  CCSprite *myRightSprite = (CCSprite *)spriteBatch->getChildByTag(2);
+  
+  strcpy(dialog, reader.GetNextDialog().c_str());
+  
+  char theName[10][11]={"","ç©†å©§:", "å­è½©:", "å°‘æ°:", "å»ºå›½", "è·¯äººA:", "è·¯äººB:", "è·¯äººC:", "è€çˆ·çˆ·:", "æ±Ÿå§:"};
+  
+  myName->setString(theName[dialog[0]-48]);
+  // äººç‰©ç«‹ç»˜åˆ‡æ¢
+  characterPasterSwitchCase(dialog[0]);
+  
+  switch (dialog[2]) {
+      // é€‰æ‹©èµ°å‘
+    case '1': {
+      //å¼€å§‹é€‰æ‹©èµ°å‘
+      //åœæ­¢è§¦æ‘¸
+      setTouchEnabled(false);
+      CCSprite *back = CCSprite::create(LANDSCAPE_IMG_PATH);
+      back->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/2));
+      back->setOpacity(150);
+      back->setTag(3);
+      addChild(back, 3);
+      switch (current) {
+        case '3': {
+          CCLabelTTF *Label1 = CCLabelTTF::create("Yes", "Heiti SC", 40);
+          CCLabelTTF *Label2 = CCLabelTTF::create("No", "Heiti SC", 40);
+          CCMenuItemLabel *firstChoice = CCMenuItemLabel::create(Label1, this, menu_selector(StoryWorld::leafletChoiceHandler));
+          CCMenuItemLabel *secondChoice = CCMenuItemLabel::create(Label2, this, menu_selector(StoryWorld::leafletChoiceHandler));
+          firstChoice->setTag(fChoice);
+          secondChoice->setTag(sChoice);
+          firstChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 4.1));
+          secondChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 2.9));
+          CCMenu *menu = CCMenu::create(firstChoice, secondChoice, NULL);
+          menu->setPosition(CCPointZero);
+          menu->setTag(2);
+          addChild(menu, 3);
+          return;
         }
-            break;
-        case '9': { 
-            char b[10]="jj_ .png";
-            b[3] = dialog[1];
-            myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+          break;
+        case '9': {
+          //åˆ›å»ºCCMenu
+          CCLabelTTF *Label1 = CCLabelTTF::create("å­è½©", "Heiti SC", 40);
+          CCLabelTTF *Label2 = CCLabelTTF::create("å°‘æ°", "Heiti SC", 40);
+          CCLabelTTF *Label3 = CCLabelTTF::create("å»ºå›½", "Heiti SC", 40);
+          CCMenuItemLabel *firstChoice = CCMenuItemLabel::create(Label1, this, menu_selector(StoryWorld::theFinalChoiceHandler));
+          CCMenuItemLabel *secondChoice = CCMenuItemLabel::create(Label2, this, menu_selector(StoryWorld::theFinalChoiceHandler));
+          CCMenuItemLabel *thirdChoice = CCMenuItemLabel::create(Label3, this, menu_selector(StoryWorld::theFinalChoiceHandler));
+          
+          firstChoice->setTag(fChoice);
+          secondChoice->setTag(sChoice);
+          thirdChoice->setTag(tChoice);
+          
+          firstChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 4.1));
+          secondChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 2.9));
+          thirdChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 1.8));
+          
+          CCMenu *menu = CCMenu::create(firstChoice, secondChoice, thirdChoice, NULL);
+          menu->setPosition(CCPointZero);
+          menu->setTag(2);
+          addChild(menu, 3);
+          return;
         }
-            break;
+          break;
+          
         default:
-            break;
+          break;
+      }
+    }
+      break;
+    case '2': {
+      // ä»¥å‰çš„æˆ˜æ–—Sceneå…¥å£
+    }
+      break;
+    case '3': {
+      if (myLeftSprite->getOpacity() == 0)
+        myLeftSprite->setOpacity(255);
+      else
+        myLeftSprite->runAction(CCFadeOut::create(1));
     }
+      break;
+    case '4': {
+      if (myRightSprite->getOpacity() == 0)
+        myRightSprite->setOpacity(255);
+      else
+        myRightSprite->runAction(CCFadeOut::create(1));
+    }
+      break;
+    case '5': {
+      if (myRightSprite->getOpacity()==0 && myLeftSprite->getOpacity()==0) {
+        myLeftSprite->setOpacity(255);
+        myRightSprite->setOpacity(255);
+      } else if (myRightSprite->getOpacity()!=0 && myLeftSprite->getOpacity()!=0) {
+        myLeftSprite->runAction(CCFadeOut::create(1));
+        myRightSprite->runAction(CCFadeOut::create(1));
+      }
+    }
+      break;
+    default:
+      break;
+  }
+  
+  // å‰§æœ¬åˆ‡æ¢åŠå®Œç»“åŠç‰¹æ•ˆ
+  specialPartSwitchCase(dialog[3]);
+  
+  //éŸ³æ•ˆ
+  audioSwitchCase(dialog[4]);
 
-    switch (dialog[2]) {
-            // é€‰æ‹©èµ°å‘
-        case '1': {
-            //å¼€å§‹é€‰æ‹©èµ°å‘
-            //åœæ­¢è§¦æ‘¸
-            setTouchEnabled(false);
-            CCSprite *back = CCSprite::create(LANDSCAPE_IMG_PATH);
-            back->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/2));
-            back->setOpacity(150);
-            back->setTag(3);
-            addChild(back, 3);
-            switch (current) {
-                case '3': {
-                    CCLabelTTF *Label1 = CCLabelTTF::create("Yes", "Heiti SC", 40);
-                    CCLabelTTF *Label2 = CCLabelTTF::create("No", "Heiti SC", 40);
-                    CCMenuItemLabel *firstChoice = CCMenuItemLabel::create(Label1, this, menu_selector(StoryWorld::makeAChoice));
-                    CCMenuItemLabel *secondChoice = CCMenuItemLabel::create(Label2, this, menu_selector(StoryWorld::makeAChoice));
-                    firstChoice->setTag(fChoice);
-                    secondChoice->setTag(sChoice);
-                    firstChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 4.1));
-                    secondChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 2.9));
-                    CCMenu *menu = CCMenu::create(firstChoice, secondChoice, NULL);
-                    menu->setPosition(CCPointZero);
-                    menu->setTag(2);
-                    addChild(menu, 3);
-                    return;
-                }
-                    break;
-                case '9': {
-                    //åˆ›å»ºCCMenu
-                    CCLabelTTF *Label1 = CCLabelTTF::create("å­è½©", "Heiti SC", 40);
-                    CCLabelTTF *Label2 = CCLabelTTF::create("å°‘æ°", "Heiti SC", 40);
-                    CCLabelTTF *Label3 = CCLabelTTF::create("å»ºå›½", "Heiti SC", 40);
-                    CCMenuItemLabel *firstChoice = CCMenuItemLabel::create(Label1, this, menu_selector(StoryWorld::makeAChoice));
-                    CCMenuItemLabel *secondChoice = CCMenuItemLabel::create(Label2, this, menu_selector(StoryWorld::makeAChoice));
-                    CCMenuItemLabel *thirdChoice = CCMenuItemLabel::create(Label3, this, menu_selector(StoryWorld::makeAChoice));
-                    
-                    firstChoice->setTag(fChoice);
-                    secondChoice->setTag(sChoice);
-                    thirdChoice->setTag(tChoice);
-                    
-                    firstChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 4.1));
-                    secondChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 2.9));
-                    thirdChoice->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 1.8));
-                    
-                    CCMenu *menu = CCMenu::create(firstChoice, secondChoice, thirdChoice, NULL);
-                    menu->setPosition(CCPointZero);
-                    menu->setTag(2);
-                    addChild(menu, 3);
-                    return;
-                }
-                    break;
-                default:
-                    break;
-            }
-        }
-            break;
-        case '2': {
-            CCScene *combatScene = Combat::scene();
-            CCDirector::sharedDirector()->pushScene(combatScene);
-        }
-            break;
-        case '3': {
-            if (myLeftSprite->getOpacity() == 0)
-                myLeftSprite->setOpacity(255);
-            else
-                myLeftSprite->runAction(CCFadeOut::create(1));
-        }
-            break;
-        case '4': {
-            if (myRightSprite->getOpacity() == 0)
-                myRightSprite->setOpacity(255);
-            else
-                myRightSprite->runAction(CCFadeOut::create(1));
-        }
-            break;
-        case '5': {
-            if (myRightSprite->getOpacity()==0 && myLeftSprite->getOpacity()==0) {
-                myLeftSprite->setOpacity(255);
-                myRightSprite->setOpacity(255);
-            } else if (myRightSprite->getOpacity()!=0 && myLeftSprite->getOpacity()!=0) {
-                myLeftSprite->runAction(CCFadeOut::create(1));
-                myRightSprite->runAction(CCFadeOut::create(1));
-            }
-        }
-            break;
-        default:
-            break;
+  
+  // èƒŒæ™¯
+  char all_bg[8][4] = {"010", "030", "204", "701", "717", "725", "732"};
+  char bg_num[4]="000";
+  int curLine = reader.getCurLine();
+  sprintf(bg_num, "%c%02d", current, curLine);
+  if (curLine == 0) {
+    CCSprite *Background = (CCSprite *)getChildByTag(108);
+    char bg_name[30]=BGNAME_IMG_PATH;
+    bg_name[BGNAME_PATH_LEN] = current;
+    Background->setTexture(CCTextureCache::sharedTextureCache()->addImage(bg_name));
+  } else {
+    for (int i =0; i<8; i++) {
+      if (strcmp(all_bg[i], bg_num)==0) {
+        CCSprite *Background = (CCSprite *)getChildByTag(108);
+        char bg_name[30]="";
+        sprintf(bg_name, BGNAME_IMG_PATH, bg_num);
+        Background->setTexture(CCTextureCache::sharedTextureCache()->addImage(bg_name));
+      }
     }
-    
-    // å‰§æœ¬åˆ‡æ¢åŠå®Œç»“åŠç‰¹æ•ˆ
-    switch (dialog[3]) {
-        case '1':{    // ä¿å­˜è¿›åº¦
-            current+=1;
-			CCEGLView::sharedOpenGLView()->setDesignResolutionSize(672, 448, kResolutionExactFit);
-            CCDirector::sharedDirector()->popScene();
-            // TODO: POP OUT
-        }
-            break;
-        case '2':{    // wanjie
-			CCSprite* staff_bg = CCSprite::create(STAFFBG_IMG_PATH);
-			staff_bg->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2 + CCDirector::sharedDirector()->getVisibleOrigin().x, CCDirector::sharedDirector()->getVisibleSize().height/2 + CCDirector::sharedDirector()->getVisibleOrigin().y));
-			addChild(staff_bg, 4);
+  }
+  
+  myDialog->setString(dialog+5);
+}
+// AVG: äººç‰©ç«‹ç»˜éƒ¨åˆ†
+void StoryWorld::characterPasterSwitchCase(int code) {
+  CCSpriteBatchNode *spriteBatch = (CCSpriteBatchNode *)getChildByTag(102);
+  CCSprite *myLeftSprite = (CCSprite *)spriteBatch->getChildByTag(1);
+  CCSprite *myRightSprite = (CCSprite *)spriteBatch->getChildByTag(2);
+  
+  switch (dialog[0]) {
+    case '0': {   //æ— äºº
+      char b[10]="me_ .png";
+      b[3] = dialog[1]+1;
+      myLeftSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+      
+    case '1': {   //ME
+      char b[10]="me_ .png";
+      b[3] = dialog[1]+1;
+      myLeftSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '2': {   //å­è½©
+      char b[10]="zx_ .png";
+      b[3] = dialog[1]+1;
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '3': {   //å°‘æ°
+      char b[10]="sj_ .png";
+      b[3] = dialog[1];
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '4': {   //å»ºå›½
+      char b[10]="jg_ .png";
+      b[3] = dialog[1];
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '5': {
+      char b[10]="la_ .png";
+      b[3] = dialog[1];
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '6': {
+      char b[10]="lb_ .png";
+      b[3] = dialog[1];
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '7': {
+      char b[10]="lc_ .png";
+      b[3] = dialog[1];
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '8': {
+      char b[10]="yy_ .png";
+      b[3] = dialog[1];
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+    case '9': {
+      char b[10]="jj_ .png";
+      b[3] = dialog[1];
+      myRightSprite->setDisplayFrame(CCSpriteFrameCache::sharedSpriteFrameCache()->spriteFrameByName(b));
+    }
+      break;
+      
+    default:
+      break;
+  }
+}
 
-			CCSprite* staff = CCSprite::create(STAFF_IMG_PATH );
-			staff->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, -CCDirector::sharedDirector()->getVisibleSize().height/2));
-			addChild(staff, 5);
 
-			CCActionInterval * moveTo = CCMoveTo::create(20,ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height*3/2));
-			CCFiniteTimeAction*  sequneceAction = CCSequence::create(
-				moveTo,
-				CCCallFunc::create(this, callfunc_selector(StoryWorld::over)),
-				NULL);
+// AVG: ç‰¹æ®Šéƒ¨åˆ†å¤„ç†ï¼Œå«å‰§æœ¬åˆ‡æ¢ï¼Œä¿å­˜ç­‰
+void StoryWorld::specialPartSwitchCase(int code) {
+  switch (code) {
+    case '1':{    // å‰§æœ¬ç»“æŸï¼Œç¡®è®¤ä¸‹ä¸€ä¸ªåœ°ç‚¹
+      setTouchEnabled(false);
+      CCSprite *back = CCSprite::create(CONFIRM_BACKGROUND_IMG_PATH);
+      back->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/2));
+      back->setTag(3);
+      addChild(back, 3);
+      
+      // Workspace
+      CCLabelTTF *nextPlaceName = CCLabelTTF::create("", "Heiti SC", 48);
+      nextPlaceName->setString(dialog+5);
+      nextPlaceName->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 3.1));
+      back->addChild(nextPlaceName);
+      
+      CCMenuItemImage *confirmBtn = CCMenuItemImage::create(CONFIRM_BUTTOM_IMG_PATH, CONFIRM_BUTTOM_IMG_PATH, this, menu_selector(StoryWorld::confirmButtonHandler));
+      confirmBtn->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/5 * 1.2));
+      CCMenu *menu = CCMenu::create(confirmBtn, NULL);
+      menu->setPosition(CCPointZero);
+      menu->setTag(2);
+      addChild(menu, 3);
+    }
+      break;
+    case '2':{    
+      CCSprite* staff_bg = CCSprite::create(STAFFBG_IMG_PATH);
+      staff_bg->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2 + CCDirector::sharedDirector()->getVisibleOrigin().x, CCDirector::sharedDirector()->getVisibleSize().height/2 + CCDirector::sharedDirector()->getVisibleOrigin().y));
+      addChild(staff_bg, 4);
+      
+      CCSprite* staff = CCSprite::create(STAFF_IMG_PATH);
+      staff->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, -CCDirector::sharedDirector()->getVisibleSize().height/2));
+      addChild(staff, 5);
+      
+      CCActionInterval * moveTo = CCMoveTo::create(20,ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height*3/2));
+      CCFiniteTimeAction*  sequneceAction = CCSequence::create(moveTo, CCCallFunc::create(this, callfunc_selector(StoryWorld::gameOverAndBackToWelcome)), NULL);
+      
+      staff->runAction(sequneceAction);
+    }
+      break;
+    case '3':{
+      CCSprite *black = CCSprite::create(BLACK_IMG_PATH);
+      black->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/2));
+      black->setOpacity(0);
+      addChild(black, 4);
+      black->runAction(CCSequence::create(CCFadeIn::create(0.5), CCFadeOut::create(0.5), NULL));
+    }
+      break;
+    default:
+      break;
+  }
+}
 
-			staff->runAction(sequneceAction);
-        }
-            break;
-        case '3':{
-            CCSprite *black = CCSprite::create(BLACK_IMG_PATH);
-            black->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/2));
-            black->setOpacity(0);
-            addChild(black, 4);
-            black->runAction(CCSequence::create(CCFadeIn::create(0.5), CCFadeOut::create(0.5), NULL));
-        }
-            break;
-        default:
-            break;
+// AVG: éŸ³æ•ˆå¤„ç†éƒ¨åˆ†
+void StoryWorld::audioSwitchCase(int code) {
+  switch (code) {
+    case '1':
+    case '2':
+    case '3':
+    case '4':
+    case '5':
+    case '6':{
+      char musicName[7] = " .mp3";
+      musicName[0] = dialog[4];
+      if (CocosDenshion::SimpleAudioEngine::sharedEngine()->isBackgroundMusicPlaying()) {
+        CocosDenshion::SimpleAudioEngine::sharedEngine()->stopBackgroundMusic(true);
+      }
+      CocosDenshion::SimpleAudioEngine::sharedEngine()->preloadBackgroundMusic(CCFileUtils::sharedFileUtils()->fullPathForFilename(musicName).c_str());
+      CocosDenshion::SimpleAudioEngine::sharedEngine()->playBackgroundMusic(CCFileUtils::sharedFileUtils()->fullPathForFilename(musicName).c_str(), true);
     }
-    
-    //éŸ³æ•ˆ
-    switch (dialog[4]) {
-        case '1': case '2': case '3': case '4': case '5':
-        case '6':{
-            char musicName[7] = " .mp3";
-            musicName[0] = dialog[4];
-            if (CocosDenshion::SimpleAudioEngine::sharedEngine()->isBackgroundMusicPlaying()) {
-                CocosDenshion::SimpleAudioEngine::sharedEngine()->stopBackgroundMusic(true);
-            }
-            CocosDenshion::SimpleAudioEngine::sharedEngine()->preloadBackgroundMusic(CCFileUtils::sharedFileUtils()->fullPathForFilename(musicName).c_str());
-            CocosDenshion::SimpleAudioEngine::sharedEngine()->playBackgroundMusic(CCFileUtils::sharedFileUtils()->fullPathForFilename(musicName).c_str(), true);
-        }
-            break;
-        case '7': {
-            CocosDenshion::SimpleAudioEngine::sharedEngine()->stopBackgroundMusic(true);
-        }
-            break;
-        case '8': case '9': case 'A': case 'B': case 'C': case 'D':
-        case 'G':{
-            char effectName[7] = " .wav";
-            effectName[0] = dialog[4];
-            
-            CocosDenshion::SimpleAudioEngine::sharedEngine()->preloadEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
-            CocosDenshion::SimpleAudioEngine::sharedEngine()->playEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
-        }
-            break;
-        case 'E': case 'F': 
-        case 'H':{
-            char effectName[7] = " .mp3";
-            effectName[0] = dialog[4];
-            
-            CocosDenshion::SimpleAudioEngine::sharedEngine()->preloadEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
-            CocosDenshion::SimpleAudioEngine::sharedEngine()->playEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
-        }
-            break;
-        default:
-            break;
+      break;
+    case '7': {
+      CocosDenshion::SimpleAudioEngine::sharedEngine()->stopBackgroundMusic(true);
     }
-    
-    // èƒŒæ™¯
-    char all_bg[8][4] = {"010", "030", "204", "701", "717", "725", "732"};
-    char bg_num[4]="000";
-    int curLine = reader.getCurLine();
-    sprintf(bg_num, "%c%02d", current, curLine);
-    if (curLine == 0) {
-        CCSprite *Background = (CCSprite *)getChildByTag(108);
-        char bg_name[30]=BGNAME_IMG_PATH;
-        bg_name[BGNAME_PATH_LEN] = current;
-        Background->setTexture(CCTextureCache::sharedTextureCache()->addImage(bg_name));
-    } else {
-        for (int i =0; i<8; i++) {
-            if (strcmp(all_bg[i], bg_num)==0) {
-                CCSprite *Background = (CCSprite *)getChildByTag(108);
-                char bg_name[30]="img/story/bg_000.jpg";
-                sprintf(bg_name, "img/story/bg_%s.jpg", bg_num);
-                Background->setTexture(CCTextureCache::sharedTextureCache()->addImage(bg_name));
-            }
-        }
+      break;
+    case '8':
+    case '9':
+    case 'A':
+    case 'B':
+    case 'C':
+    case 'D':
+    case 'G':{
+      char effectName[7] = " .wav";
+      effectName[0] = dialog[4];
+      
+      CocosDenshion::SimpleAudioEngine::sharedEngine()->preloadEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
+      CocosDenshion::SimpleAudioEngine::sharedEngine()->playEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
+    }
+      break;
+    case 'E':
+    case 'F':
+    case 'H':{
+      char effectName[7] = " .mp3";
+      effectName[0] = dialog[4];
+      
+      CocosDenshion::SimpleAudioEngine::sharedEngine()->preloadEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
+      CocosDenshion::SimpleAudioEngine::sharedEngine()->playEffect(CCFileUtils::sharedFileUtils()->fullPathForFilename(effectName).c_str());
     }
-    myDialog->setString(dialog+5);
+      break;
+      
+    default:
+      break;
+  }
 }
 
-void StoryWorld::makeAChoice(CCObject *sender) {
-    int choice = ((CCNode *)sender)->getTag();
-    if (current == '3') {
-        switch (choice) {
-            case fChoice: {
-                // æ˜¾ç¤ºå®£ä¼ å•ä¸€
-                cout << "xuanchuan " << endl;
-                removeChildByTag(2);
-                removeChildByTag(3);
-                CCSprite *blackBG = CCSprite::create(BLACK_IMG_PATH);
-                blackBG->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/2));
-                blackBG->setScale(1);
-                blackBG->setTag(21);
-                addChild(blackBG, 2);
-                // TODO
-                CCLabelTTF *xuanchuan = CCLabelTTF::create();
-                xuanchuan->setPosition(ccp(0, 40));
-                xuanchuan->setHorizontalAlignment(kCCTextAlignmentLeft);
-                xuanchuan->setAnchorPoint(CCPointZero);
-                xuanchuan->setDimensions(CCSizeMake(1100, 0));
-                xuanchuan->setTag(22);
-                addChild(xuanchuan, 3);
-                
-                // å…³é—­æŒ‰é’®
-                CCMenuItemImage *start = CCMenuItemImage::create(LEAFLET_IMG_PATH,
-                                                                 LEAFLET_IMG_PATH,
-                                                                 this,
-                                                                 menu_selector(StoryWorld::menuLeafletsCloseCallback));
-                
-                start->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width-40, CCDirector::sharedDirector()->getVisibleSize().height-40));
-                
-                //èœå•
-                CCMenu* pMenu = CCMenu::create(start, NULL);
-                pMenu->setPosition(CCPointZero);
-                pMenu->setTag(23);
-                addChild(pMenu, 4);
-                
-                
-            }
-                return;
-            case sChoice:
-			default:{
-				current+=1;
-				CCEGLView::sharedOpenGLView()->setDesignResolutionSize(480, 320, kResolutionExactFit);
-				CCDirector::sharedDirector()->popScene();
-            }
-                return;
-        }
+//
+void StoryWorld::theFinalChoiceHandler(CCObject *sender) {
+  int choice = ((CCNode *)sender)->getTag();
+  char fileName[FINAL_SCRIPT_PATH_LEN*2] = FINAL_SCRIPT_PATH;
+  switch (choice) {
+    case fChoice:
+      fileName[FINAL_SCRIPT_PATH_LEN]='1';
+      break;
+    case sChoice:
+      fileName[FINAL_SCRIPT_PATH_LEN]='2';
+      break;
+    case tChoice:
+      fileName[FINAL_SCRIPT_PATH_LEN]='3';
+      break;
+      
+    default:
+      break;
+  }
+  reader.ChangeFile(cocos2d::CCFileUtils::sharedFileUtils()->fullPathForFilename(fileName));
+  
+  removeChildByTag(2);
+  removeChildByTag(3);
+  setTouchEnabled(true);
+  
+  avgGame();
+}
+
+// å®£ä¼ å•é€‰æ‹©å¤„ç†
+void StoryWorld::leafletChoiceHandler(CCObject *sender) {
+  int choice = ((CCNode *)sender)->getTag();
+  switch (choice) {
+    case fChoice: {
+      // æ˜¾ç¤ºå®£ä¼ å•ä¸€
+      removeChildByTag(2);
+      removeChildByTag(3);
+      
+      CCSprite *blackBG = CCSprite::create(LEAFLET_IMG_PATH);
+      blackBG->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width/2, CCDirector::sharedDirector()->getVisibleSize().height/2));
+      blackBG->setScale(1);
+      blackBG->setTag(21);
+      addChild(blackBG, 2);
+      
+      // å…³é—­æŒ‰é’®
+      CCMenuItemImage *start = CCMenuItemImage::create(LEAFLET_CLOSE_IMG_PATH, LEAFLET_CLOSE_IMG_PATH, this, menu_selector(StoryWorld::menuLeafletsCloseCallback));
+      
+      start->setPosition(ccp(CCDirector::sharedDirector()->getVisibleSize().width-40, CCDirector::sharedDirector()->getVisibleSize().height-40));
+      
+      //èœå•
+      CCMenu* pMenu = CCMenu::create(start, NULL);
+      pMenu->setPosition(CCPointZero);
+      pMenu->setTag(23);
+      addChild(pMenu, 4);
     }
-    char fileName[8] = "Fin ";
-    
-    switch (choice) {
-        case fChoice:
-            fileName[3]='1';
-            break;
-        case sChoice:
-            fileName[3]='2';
-            break;
-        case tChoice:
-            fileName[3]='3';
-            break;
-        default:
-            break;
+      return;
+    case sChoice:
+    default:{
+      specialPartSwitchCase('1');
     }
-    reader.ChangeFile(cocos2d::CCFileUtils::sharedFileUtils()->fullPathForFilename(fileName));
-    
-    removeChildByTag(2);
-    removeChildByTag(3);
-    setTouchEnabled(true);
-    
-    avgGame();
+      return;
+  }
+}
+
+
+// 
+void StoryWorld::gameOverAndBackToWelcome() {
+  CCScene *welcome = Welcome::scene();
+  CCTransitionCrossFade *backToWelcome = CCTransitionCrossFade::create(0.7, welcome);
+  CCDirector::sharedDirector()->replaceScene(backToWelcome);
 }
 
-void StoryWorld::over() {
-	CCScene *welcome = Welcome::scene();
-	CCTransitionCrossFade *backToWelcome = CCTransitionCrossFade::create(0.7, welcome);
-	CCDirector::sharedDirector()->replaceScene(backToWelcome);
+
+//
+void StoryWorld::saveProcessAndPopOut() {
+  current+=1;
+  CCUserDefault::sharedUserDefault()->setIntegerForKey("Process", current-'0');
+  CCUserDefault::sharedUserDefault()->flush();
+  CCEGLView::sharedOpenGLView()->setDesignResolutionSize(672, 448, kResolutionExactFit);
+  
+  CCDirector::sharedDirector()->popScene();
 }
 
+//
 void StoryWorld::menuLeafletsCloseCallback(CCObject* sender) {
-    removeChildByTag(21);
-    removeChildByTag(22);
-    removeChildByTag(23);
-    setTouchEnabled(true);
-    current+=1;
-    CCUserDefault::sharedUserDefault()->setIntegerForKey("Process", current);
-    CCUserDefault::sharedUserDefault()->flush();
-	CCEGLView::sharedOpenGLView()->setDesignResolutionSize(480, 320, kResolutionExactFit);
-	CCDirector::sharedDirector()->popScene();
+  removeChildByTag(21);
+  removeChildByTag(22);
+  removeChildByTag(23);
+  setTouchEnabled(true);
+  //
+  specialPartSwitchCase('1');
+}
+
+void StoryWorld::confirmButtonHandler(CCObject *sender) {
+  saveProcessAndPopOut();
 }
 
+//
 void StoryWorld::menuCloseCallback(CCObject* pSender) {
 #if (CC_TARGET_PLATFORM == CC_PLATFORM_WINRT) || (CC_TARGET_PLATFORM == CC_PLATFORM_WP8)
-	CCMessageBox("You pressed the close button. Windows Store Apps do not implement a close button.","Alert");
+  CCMessageBox("You pressed the close button. Windows Store Apps do not implement a close button.","Alert");
 #else
-    CCDirector::sharedDirector()->end();
+  CCDirector::sharedDirector()->end();
 #if (CC_TARGET_PLATFORM == CC_PLATFORM_IOS)
-    exit(0);
+  exit(0);
 #endif
 #endif
 }
diff --git a/Classes/Story.h b/Classes/Story.h
old mode 100644
new mode 100755
index 18b53af..7398b25
--- a/Classes/Story.h
+++ b/Classes/Story.h
@@ -4,7 +4,6 @@
 #include "cocos2d.h"
 #include "AppMacros.h"
 #include "PlayReader.h"
-#include "CombatScene.h"
 #include "SimpleAudioEngine.h"
 #include "Welcome.h"
 #include <vector>
@@ -12,27 +11,30 @@
 class StoryWorld : public cocos2d::CCLayer
 {
 public:
-    virtual bool init();  
-
-    static cocos2d::CCScene* scene();
-    
-    CREATE_FUNC(StoryWorld);
+  virtual bool init();
+  
+  static cocos2d::CCScene* scene();
+  
+  CREATE_FUNC(StoryWorld);
 protected:
-    enum allChoice {fChoice = 10, sChoice, tChoice};
-    void menuCloseCallback(CCObject* pSender);
-    void ccTouchesEnded(cocos2d::CCSet *pTouches, cocos2d::CCEvent *pEvent);
-    void makeAChoice(CCObject *sender);
-    void menuLeafletsCloseCallback(CCObject* sender);
-    void avgGame(void);
-    void saveProcess();
-    void over() ;
-    char current;
-    char dialog[256];
-//    char theName[10][11]={"","ç©†å©§:", "å­è½©:", "å°‘æ°:", "å»ºå›½", "è·¯äººA:", "è·¯äººB:", "è·¯äººC:", "è€çˆ·çˆ·:", "æ±Ÿå§:"};
-//	char theName[10][11];
-	//std::vector<string> theName; 
-	PlayReader reader;
-//    ProcessSaver saver;
+  enum allChoice {fChoice = 10, sChoice, tChoice};
+  void menuCloseCallback(CCObject* pSender);
+  void ccTouchesEnded(cocos2d::CCSet *pTouches, cocos2d::CCEvent *pEvent);
+  void leafletChoiceHandler(CCObject *sender);
+  void theFinalChoiceHandler(CCObject *sender);
+  void confirmButtonHandler(CCObject *sender);
+  void menuLeafletsCloseCallback(CCObject* sender);
+  
+  void avgGame(void);
+  void characterPasterSwitchCase(int code);
+  void specialPartSwitchCase(int code);
+  void audioSwitchCase(int code);
+  
+  void saveProcessAndPopOut();
+  void gameOverAndBackToWelcome();
+  char current;
+  char dialog[512];
+  PlayReader reader;
 };
 
 #endif // __StoryWorld_SCENE_H__
diff --git a/Classes/TimeUtil.cpp b/Classes/TimeUtil.cpp
new file mode 100644
index 0000000..43abfc1
--- /dev/null
+++ b/Classes/TimeUtil.cpp
@@ -0,0 +1,35 @@
+#include "TimeUtil.h"
+
+int TimeUtil::getHour()
+{
+	int hour=8;
+#if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID || CC_TARGET_PLATFORM == CC_PLATFORM_IOS)
+	struct cc_timeval now;
+	CCTime::gettimeofdayCocos2d(&now,NULL);
+	struct tm* tmm = localtime((const time_t*)&now.tv_sec);
+	if(tmm!=NULL) hour = tmm->tm_hour;
+#elif ( CC_TARGET_PLATFORM == CC_PLATFORM_WIN32 )
+	time_t timep;
+	time(&timep);
+	struct tm* tmm = localtime(&timep);
+	if (tmm != NULL) hour = tmm->tm_hour;
+#endif
+	return hour;
+}
+
+int TimeUtil::getWeekDay()
+{
+	int weekday=0;
+#if (CC_TARGET_PLATFORM == CC_PLATFORM_ANDROID || CC_TARGET_PLATFORM == CC_PLATFORM_IOS)
+	struct cc_timeval now;
+	CCTime::gettimeofdayCocos2d(&now,NULL);
+	struct tm* tmm = localtime((const time_t*)&now.tv_sec);
+	if(tmm!=NULL) weekday = tmm->tm_wday;
+#elif ( CC_TARGET_PLATFORM == CC_PLATFORM_WIN32 )
+	time_t timep;
+	time(&timep);
+	struct tm* tmm = localtime(&timep);
+	if (tmm != NULL) weekday = tmm->tm_wday;
+#endif
+	return weekday;
+}
diff --git a/Classes/TimeUtil.h b/Classes/TimeUtil.h
new file mode 100644
index 0000000..98a658e
--- /dev/null
+++ b/Classes/TimeUtil.h
@@ -0,0 +1,11 @@
+#ifndef __TIME_UTIL_H__
+#define __TIME_UTIL_H__
+#include "cocos2d.h"
+
+class TimeUtil
+{
+public:
+	static int getHour();
+	static int getWeekDay();
+};
+#endif
diff --git a/Classes/TouchScreen.cpp b/Classes/TouchScreen.cpp
index e7a722c..c102769 100644
--- a/Classes/TouchScreen.cpp
+++ b/Classes/TouchScreen.cpp
@@ -54,9 +54,9 @@ void TouchScreen::teleportTo(CCSet* pTouch, CCEvent *pEvent)
 	CCPoint mapTileMove=hero->map->humanPosForTileMove(mapTileCoord);
 
 	CCSequence* teleport=CCSequence::create(CCDelayTime::create(0.5f),
-		Animation::getAction(TELEPORTOUT,hero->getChildByTag(IMGSP)->getContentSize()),
+		AnimLib::getAction(TELEPORTOUT,hero->getChildByTag(IMGSP)->getContentSize()),
 		CCDelayTime::create(0.40f),
-		Animation::getAction(TELEPORTIN,hero->getChildByTag(IMGSP)->getContentSize()),
+		AnimLib::getAction(TELEPORTIN,hero->getChildByTag(IMGSP)->getContentSize()),
 		NULL);
 	CCScaleTo* mapLayerMove=CCScaleTo::create(0.5f,1.0f);
 	CCSequence* mapMove=CCSequence::create(CCDelayTime::create(0.5f),
diff --git a/Classes/TouchScreen.h b/Classes/TouchScreen.h
index 54d439a..4ee737c 100644
--- a/Classes/TouchScreen.h
+++ b/Classes/TouchScreen.h
@@ -5,6 +5,8 @@
 #include "AppMacros.h"
 #include "Button.h"
 #include "GlobalRes.h"
+#include "AnimLib.h"
+
 using namespace cocos2d;
 
 class TouchScreen: public Button
diff --git a/Classes/Welcome.cpp b/Classes/Welcome.cpp
index 1b158db..0f7c873 100644
--- a/Classes/Welcome.cpp
+++ b/Classes/Welcome.cpp
@@ -27,9 +27,10 @@ bool Welcome::init() {
 
 void Welcome::menuStartCallback(CCObject* pSender) {
 	CCEGLView::sharedOpenGLView()->setDesignResolutionSize(MAP_RESOLUWID,MAP_RESOLUHEI, kResolutionExactFit);
-	CCScene *pScene = HelloWorld::scene();
+	CCScene* pScene = Combat::scene();
+	//CCScene *pScene = HelloWorld::scene();
 	CCTransitionFade *scenetrans = CCTransitionFade::create(0.7, pScene);
-	CCDirector::sharedDirector()->replaceScene(scenetrans);
+	CCDirector::sharedDirector()->pushScene(scenetrans);
 }
 
 void Welcome::menuClearCallback(CCObject* pSender) {
diff --git a/Classes/Welcome.h b/Classes/Welcome.h
index a882cfc..f92089b 100644
--- a/Classes/Welcome.h
+++ b/Classes/Welcome.h
@@ -4,6 +4,7 @@
 #include "cocos2d.h"
 #include "GlobalState.h"
 #include "AppMacros.h"
+#include "CombatScene.h"
 using namespace cocos2d;
 //updateï¼š2014-10-1 15:59:03
 
diff --git a/Classes/desktop.ini b/Classes/desktop.ini
new file mode 100644
index 0000000..b70df33
--- /dev/null
+++ b/Classes/desktop.ini
@@ -0,0 +1,2 @@
+[.ShellClassInfo]
+IconResource=D:\ÔÆ¹Ü¼Ò\BaiduYunGuanjia\autobackup.ico,0
diff --git a/Resources/csv/event0.csv b/Resources/csv/event0.csv
deleted file mode 100644
index a2375dc..0000000
--- a/Resources/csv/event0.csv
+++ /dev/null
@@ -1,7 +0,0 @@
-x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,,,,
-1,1,1,1,1,0,1,-1,1,1,1,1,1,1,1,1,1,,,
-62,97,Î÷ÄÏÃÅ±£°²,2,0,0,7,4,0,3,1,0,1,ÊÇÐÂÉú°É,Çà´º¹ã³¡´ÓÕâÀïÒ»Ö±ÍùÇ°×ß¾ÍÊÇ,¿ìÈ¥±¨µÀ°É£¡,1,,,
-0,0,ÏÐÈË,3,2,0,8,-1,0,1,6,TRUE,64,95,64,91,64,95,ÎÒ×ß,1
-0,0,¿ª¹Ò,4,-1,1,-10,-1,0,0,0,0,,,,,,,,
-64,97,Ç°ÐòÊÂ¼þ,5,0,0,6,-1,1,1,1,1,È¥ÎÊ±£°²,2,2,,,,,
-63,99,Ñ§Ð£ÍâÌáÊ¾,6,-1,2,-1,-1,0,1,0,1,ÔÙÍâ±ß¾ÍÊÇÐ£ÃÅÍâÀ²,,,,,,,
diff --git a/Resources/csv/event100.csv b/Resources/csv/event100.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event100.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event101.csv b/Resources/csv/event101.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event101.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event102.csv b/Resources/csv/event102.csv
new file mode 100644
index 0000000..c123e4b
--- /dev/null
+++ b/Resources/csv/event102.csv
@@ -0,0 +1,2 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
+2,0,StrangeMan,100,1,0,1,-1,0,1,0,1,hello,
diff --git a/Resources/csv/event103.csv b/Resources/csv/event103.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event103.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event104.csv b/Resources/csv/event104.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event104.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event105.csv b/Resources/csv/event105.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event105.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event106.csv b/Resources/csv/event106.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event106.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event110.csv b/Resources/csv/event110.csv
new file mode 100644
index 0000000..381318c
--- /dev/null
+++ b/Resources/csv/event110.csv
@@ -0,0 +1,9 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,,,,
+1,1,1,1,1,0,1,-1,1,1,1,1,1,1,1,1,1,,,
+62,97,Î÷ÄÏÃÅ±£°²,2,0,0,7,4,0,3,1,0,1,ÊÇÐÂÉú°É,Çà´º¹ã³¡´ÓÕâÀïÒ»Ö±ÍùÇ°×ß¾ÍÊÇ,¿ìÈ¥±¨µÀ°É£¡,1,,,
+0,0,ÏÐÈË,3,2,0,8,-1,0,1,6,TRUE,64,95,64,91,64,95,ÎÒ×ß,1
+0,0,¿ª¹Ò,4,-1,1,-10,-1,0,0,0,0,,,,,,,,
+64,97,Ç°ÐòÊÂ¼þ,5,0,0,6,7,1,1,1,1,2,È¥ÎÊ±£°²,2,,,,,
+63,99,Ñ§Ð£ÍâÌáÊ¾,6,-1,2,-1,8,0,1,0,1,ÔÙÍâ±ß¾ÍÊÇÐ£ÃÅÍâÀ²,,,,,,,
+0,0,»ñµÃÄÐÓÑ,7,-1,3,-1,-1,0,0,1,0,1,,,,,,,
+0,0,go on,8,-1,4,-10,-1,0,0,0,1,
diff --git a/Resources/csv/event111.csv b/Resources/csv/event111.csv
new file mode 100644
index 0000000..0805959
--- /dev/null
+++ b/Resources/csv/event111.csv
@@ -0,0 +1,2 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres
+54,60,µØÍ¼¶þÉÏÈË,101,1,0,1,-1,0,1,0,1,Hola,,
diff --git a/Resources/csv/event200.csv b/Resources/csv/event200.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event200.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event201.csv b/Resources/csv/event201.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event201.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event202.csv b/Resources/csv/event202.csv
new file mode 100644
index 0000000..c475d77
--- /dev/null
+++ b/Resources/csv/event202.csv
@@ -0,0 +1,2 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
+0,2,StrangeMan,100,1,0,1,-1,0,1,0,1,hello,
diff --git a/Resources/csv/event203.csv b/Resources/csv/event203.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event203.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event204.csv b/Resources/csv/event204.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event204.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event205.csv b/Resources/csv/event205.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event205.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event206.csv b/Resources/csv/event206.csv
new file mode 100644
index 0000000..b4709dc
--- /dev/null
+++ b/Resources/csv/event206.csv
@@ -0,0 +1 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres,,
diff --git a/Resources/csv/event210.csv b/Resources/csv/event210.csv
new file mode 100644
index 0000000..0805959
--- /dev/null
+++ b/Resources/csv/event210.csv
@@ -0,0 +1,2 @@
+x,y,description,id,category,type,imgNo,next,nPreCondition,nDialog,nArgument,repeat,args,dialogs,pres
+54,60,µØÍ¼¶þÉÏÈË,101,1,0,1,-1,0,1,0,1,Hola,,
diff --git a/Resources/img/story/ConfirmBackground.png b/Resources/img/story/ConfirmBackground.png
new file mode 100644
index 0000000..40a703b
Binary files /dev/null and b/Resources/img/story/ConfirmBackground.png differ
diff --git a/Resources/img/story/ConfirmButton.png b/Resources/img/story/ConfirmButton.png
new file mode 100644
index 0000000..7116751
Binary files /dev/null and b/Resources/img/story/ConfirmButton.png differ
diff --git a/Resources/img/story/Landscape.png b/Resources/img/story/Landscape.png
new file mode 100755
index 0000000..c4e4ae5
Binary files /dev/null and b/Resources/img/story/Landscape.png differ
diff --git a/Resources/img/story/leaflet.png b/Resources/img/story/leaflet.png
new file mode 100644
index 0000000..4590a86
Binary files /dev/null and b/Resources/img/story/leaflet.png differ
diff --git a/Resources/img/story/leafletsclose.png b/Resources/img/story/leafletsclose.png
new file mode 100755
index 0000000..3702978
Binary files /dev/null and b/Resources/img/story/leafletsclose.png differ
diff --git a/Resources/img/story/staff.png b/Resources/img/story/staff.png
new file mode 100755
index 0000000..45ebc81
Binary files /dev/null and b/Resources/img/story/staff.png differ
diff --git a/Resources/img/story/staff_bg.png b/Resources/img/story/staff_bg.png
new file mode 100755
index 0000000..7a27c91
Binary files /dev/null and b/Resources/img/story/staff_bg.png differ
diff --git a/Resources/txt/Fin1 b/Resources/txt/Fin1
new file mode 100644
index 0000000..5818bb3
--- /dev/null
+++ b/Resources/txt/Fin1
@@ -0,0 +1,16 @@
+10300æˆ‘æ€€ç€ç´§å¼ å’ŒæœŸå¾…çš„å¿ƒæƒ…ï¼Œé©¬ä¸åœè¹„çš„è·‘å‘çº¦å®šçš„åœ°ç‚¹--ä¸é«˜å±±
+11000å•Šï¼Œç»ˆäºŽåˆ°äº†ï¼Œå‰é¢çš„äººå½±æ˜¯---------
+21400ï¼ï¼ï¼ï¼ï¼æ˜¯å­è½©ï¼ï¼ï¼
+10000æ€Žä¹ˆå›žäº‹ï¼Ÿä»€ä¹ˆæ—¶å€™æˆ‘çš„æ„å¿µåŠ›è¿™ä¹ˆå¼ºå¤§äº†å—ï¼Ÿç«Ÿç„¶éƒ½å¿ƒæƒ³äº‹æˆäº†ï¼ï¼
+10009å¥½ç´§å¼ å‘€ï¼Œä»–ä¼šè¯´ä»€ä¹ˆï¼Ÿ
+25000ä¸«å¤´ï¼Œä½ æ—¢ç„¶æ¥äº†ï¼Œå°±æ˜¯é»˜è®¤ç­”åº”åšæˆ‘å¥³æœ‹å‹äº†å“¦ï¼Ÿ
+13000ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
+27000å¤ªå¥½äº†ï¼ï¼è€å­ç»ˆäºŽè„±å•äº†ï¼ï¼å¦ˆå¦ˆå†ä¹Ÿä¸ç”¨æ‹…å¿ƒæˆ‘çš„æ€§å–å‘ï¼
+16000è¿™è´§æ˜¯æ¥æžç¬‘çš„å˜›ã€‚ã€‚ã€‚å¥½æƒ³åæ§½ã€‚ã€‚ã€‚ã€‚æ€»è§‰å¾—ä¼šå¾ˆä¸é è°±çš„è¯´ã€‚ã€‚ã€‚ã€‚ã€‚
+12000ä½ æƒ³å¾—å¤ªç¾Žäº†å§ï¼Ÿå“ªæœ‰åˆšè®¤è¯†ä¸€å¤©å°±äº¤å¾€ï¼ï¼ï¼
+26000è¯¶ï¼Ÿã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
+16000æˆ‘çœ‹å‘å¯¹é¢éœ²å‡ºèŒ«ç„¶å¯çˆ±è¡¨æƒ…çš„ç”·ç”Ÿï¼Œçªç„¶è§‰å¾—çŽ°åœ¨è¿™æ ·çœŸçš„æ˜¯æœ€å¥½çš„ç»“å±€)
+26000ä½ æ€Žä¹ˆäº†ï¼ŸXXï¼Œå¹²å˜›ä¸€ç›´å‘å‘†ã€‚ã€‚
+15000æ²¡äº‹ï¼Œé™ªæˆ‘åŽ»å±±é‡Œé€›é€›å§~
+21000å“¦ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
+00520ç”»é¢æ¸æ¸è½¬é»‘ã€‚ã€‚ã€‚ã€‚
\ No newline at end of file
diff --git a/Resources/txt/Fin2 b/Resources/txt/Fin2
new file mode 100644
index 0000000..12e87c6
--- /dev/null
+++ b/Resources/txt/Fin2
@@ -0,0 +1,19 @@
+10000æˆ‘æ€€ç€ç´§å¼ å’ŒæœŸå¾…çš„å¿ƒæƒ…ï¼Œé©¬ä¸åœè¹„çš„è·‘å‘çº¦å®šçš„åœ°ç‚¹--ä¸é«˜å±±
+11000å•Šï¼Œç»ˆäºŽåˆ°äº†ï¼Œå‰é¢çš„äººå½±æ˜¯---------
+31400ï¼ï¼ï¼ï¼ï¼æ˜¯å°‘æ°ï¼ï¼ï¼
+10000æ€Žä¹ˆå›žäº‹ï¼Ÿä»€ä¹ˆæ—¶å€™æˆ‘çš„æ„å¿µåŠ›è¿™ä¹ˆå¼ºå¤§äº†å—ï¼Ÿç«Ÿç„¶éƒ½å¿ƒæƒ³äº‹æˆäº†ï¼ï¼
+10009å¥½ç´§å¼ å‘€ï¼Œä»–ä¼šè¯´ä»€ä¹ˆï¼Ÿ
+30000å°‘æ°ç¼“ç¼“åœ°å¼€å£äº†ï¼Œæ¸…å†½çš„å£°éŸ³æµæ·Œç€-
+35000æˆ‘ä¸çŸ¥é“ä½ æ€€ç€ä½•ç§å¿ƒæƒ…è€Œæ¥â€”â€”
+31000ä½†ä½ è‚¯å®šä¼šå¯¹è¿™ä¸ªåªæœ‰ä¸€é¢ä¹‹ç¼˜çš„å‘Šç™½å……æ»¡äº†æ€€ç–‘ï¼Œè€Œæˆ‘æƒ³è¯´çš„æ˜¯â€”â€”
+36000æˆ‘æ¯å¤©é‡è§ä¸åŒçš„äººï¼Œç»åŽ†ä¸åŒçš„æ•…äº‹ï¼Œä½†ä»Šå¤©ï¼Œæˆ‘åªç›¸ä¿¡æˆ‘è‡ªå·±çš„æ„Ÿè§‰ï¼Œä½ å°±æ˜¯æˆ‘æ ¡å›­æ•…äº‹é‡Œçš„å…¬ä¸»â€”â€”
+32000å°±è®©æ—¶é—´åŽ»è¯æ˜Žä¸€åˆ‡å§ã€‚ã€‚ã€‚ã€‚ã€‚
+10000å¬ç€å°‘æ°æ·±æƒ…çš„è‡ªç™½ï¼Œæˆ‘æ„Ÿè§‰å¿ƒéƒ½æ¹¿æ¶¦äº†ã€‚ã€‚ã€‚ã€‚ã€‚
+12000æˆ‘æ„¿æ„ï¼
+16000è™½ç„¶ä»Žå°åˆ°å¤§ï¼Œé™¤äº†æ€é©¬ç‰¹å…¬ä¸»ï¼Œæˆ‘å°±å†ä¹Ÿæ²¡æœ‰è¢«è¢«äººå«åšå…¬ä¸»äº†ã€‚ã€‚ã€‚ã€‚ã€‚
+33000å•Š?
+16000æˆ‘çœ‹å‘å¯¹é¢éœ²å‡ºèŒ«ç„¶å¯çˆ±è¡¨æƒ…çš„ç”·ç”Ÿï¼Œçªç„¶è§‰å¾—çŽ°åœ¨è¿™æ ·çœŸçš„æ˜¯æœ€å¥½çš„ç»“å±€
+33000ä½ æ€Žä¹ˆäº†ï¼Ÿç©†å©§ï¼Œå¹²å˜›ä¸€ç›´å‘å‘†ã€‚ã€‚
+15000æ²¡äº‹ï¼Œé™ªæˆ‘åŽ»å±±é‡Œé€›é€›å§
+36000å“¦ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
+00520ç”»é¢æ¸æ¸è½¬é»‘ã€‚ã€‚ã€‚ã€‚
\ No newline at end of file
diff --git a/Resources/txt/Fin3 b/Resources/txt/Fin3
new file mode 100644
index 0000000..fe6ef15
--- /dev/null
+++ b/Resources/txt/Fin3
@@ -0,0 +1,16 @@
+10300æˆ‘æ€€ç€ç´§å¼ å’ŒæœŸå¾…çš„å¿ƒæƒ…ï¼Œé©¬ä¸åœè¹„çš„è·‘å‘çº¦å®šçš„åœ°ç‚¹--ä¸é«˜å±±
+11000å•Šï¼Œç»ˆäºŽåˆ°äº†ï¼Œå‰é¢çš„äººå½±æ˜¯---------
+41400ï¼ï¼ï¼ï¼ï¼æ˜¯å»ºå›½ï¼ï¼ï¼
+10000æ€Žä¹ˆå›žäº‹ï¼Ÿä»€ä¹ˆæ—¶å€™æˆ‘çš„æ„å¿µåŠ›è¿™ä¹ˆå¼ºå¤§äº†å—ï¼Ÿç«Ÿç„¶éƒ½å¿ƒæƒ³äº‹æˆäº†ï¼ï¼
+10009å¥½ç´§å¼ å‘€ï¼Œä»–ä¼šè¯´ä»€ä¹ˆï¼Ÿ
+43000é‚£ä¸ªã€‚ã€‚ã€‚ã€‚ä¸å¥½æ„æ€å•Šï¼Œè¿™æ¡çŸ­ä¿¡æ˜¯æˆ‘ä»¬å¯çŽ©çœŸå¿ƒè¯å¤§å†’é™©è¢«æŸå‹é€¼ç€å‘çš„ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å®³ä½ ç™½è·‘ä¸€è¶Ÿï¼Œéžå¸¸æŠ±æ­‰ï¼
+10000æ€Žä¹ˆä¼šæ˜¯è¿™æ ·ï¼ï¼ï¼åŽŸæ¥æžœç„¶æ˜¯æˆ‘è‡ªä½œå¤šæƒ…å—ã€‚ã€‚ã€‚ã€‚ã€‚
+42000ä½ åƒä¸‡åˆ«å“­å•Šï¼ï¼éƒ½æ˜¯æˆ‘ä¸å¥½ã€‚ã€‚ã€‚è¿™æ˜¯ã€‚ã€‚ã€‚ã€‚æˆ‘ä¸“é—¨ç»™ä½ ä¹°çš„èŠ±ï¼Œå¸Œæœ›ä½ ä¸è¦åœ¨æ„å•Šã€‚ã€‚ã€‚
+10000ç™½çŽ«ç‘°ã€‚ã€‚ã€‚è¿˜çœŸæ˜¯ç”¨å¿ƒçš„ç¤¼ç‰©å‘ï¼Ÿå“ˆå“ˆï¼Œæ¥æ—¥æ–¹é•¿ã€‚ã€‚ã€‚ã€‚
+16000è¯´ï¼è¿™çŸ­ä¿¡çœŸæ˜¯çŽ©å¤§å†’é™©å‘çš„ï¼Ÿ
+46000æ©æ©ï¼Œæˆ‘å’‹æ•¢éª—ä½ å•Šã€‚ã€‚ã€‚ã€‚ã€‚
+16000æˆ‘çœ‹å‘å¯¹é¢éœ²å‡ºèŒ«ç„¶å¯çˆ±è¡¨æƒ…çš„ç”·ç”Ÿï¼Œçªç„¶è§‰å¾—çŽ°åœ¨è¿™æ ·çœŸçš„æ˜¯æœ€å¥½çš„ç»“å±€)
+42000ä½ æ€Žä¹ˆäº†ï¼Ÿç©†å©§ï¼Œå¹²å˜›ä¸€ç›´å‘å‘†ã€‚ã€‚
+15000æ²¡äº‹ï¼Œé™ªæˆ‘åŽ»å±±é‡Œé€›é€›å§~
+46000å“¦ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
+00520ç”»é¢æ¸æ¸è½¬é»‘ã€‚ã€‚ã€‚ã€‚
\ No newline at end of file
diff --git a/Resources/txt/Script0 b/Resources/txt/Script0
new file mode 100644
index 0000000..e0c6812
--- /dev/null
+++ b/Resources/txt/Script0
@@ -0,0 +1,35 @@
+11301ç»ˆäºŽåˆ°å•¦ï¼ï¼ä¼ è¯´ä¸­çš„å››å·å¤§å­¦~
+11030è¯¶ï¼Œæžœç„¶æ˜¯å¥½å£®è§‚çš„å¤§é—¨å•Š
+10000èƒŒæ™¯æ¸è¿›ï¼ˆè„šæ­¥å£°ï¼‰
+10000å¯æ˜¯è¦å¾€å“ªé‡Œèµ°å‘¢ï¼Ÿ
+21400é˜¿æ‹‰~å¯çˆ±çš„å­¦å¦¹ä½ å¥½å•Šï¼Œæˆ‘æ˜¯å­è½©ï¼Œéœ€è¦å¸®å¿™å—?
+11000ï¼ˆçœŸæ˜¯é˜³å…‰çš„ç¬‘å®¹é‚£ï¼Œè¿žå¸¦ç€çƒ¦èºçš„å¿ƒæƒ…éƒ½è·Ÿç€å˜å¥½äº†ï¼‰
+10000é‚£ä¸ªï¼ŒçœŸæ˜¯éº»çƒ¦äº†ï¼Œæˆ‘æ˜¯ç©†å©§
+10000å¯ä»¥å‘Šè¯‰æˆ‘è®¡ç®—æœºå­¦é™¢çš„çš„æŠ¥åˆ°åœ°ç‚¹å—ï¼Ÿ
+20000è®¡ç®—æœºå­¦é™¢ã€‚ã€‚å—ï¼Ÿ
+20000çœŸæ˜¯å·§äº†ï¼Œæˆ‘ä¹Ÿæ˜¯è®¡é™¢çš„å“¦ï¼Œå¹²è„†æˆ‘å¸¦ä½ è¿‡åŽ»å§ï¼Œå°±åœ¨å‰é¢çš„é’æ˜¥å¹¿åœºä¸Šã€‚
+24030è¿™é‡Œå°±æ˜¯è®¡ç®—æœºå­¦é™¢çš„æ‘Šä½äº†ï¼Œæˆ‘å¤§è®¡ç§‘äººæ‰æµŽæµŽ
+27030å°±æ˜¯è´¨é‡æœ‰ç‚¹å‚å·®ä¸é½å•Šï¼Œå‘µå‘µ
+22000å¥½äº†ï¼ŒåºŸè¯ä¸å¤šè¯´
+22000å¿«åˆ°å…¬å‘Šæ¿é‚£é‡Œçœ‹çœ‹ä½ åˆ†é…çš„å¯å®¤å’Œå°ä¼™ä¼´ä»¬å§
+13000å•Šï¼Œå’Œæˆ‘ä¸€ä¸ªå°å¯çš„æœ‰è·¯äººAï¼Œè·¯äººBï¼Œå’Œè·¯äººCã€‚ã€‚ã€‚ã€‚
+25000çœ‹åå­—å°±æ˜¯æ„Ÿè§‰å¾ˆå¥½ç›¸å¤„çš„äººå‘¢~
+20000ä¸åƒæˆ‘çš„é‚£å¸®ç‹æœ‹ç‹—å‹ï¼ŒçœŸæ˜¯ä¸€ä¸ªæ¯”ä¸€ä¸ªçŒ¥çã€‚ã€‚
+10000å•Šï¼Œè¯·å…è®¸æˆ‘åšä¸€ä¸ªæ‚²ä¼¤çš„è¡¨æƒ…~~
+21000å…‰é¡¾ç€èŠå¤©ï¼Œå·®ç‚¹æŠŠæ­£äº‹ç»™å¿˜äº†ï¼Œèµ¶ç´§æ‹¿å‡ºä½ é‡‘ç¿ç¿çš„å½•å–é€šçŸ¥ä¹¦æ¥é¢†å–ä½ çš„æ ¡å›­ä¸€å¡é€šå§
+25000æœ‰äº†è¿™ä¸ªå°±å¯ä»¥ç”¨å®ƒæ¥åƒé¥­ï¼Œæ´—æ¾¡å¤–åŠ é€šè¿‡é—¨ç¦äº†~
+20030ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å¥½äº†ï¼ï¼
+23000æ³¨å†Œå®Œä¹‹åŽï¼Œå°±æ˜¯è´­ä¹°å§å…·ç„¶åŽåŽ»çœ‹çœ‹å¯å®¤äº†ï¼Œå®¿èˆåŒºéƒ½åœ¨å•†ä¸šè¡—çš„è¿™è¾¹ï¼Œå¾ˆå¥½è¾¨è®¤ã€‚
+24000è¡ŒæŽæ‹¿æ¥ï¼Œæˆ‘æ¥æå§
+00000ï¼ˆå–˜æ°”å£°ï¼‰
+21000å’¿â€”â€”â€”â€”å—¬â€”â€”â€”â€”
+21030æˆ‘å‹’ä¸ªåŽ»~ä½ è¡ŒæŽç®±äº†é‡Œåˆ°åº•è£…äº†ä»€ä¹ˆå•Šï¼Œç´¯æ­»æœ•äº†
+11000é‚£ä¸ªã€‚ã€‚ã€‚ã€‚éº»éº»è¯´ä¸è¦éšä¾¿ä¹°å¤–é¢çš„è¡£æœ
+16000æ‰€ä»¥å°±ç»™æˆ‘è£…äº†å‡ å¥—å¿…å¤‡æ¬¾å¼ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
+10000(æ„Ÿè§‰æˆ‘çš„è¡ŒæŽç®±è¿˜æ˜¯å¾ˆæŒºæ­£å¸¸ä¸æ€Žä¹ˆé‡çš„è¯´ï¼Œå¥½å§æˆ‘ç»å¯¹ä¸ä¼šæ‰¿è®¤å¯¹é˜³å…‰ç¾Žå°‘å¹´çš„é„™è§†çš„)
+26000æ˜¯å—ï¼ŸçœŸå—ä¸äº†ä½ ä»¬å¥³ç”Ÿï¼Œèµ°å§ï¼Œä¸€ä¼šæˆ‘ä¸€å®šè¦å¤šåƒå‡ ä¸ªæ±‰å ¡
+10000(æ–‘é©³çš„æ ‘å½±ä¸‹ï¼ŒæŠ¬èµ·å¤´çœ‹å‘å­è½©ï¼Œè™½ç„¶è„¸ä¸Šæ»¡æ˜¯æ±—æ°´ï¼Œä½†é‚£ç¿çƒ‚çš„ç¬‘å®¹å°±å¦‚æš–æš–çš„é˜³å…‰å¡žæ»¡äº†æˆ‘çš„èƒ¸è†›)
+10000(çœŸæ˜¯ä¸€ä¸ªæ¸©æŸ”çš„äººå•Š~)
+12000é‚£ä¸ªï¼Œå­è½©å­¦é•¿ï¼Œå¯ä»¥ç»™æˆ‘ä½ çš„æ‰‹æœºå·å—ï¼Ÿæˆ‘æƒ³ã€‚ã€‚ã€‚ã€‚ä»¥åŽé‡åˆ°ä»€ä¹ˆé—®é¢˜ä¹Ÿæ¥é—®ä½ 
+25507æ²¡é—®é¢˜å•Šï¼Œå­¦å¦¹çš„è¯·æ±‚ä»Žæ¥ä¸ä¼šæ‹’ç»ï¼å¿«åŽ»ä½ çš„å®¿èˆçœ‹çœ‹å§ï¼Œåº”è¯¥æ˜¯21èˆï¼Œè¿™æ˜¯æ±Ÿå®‰æ ¡åŒºæœ€ååƒ»çš„å®¿èˆäº†
+00010
diff --git a/Resources/txt/Script1 b/Resources/txt/Script1
new file mode 100644
index 0000000..d14578c
--- /dev/null
+++ b/Resources/txt/Script1
@@ -0,0 +1,20 @@
+16301å“‡ï¼Œè¿™é‡Œå°±æ˜¯æˆ‘è¦ç”Ÿæ´»å››å¹´çš„åœ°æ–¹äº†å—
+10000å±…ç„¶æœ‰ç©ºè°ƒï¼Œé£Žæ‰‡ï¼Œè¿˜æœ‰æ¯äººä¸€ä¸ªçš„è¡£æŸœå’Œä¸ŠåºŠä¸‹æ¡Œï¼ï¼çœŸæ£’å‘
+10000(å®¤å‹ä»¬éƒ½å·²ç»åˆ°äº†å‘¢ï¼Œæˆ‘æžœç„¶åˆæ˜¯æœ€åŽä¸€ä¸ªã€‚ã€‚ã€‚)
+10000(å¥‡æ€ªäº†ï¼Œæˆ‘ä¸ºä»€ä¹ˆè¦è¯´ã€‚ã€‚ã€‚ã€‚â€˜åˆâ€™ï¼Ÿ)
+15000å¤§å®¶å¥½å•Š~æˆ‘æ˜¯ç©†å©§ï¼Œä»¥åŽè¯·å¤šå¤šå…³ç…§å•¦ï¼ï¼
+5440Aï¼ˆæ¸¸æˆè½°é¸£å£°ï¼‰æ³•å¸ˆï¼é”å®šé‚£ä¸ªäºšé©¬é€Šï¼ï¼ç‰§å¸ˆå¿«æ¥ç»™æˆ‘åŠ çº¢å•Šï¼ï¼ï¼ï¼
+11400ï¼ï¼ï¼ï¼
+61400çœ‹ä½ å°å ‚å‘é»‘ï¼Œæœ€è¿‘å¯èƒ½ä¼šé‡åˆ°ä»€ä¹ˆä¸å¥½çš„ä¸œè¥¿å•Šã€‚ã€‚ã€‚ã€‚
+10400å’³å’³ã€‚ã€‚ã€‚æ€»è§‰å¾—ä»ŠåŽçš„ç”Ÿæ´»åŽ‹åŠ›å¥½å¤§ã€‚ã€‚ã€‚
+71400å•Šï¼Œä½ å°±æ˜¯ç©†å©§å•Š
+10000å‘œå‘œï¼Œç»ˆäºŽæœ‰äººç†æˆ‘äº†ï¼Œæ›™å…‰å•Šæ›™å…‰ï¼ï¼
+15000æ˜¯çš„æ˜¯çš„ï¼ï¼
+76000æˆ‘ä¸€ç›´åœ¨æ€è€ƒå•Šï¼Œä¸ºä»€ä¹ˆä½ çš„åå­—æ„Ÿè§‰å’Œæˆ‘ä»¬çš„ä¸æ˜¯ä¸€ä¸ªç³»åˆ—çš„å‘¢ï¼Ÿ
+1000D= =å®Œå…¨ä¸æ˜¯æ­£å¸¸äººçš„å…³æ³¨ç‚¹å¥½å—ï¼éš¾é“è¿™ä¸ªå¯å®¤åªæœ‰æˆ‘ä¸æ­£å¸¸ã€‚ã€‚ã€‚ã€‚
+10000æ³ªã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚
+71000è¯è¯´ç©†å©§å›ï¼Œä½ åˆšæ¥è¿˜æ²¡æœ‰ä½“æ£€å§ï¼Œå¿«ç‚¹åŽ»æ ¡åŒ»é™¢å§ï¼Œä¸ç„¶äººä¸€å¤šæœ‰å¯èƒ½å¾ˆéº»çƒ¦å“¦ï¼
+11000çœŸçš„å—ï¼Ÿé‚£ä¹ˆæ€Žä¹ˆåŽ»å‘¢ï¼Ÿ
+71000é‚£å¹²è„†æˆ‘å¸¦ä½ åŽ»å§ï¼
+16507çœŸçš„å—ï¼Ÿä½ çœŸæ˜¯å¤ªå¥½äº†è€¶ï¼ï¼ï¼ï¼
+00010
\ No newline at end of file
diff --git a/Resources/txt/Script2 b/Resources/txt/Script2
new file mode 100644
index 0000000..0c8df25
--- /dev/null
+++ b/Resources/txt/Script2
@@ -0,0 +1,16 @@
+14306å•Šï¼Œäººå·²ç»å¾ˆå¤šäº†å•Šã€‚ã€‚ã€‚ã€‚
+12000æ²¡æœ‰ä»€ä¹ˆèƒ½å‡»å€’æˆ‘ï¼
+12000ä¸‹é¢å°±æ˜¯ä½“æ£€å¤§ä½œæˆ˜ï¼ï¼ï¼
+12000fightingï¼ï¼ï¼
+11000ä»€ä¹ˆå˜›ï¼Œç»“æžœè¿˜ä¸æ˜¯å“ªé‡Œéƒ½è¦æŽ’é˜Ÿã€‚ã€‚ã€‚ã€‚ã€‚
+73400çŸ¥è¶³å§ï¼Œå°‘å¥³ï¼æˆ‘æ˜¨å¤©æ¥çš„æ—¶å€™é˜Ÿä¼å¯æ˜¯æœ‰äºŒåå¤šç±³é•¿ï¼ä¸æ„§æ˜¯å·ç§°æœ‰å…­ä¸‡å¤šå¤§å­¦ç”Ÿçš„å¤§å­¦ï¼
+15000é¢ã€‚ã€‚ã€‚ã€‚æˆ‘å¯ä»¥åæ§½ä¹ˆã€‚ã€‚
+71000ä¸å¯ä»¥å‘¦ï¼Œå°‘å¥³ï¼Œè®©å§å§å–ä½ ä¸ªä¹–ï¼Œå’±å·å¤§çš„è‘—åæ ¡å‹è¿˜çœŸä¸å°‘ï¼Œä»€ä¹ˆéƒ­æ²«è‹¥ã€å·´é‡‘ã€åžä¹‹ç³ã€é™ˆå¯…æªã€å†¯æ±‰éª¥ã€å†¯å‹å…°ï¼Œè¿™äº›å¤§æ–‡è±ªéƒ½æ˜¯æ¥è‡ªå·å¤§çš„å“¦ï¼
+13000å’¦ï¼ŸçœŸçš„å—ï¼Ÿé‚£ä¸ªé™ˆå¯…æªå…ˆç”Ÿä¸æ˜¯å·ç§°æ¸…åŽç¬¬ä¸€æ‰å­å—ï¼Ÿç«Ÿç„¶è¿˜æ˜¯æˆ‘å·å¤§çš„ï¼Ÿè¿˜æœ‰åžä¹‹ç³ï¼Œä»–å†™çš„è¯—æˆ‘ä½œæ–‡å¼•ç”¨è¿‡æ— æ•°éå•Šå•Šå•Šå•Šï¼
+71000è¡¨å¤ªæ¿€åŠ¨å•Š
+13000å’¦ï¼Ÿé‚£æ˜¯ä»€ä¹ˆï¼Ÿ   
+00500ã€‚ã€‚ã€‚è¯·æ€€å­•æˆ–è€…åŠå¹´å†…è®¡åˆ’è¦æ€€å­•çš„åŒå­¦ä¸è¦å‚åŠ Xå…‰æ£€æŸ¥é¡¹ç›®ï¼ï¼ã€‚ã€‚ã€‚
+10500å¥½åƒå‘çŽ°äº†ä¸å¾—äº†çš„äº‹æƒ…å‘¢ã€‚ã€‚ã€‚ã€‚
+76000ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚åˆ°é¥­ç‚¹äº†ï¼Œæˆ‘å…ˆåŽ»é£Ÿå ‚åƒé¥­äº†å•Šï¼Œä½ è¿™è¾¹å®Œäº‹äº†å°±åŽ»é£Ÿå ‚æ‰¾æˆ‘å˜›ï¼
+11507å–‚å–‚ï¼ï¼åˆ«ä¸¢ä¸‹æˆ‘å•Šæ··è›‹ï¼
+00010
diff --git a/Resources/txt/Script3 b/Resources/txt/Script3
new file mode 100644
index 0000000..b13b932
--- /dev/null
+++ b/Resources/txt/Script3
@@ -0,0 +1,8 @@
+10302è‚šå­å¥½é¥¿ã€‚ã€‚ã€‚ä¸è¡Œäº†ã€‚ã€‚å¿…é¡»è¦è¡¥å……èƒ½é‡ã€‚ã€‚ã€‚
+15000å¥‡æ€ªã€‚ã€‚æ€Žä¹ˆä¹Ÿæ‰¾ä¸åˆ°Cå›ã€‚ã€‚ã€‚åªå¥½è‡ªå·±å…ˆåƒå†è¯´ã€‚ã€‚
+10000(ä¸çŸ¥é“èƒ½ä¸èƒ½åœ¨è¿™é‡Œé‡è§å­è½©å­¦é•¿å‘¢ã€‚ã€‚ã€‚ã€‚)
+10000(ä½œä¸ºä¸€ä¸ªä¸¥è°¨çš„æ¸¸æˆï¼Œæ˜¯ä¸ä¼šè®¾è®¡è¿™ä¹ˆç‹—è¡€çš„å‰§æƒ…çš„ï¼ï¼)
+10000å¥½å§ï¼Œé‚£æˆ‘åªå¥½ç‹¬è‡ªä¸ºé£Ÿç‰©è€Œæˆ˜æ–—äº†ï¼
+15000è¿™é‡Œçš„é¥­çœ‹èµ·æ¥ä¸é”™å˜›~
+13000å’¦ï¼Ÿè¿™æ˜¯ä»€ä¹ˆï¼Ÿ
+00117ä½ å‘çŽ°äº†å››å·å¤§å­¦æœ€æ–°ç‰ˆæ ¡å²å®£ä¼ å•1ï¼Œè¯·é—®æ˜¯å¦æ‰“å¼€ï¼Ÿ
\ No newline at end of file
diff --git a/Resources/txt/Script4 b/Resources/txt/Script4
new file mode 100644
index 0000000..a160d16
--- /dev/null
+++ b/Resources/txt/Script4
@@ -0,0 +1,25 @@
+10302å¥½é•¿çš„æ¡¥å•Š~~~~ä¸çŸ¥é“ä¸Žå¤šå°‘å…¬é‡Œå‘ï¼
+14000å•Šï¼é‚£æ˜¯------
+31400
+10000ï¼ˆé‚£ä¿¯èº«æœ›å‘æ¹–é¢çš„å°‘å¹´ï¼ŒæŸ”å’Œçš„ä¾§è„¸ä¸Žæ°´å…‰å¤©å½±å®Œç¾Žçš„èžåˆï¼Œåƒæ˜¯å‘½ä¸­æ³¨å®šä¼šå‘ç”Ÿçš„å°æ¦‚çŽ‡äº‹ä»¶ï¼Œæˆ‘---é‡è§äº†ä»–ã€‚)
+00000ï¼ˆä¼¼ä¹Žæˆ‘åœä½çš„ç›®å…‰è¢«ä»–å‘çŽ°äº†ï¼Œä»–å¿«æ­¥å‘æˆ‘èµ°æ¥â€”â€”â€”â€”ï¼‰
+10000(ç›®å…‰å¿§éƒçš„å°‘å¹´å¼€å£å‘æˆ‘é—®äº†ï¼Œæˆ‘çš„å¿ƒç´§å¼ çš„ç °ç °ä¹±è·³â€”â€”â€”â€”)
+33000æˆ‘ä¸¢å¤±çš„ä¸œè¥¿â€”â€”â€”â€”â€”â€”â€”â€”ä½ æ‰¾åˆ°äº†å—ï¼Ÿ
+10000(å•Šå•Šï¼Œä»€ä¹ˆæ„æ€å•Šï¼Ÿå®Œå…¨æ‘¸ä¸ç€å¤´è„‘å•Šã€‚ã€‚ã€‚)
+36000å“ˆå“ˆï¼Œæ˜¯éª—ä½ çš„~æ˜¯å°å­¦å¦¹å§ï¼ŸçœŸæ˜¯å¯çˆ±å‘ã€‚
+10000ä»€ä¹ˆå˜›ï¼å¤§å¥½çš„æ°”æ°›å®Œå…¨æ²¡æœ‰äº†å¥½å§ã€‚ã€‚
+36003å¥½äº†ï¼Œä½ ä¸€å®šä¸çŸ¥é“å…³äºŽè¿™ä¸ªé•¿æ¡¥çš„æ•…äº‹å§ï¼Ÿ
+32000å¹´å‰ï¼Œæœ‰ä¸€ä¸ªå»ºçŽ¯å­¦é™¢çš„ç”·ç”Ÿï¼Œæš—æ‹ä¸€ä¸ªå¥³ç”Ÿã€‚ã€‚
+32000å½“ä»–é¼“èµ·å‹‡æ°”è¦è¡¨ç™½çš„æ—¶å€™ï¼Œå¥³ç”Ÿå´è½¬åˆ°äº†åˆ«çš„å­¦é™¢ã€‚ã€‚ã€‚
+32000äºŽæ˜¯ä»–åªå¥½æŠŠè¿™ä»½æ„Ÿæƒ…åŸ‹è—åœ¨å¿ƒé‡Œã€‚ã€‚ã€‚
+32000äºŒåå¹´åŽï¼Œå½“ä»–å›žåˆ°æ¯æ ¡è¢«è˜è®¾è®¡è¿™æ¡é•¿æ¡¥çš„æ—¶å€™â€”â€”
+32000ä»–å°±æŠŠä¸€å°è‹±æ–‡ä¹¦å†™çš„æƒ…ä¹¦å°åœ¨çŸ³ç –ä¸Šåˆ†è´´åœ¨äº†é•¿æ¡¥ä¸Šï¼Œä»¥çºªå¿µé‚£æ®µæ— å§‹æ— ç»ˆçš„çˆ±æƒ…ã€‚
+11000çœŸæ˜¯é—æ†¾å‘ã€‚ã€‚ã€‚ã€‚è¦æ˜¯ä»–ä»¬å½“å¹´å¯ä»¥åœ¨ä¸€èµ·å°±å¥½äº†ã€‚ã€‚ã€‚
+12000ä¸è¿‡å­¦é•¿ï¼Œå¯ä»¥é—®ä¸€ä¸‹ä½ ä¸ºä»€ä¹ˆè¦ç«™åœ¨è¿™é‡Œçœ‹é£Žæ™¯å‘¢ï¼Ÿ
+36000å› ä¸ºæˆ‘å–œæ¬¢çœ‹ç€é£Žæ™¯åŽ»æƒ³è±¡åœ¨è¿™é‡Œå‘ç”Ÿçš„æ•…äº‹å•Šï¼Œ
+32000å°±åœ¨åˆšæ‰ï¼Œæˆ‘ç«™åœ¨æ¡¥ä¸Šï¼Œå°±ä»¿ä½›çœ‹è§äº†é‚£ä¸ºè®¾è®¡å¸ˆæ ¡å‹å’Œä»–å¿ƒçˆ±çš„å¥³ç”Ÿåœ¨æƒ…ä¹¦ä¸Šç›¸æ‹¥å•Šã€‚ã€‚
+12000å¤šä¹ˆç¾Žå¥½çš„ç”»é¢ã€‚ã€‚ã€‚ã€‚é‚£ä¹ˆï¼Œå°‘æ°å­¦é•¿ï¼Œå¯ä»¥å‘Šè¯‰æˆ‘å·å¤§å…¶ä»–çš„æ•…äº‹å—ï¼Ÿ
+36000å‘µå‘µï¼Œè¿™ä¸ªå°±è¦é ä½ è‡ªå·±åœ¨æ ¡å›­é‡ŒåŽ»å‘æŽ˜äº†ï¼Œæç¤ºä¸€ä¸‹ï¼Œåœ¨æ˜Žè¿œæ¹–å¾ˆæœ‰å¯èƒ½æœ‰æ„æƒ³ä¸åˆ°çš„æ”¶èŽ·å“¦~
+34000è¿™æ˜¯æˆ‘çš„åç‰‡ï¼Œå¦‚æžœå‘çŽ°äº†ç¾Žå¥½çš„æ•…äº‹è®°å¾—ä¸Žæˆ‘åˆ†äº«å“¦~See-ya~
+00507ï¼ˆå‘Šåˆ«äº†çœ¼ç¥žå¿§éƒè€Œåˆç‰¹åˆ«æµªæ¼«çš„å°‘å¹´ï¼Œæˆ‘åˆç»§ç»­å¼€å§‹äº†æŽ¢å¯»å·å¤§æ ¡å›­çš„æ—…é€”ã€‚ã€‚ã€‚ã€‚åŽ»å›¾ä¹¦é¦†è½¬è½¬å¥½äº†ï¼‰
+00010
\ No newline at end of file
diff --git a/Resources/txt/Script5 b/Resources/txt/Script5
new file mode 100644
index 0000000..49a715f
--- /dev/null
+++ b/Resources/txt/Script5
@@ -0,0 +1,4 @@
+13306è¿™å°±æ˜¯å·å¤§çš„å›¾ä¹¦é¦†äº†å•Šï¼ŒçœŸæ˜¯å¤§æ°”~
+1500Få¤§å®¶éƒ½å¾ˆå®‰é™çš„å­¦ä¹ å‘¢~
+14307æ—è¾¹çš„æ˜Žè¿œæ¹–å¥½æ¼‚äº®ï¼ŒåŽ»é‚£è¾¹çœ‹çœ‹å§
+00010
diff --git a/Resources/txt/Script6 b/Resources/txt/Script6
new file mode 100644
index 0000000..8f33e74
--- /dev/null
+++ b/Resources/txt/Script6
@@ -0,0 +1,19 @@
+10300ç»ˆäºŽæ¥åˆ°äº†å°‘æ°å­¦é•¿æ‰€è¯´çš„æ¹–è¾¹ï¼Œçœ‹ç€ç§€ç¾Žçš„æ™¯è‰²ï¼Œå¿ƒæƒ…ä¹Ÿå¹³é™äº†ä¸‹æ¥ã€‚
+11005å•Šï¼é‚£æ˜¯ä»€ä¹ˆï¼
+11000æ˜¯ä»€ä¹ˆäººï¼Ÿï¼ï¼
+92400ä¸è¦ç´§å¼ ï¼Œæˆ‘å«æ±Ÿç«¹ç­ ï¼Œä½ åº”è¯¥æ›´åŠ ç†Ÿæ‚‰æˆ‘çš„ä»£ç§°â€™æ±Ÿå§å§ï¼â€˜
+14000å•Šï¼æ˜¯è‘—åçš„é©å‘½å¥³è‹±é›„æ±Ÿå§å•Šï¼ï¼
+10000(çœ‹ç€é¢å‰çš„æ±Ÿå§éœ²å‡ºæ¸©å©‰çš„ç¬‘å®¹ï¼Œå®žåœ¨æ— æ³•æƒ³è±¡å°±æ˜¯è¿™ä¸ªäº‘æ·¡é£Žè½»çš„å¥³å­åœ¨æ¸£æ»“æ´žç»åŽ†äº†ä¸‡èˆ¬å±ˆè¾±ä¸ŽæŠ˜éº½ï¼ŒæŒºè¿‡äº†ç”µåˆ‘ï¼Œè€è™Žæ´žå’Œç«¹ç­¾é’‰æ‰‹æŒ‡çš„ç­‰ç­‰é…·åˆ‘ä¹‹åŽä¾ç„¶åšè´žä¸å±ˆçš„æ ·å­å•Šã€‚ã€‚ã€‚)
+91000ä¸ç”¨è¿™æ ·çœ‹ç€æˆ‘ï¼Œè¯´èµ·æ¥æˆ‘è¿˜æ˜¯ä½ å†œå­¦é™¢çš„å­¦å§å‘¢ã€‚ã€‚
+13010é‚£ä¹ˆæ‚¨ä¸ºä»€ä¹ˆä¼šå‡ºçŽ°åœ¨è¿™é‡Œå‘¢ï¼Ÿ
+00000æ±Ÿå§çœ‹å‘å¹³é™çš„æ¹–é¢ï¼Œéœ²å‡ºæ€€å¿µçš„ç¥žè‰²
+94000å› ä¸ºåœ¨å·å¤§çš„è¿™æ®µæ—¶å…‰æ˜¯29å¹´ç”Ÿå‘½ä¸­æœ€ç¾Žå¥½çš„æ—¶å…‰å•Šã€‚ã€‚ã€‚
+95000æ²¡æœ‰æ•Œäººï¼Œæ²¡æœ‰ä»»åŠ¡ï¼Œå°±åœ¨è¿™é‡Œï¼Œæˆ‘é‡è§äº†å’æ¢§å“¥ï¼Œè™½ç„¶å¼€å§‹æ˜¯ç»„ç»‡å®‰æŽ’æˆ‘ä»¬æ‰®ä½œå¤«å¦»ï¼Œä½†æ˜¯æˆ‘ä»¬ä¹‹é—´çš„ç›¸å¤„æ¯åˆ†æ¯ç§’éƒ½è®©äººæ„Ÿåˆ°å¾ˆå®‰å¿ƒå¾ˆæ¸©æš–ï¼Œå°±æ˜¯è¿™æ®µå›žå¿†æ”¯æŒæˆ‘æ’‘è¿‡æ¸£æ»“æ´žæ•Œäººçš„é…·åˆ‘ã€‚ã€‚ã€‚
+14000é‚£æ—¶å€™çš„å·å¤§æ˜¯ä»€ä¹ˆæ ·å­çš„å‘¢ï¼Ÿ
+91000æˆ‘è®°å¾—é‚£æ—¶å€™çš„å›½ç«‹å·å¤§ï¼Œæœ‰æ–‡å­¦é™¢ï¼Œå¤–å›½æ–‡å­¦é™¢ï¼Œæ³•æ”¿å­¦é™¢ï¼Œå·¥ç§‘å­¦é™¢å’Œå†œç§‘å­¦é™¢äº”å¤§æ ¡ï¼ŒåŽè¥¿é‚£æ—¶å€™è¿˜æ˜¯æ•™ä¼šå­¦æ ¡å‘¢ï¼Œæˆ‘ä»¬çš„æ ¡é•¿è¿˜æ˜¯å¼ æ¾œè€å…ˆç”Ÿã€‚ã€‚ã€‚ã€‚
+11000å±…ç„¶æ˜¯è¿™æ ·å‘¢ã€‚ã€‚ã€‚ã€‚ã€‚
+92000æˆ‘çŽ°åœ¨æ¥åˆ°å°†æŒ‰æ–°æ ¡åŒºï¼Œçœ‹åˆ°è¿™ä¹ˆå¤šä¸åŒå­¦é™¢ä¸åŒä¸“ä¸šçš„å­¦ç”Ÿè¿˜å“äº†ä¸€è·³å‘¢ï¼å·å¤§çœŸæ˜¯å‘å±•çš„è¶Šæ¥è¶Šå¥½äº†å•Šã€‚ã€‚
+10000æˆ‘è¿˜çœŸæ˜¯è›®å¹¸è¿çš„ã€‚ã€‚èƒ½ç”Ÿåœ¨è¿™ä¸ªç¹åŽå®‰é€¸çš„æ—¶ä»£ã€‚ã€‚ã€‚
+93000å¥½äº†ï¼Œæˆ‘ä¹Ÿè¯¥ç¦»å¼€äº†ã€‚å°å­¦å¦¹ï¼Œè¦åŠªåŠ›å­¦ä¹ å“¦ï¼æˆ‘åŽŸæ¥å¯æ˜¯æˆ‘ä»¬ä¸“ä¸šçš„ç¬¬ä¸€åå‘¢ã€‚ã€‚ã€‚
+10507æ”¾å¿ƒå§ï¼Œæ±Ÿå§ï¼Œæˆ‘ä¸€å®šä¸ä¼šå¿˜è®°ä½ çš„æœŸæœ›ï¼é‚£ä¹ˆä¸‹é¢åŽ»é‚£é‡Œé€›é€›å‘¢ï¼Ÿåˆšåˆšè·¯è¿‡ä¸€ä¸ªå«äºŒåŸºæ¥¼çš„åœ°æ–¹ï¼ŒåŽ»é‡Œé¢çœ‹çœ‹å§
+00010
\ No newline at end of file
diff --git a/Resources/txt/Script7 b/Resources/txt/Script7
new file mode 100644
index 0000000..2e73639
--- /dev/null
+++ b/Resources/txt/Script7
@@ -0,0 +1,40 @@
+1030Fè¿™é‡Œå°±æ˜¯äºŒåŸºæ¥¼äº†å§ï¼Œå¬å­¦é•¿è¯´æ˜¯åšå¯æ¶çš„ç‰©ç†å®žéªŒå’Œå¯æ¶çš„ç”µå­æŠ€æœ¯å®žéªŒçš„åœ°æ–¹å‘€ã€‚ã€‚ã€‚
+12005ï¼ï¼ï¼è¿™æ˜Žæ˜Žæ˜¯é¬¼å±‹å¥½ä¸å¥½ï¼
+10000è™½ç„¶ä¸åœåœ°è‡ªæˆ‘å‚¬çœ è¦æ·¡å®šï¼Œå¯æ˜¯è„‘æµ·ä¸­è¿˜æ˜¯æƒ…ä¸è‡ªç¦çš„å›žå“èµ·â€”â€”â€”â€”
+65400å¬è¯´è¿™æ ¡å›­é‡Œæœ‰æ¸¸è¡çš„å†¤é­‚å“¦~
+16000è¿™ä¹ˆè¯´çš„è¯åªè¦æ™šä¸Šä¸å‡ºé—¨å°±æ²¡äº‹äº†å§ï¼Ÿ
+64000ä¸æ˜¯è¿™æ ·çš„å‘¦~å¬è¯´æœ‰äº›åŽ‰å®³çš„é¬¼é­‚å¯ä»¥åœ¨ç™½å¤©å‡ºæ²¡æŠ½å–æ´»äººçš„ç²¾æ°”å‘¢ã€‚ã€‚ã€‚ã€‚
+16400ï¼ï¼ï¼ï¼
+00000ï¼ˆå°±åœ¨è¿™æ—¶ï¼Œæœ¬æ¥ååˆ†å®é™çš„èµ°å»Šå›žå“èµ·ä¸€ä¸²ç¼“æ…¢çš„è„šæ­¥å£°ï¼‰
+00000ï¼ˆæ˜¯å¼€å…³ä¸Šçš„å£°éŸ³ï¼Œç´§æŽ¥ç€ç¯å¼€äº†ï¼Œå‡ºçŽ°äº†ä¸€ä¸ªé«˜å¤§çš„ç”·ç”Ÿç«™åœ¨æˆ‘é¢å‰ï¼‰
+44400è¿™ä½åŒå­¦ï¼Œä½ è¿˜å¥½å§ï¼Ÿ
+16000é¢ã€‚ã€‚ã€‚ã€‚ä¸è¦æ²¡äº‹è£…é¬¼å“äººå•Šï¼ä½ å¥½ï¼Œæˆ‘æ˜¯è®¡ç®—æœºå­¦é™¢çš„æ–°ç”ŸXX~
+46000å‘µå‘µã€‚
+16000ã€‚ã€‚ã€‚å‘µå‘µã€‚
+10000(ä¸è¡Œå•Šï¼Œä½ ä¸€å®šè¦è¯´ç‚¹ä»€ä¹ˆå•Šä¸ç„¶å¤ªå°´å°¬äº†ã€‚ã€‚ã€‚ã€‚ã€‚)
+13000é‚£ä¸ªï¼Œè¯·é—®æˆ‘ä»¬æ–°ç”Ÿçš„è¾…å¯¼å‘˜è€å¸ˆåŠžå…¬å®¤åœ¨å“ªé‡Œå‘€ï¼Œæˆ‘æƒ³åœ¨å¼€å­¦å‰åŽ»æ‹œè®¿ä»–ã€‚ã€‚ã€‚
+41000å‘µå‘µï¼Œè¿™é‡Œåœ°å½¢æ¯”è¾ƒå¤æ‚ï¼Œæˆ‘è„‘å­æ¯”è¾ƒç¬¨ï¼Œå‘µå‘µï¼Œåªèµ°è¿‡å‡ æ¬¡æ‰€ä»¥åªå¥½å¸¦ä½ åŽ»è¯•è¯•äº†ã€‚
+10000(çœ‹ç€èº«ä¾§é«˜å¤§è€Œæ²‰é»˜çš„èº«å½±ï¼Œè™½ç„¶æœ‰ç‚¹ç¬¨ç¬¨çš„ï¼Œä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆæˆ‘çš„å¿ƒä¸­å……æ»¡äº†å®‰è¯¦çš„æ„Ÿè§‰ã€‚è¿™å®¶ä¼™ï¼Œå‚»å‚»çš„ä¹Ÿå¾ˆå¯çˆ±å‘€~)
+15000å•Š~~åŽ†å°½åƒè¾›ä¸‡è‹¦ç»ˆäºŽæ‰¾åˆ°å•¦ï¼ï¼
+47000å‘µå‘µã€‚
+16000çœŸæ˜¯è°¢è°¢ä½ äº†ï¼å¯¹äº†ï¼Œä½ å¸®æˆ‘è¿™ä¹ˆå¤§çš„å¿™æˆ‘è¿˜ä¸çŸ¥åˆ°ä½ çš„åå­—å‘¢ã€‚ã€‚ã€‚
+46000æˆ‘å«å»ºå›½ã€‚
+1000Dæˆ‘è¯¥è¯´ä»€ä¹ˆï¼Œè¿™åå­—è®©æˆ‘åˆšæ‰çš„å¿ƒç†æ´»åŠ¨æœ‰ç§å¤§æµ·çš„æ„Ÿè§‰è¿˜æ˜¯è¿™åå­—å’Œä»–æœ¬äººç«Ÿç„¶å‡ºä¹Žæ„æ–™çš„ç›¸é…å‘¢ï¼Ÿ
+15500å‘ï¼å»ºã€‚ã€‚ã€‚å›½ã€‚æˆ‘å…ˆè¿›åŽ»å•¦ï¼Œä¸‹æ¬¡å†è°¢ä½ å–½~
+00000
+15300å•Šï¼Œå¯¼å‘˜è€å¸ˆçœŸæ˜¯ä¸€ä¸ªæ¸©æŸ”çš„å¥½äººå‘~çœŸæ˜¯Luckyï¼ï¼
+14000å»ºå›½ï¼Ÿä½ ä¸ºä»€ä¹ˆè¿˜åœ¨è¿™ï¼Ÿä¸ä¼šæ˜¯åœ¨ç­‰æˆ‘å§ï¼ï¼ï¼
+41400å“¦ï¼Œå› ä¸ºæˆ‘æ€•XXä½ è‡ªå·±èµ°ä¼šè¿·è·¯ã€‚æ‰€ä»¥æˆ‘å°±åŠžå®Œäº‹ç­‰ä½ å‡ºæ¥ä¸€èµ·èµ°å¥½äº†
+10000(ã€‚ã€‚ã€‚ã€‚æˆ‘çœ‹èµ·æ¥åƒæ˜¯ç™¾åˆ†ç™¾è¿·è·¯è´§å—ï¼Ÿã€‚ã€‚ã€‚ã€‚ã€‚ä¸è¿‡è¿˜çœŸæ˜¯æœ‰ç‚¹æ„ŸåŠ¨å‘¢ã€‚ã€‚ã€‚ã€‚ã€‚)
+16000å•Šï¼Œè™½ç„¶æ„Ÿè§‰åº”è¯¥æ²¡ä»€ä¹ˆäº‹ï¼Œè¿˜æ˜¯è°¢è°¢ä½ äº†ã€‚
+13000ä¸è¿‡å»ºå›½å•Šï¼Œè¿™é‡ŒçœŸçš„ä¸ä¼šé‡åˆ°é‡Žç”Ÿçš„å±…é‡Œå¤«äººä¸€ç±»çš„BOSSå§ï¼Ÿ
+44000ä½ åœ¨æƒ³ä»€ä¹ˆå•Šã€‚ã€‚ã€‚è¿™é‡Œå°±åªæœ‰ç‰©ç†å™¨æå’Œå„ç§ç”µè„‘å•Šï¼Œä½ çœŸåº”è¯¥åŽ»çœ‹çœ‹å­¦æ ¡é‚£äº›æ–°ä¹°çš„è”æƒ³ä¸€ä½“æœºå•Šï¼ŒçœŸçš„å¾ˆé…·å“¦ã€‚ã€‚ã€‚
+10000(æ²Ÿé€šæœ‰éšœç¢äº†ã€‚ã€‚ã€‚)
+15000æ€»ä¹‹ï¼Œä»Šå¤©çœŸæ˜¯ååˆ†æ„Ÿè°¢ï¼
+46000å•Šï¼Œæ²¡æœ‰å…³ç³»çš„ï¼Œåæ­£æˆ‘ä¹Ÿæ²¡ä»€ä¹ˆäº‹ï¼Œè¿™æ˜¯æˆ‘çš„æ‰‹æœºå·ç ï¼Œä»¥åŽå¦‚æžœè¿·è·¯çš„è¯è¿˜å¯ä»¥æ‰“ç»™æˆ‘çš„ã€‚å†è§ã€‚
+00400
+10000å¹²å˜›é—ªé‚£ä¹ˆå¿«ï¼ŒçœŸæ˜¯çš„ã€‚ã€‚ã€‚ã€‚ä¸è¿‡è¿˜çœŸæ˜¯ä¸ªå¥½äººå‘
+00000ï¼ˆæ‰‹æœºé“ƒå£°ï¼‰
+00000ï¼ˆç”µè¯å½•éŸ³ï¼šå–‚ï¼Œå¼€å­¦ä»ªå¼é©¬ä¸Šå°±è¦å¼€å§‹äº†ï¼Œä½ æ€Žä¹ˆè¿˜æ²¡åˆ°å‘ï¼Ÿï¼Ÿï¼Ÿï¼‰
+11307ç³Ÿäº†ï¼ï¼ï¼å…‰é¡¾ç€åœ¨æ ¡å›­é‡ŒçžŽé€›ï¼Œéƒ½å¿˜äº†è¦åŽ»ä½“è‚²é¦†å‚åŠ ä»ªå¼çš„äº‹äº†ï¼ï¼
+00010
\ No newline at end of file
diff --git a/Resources/txt/Script8 b/Resources/txt/Script8
new file mode 100644
index 0000000..850555b
--- /dev/null
+++ b/Resources/txt/Script8
@@ -0,0 +1,16 @@
+10300è¿™ä¹ˆå¤šäººå•Šï¼Œè¦åå“ªé‡Œå‘ï¼Ÿ
+51400å–‚ï¼
+63000ä½ åŽ»å“ªå•¦ï¼Ÿæˆ‘ä»¬å¯å®¤éƒ½åˆ°é½äº†ï¼Œå°±å·®ä½ å•¦
+11000å•Šï¼Œæˆ‘å±…ç„¶æ˜¯æœ€åŽä¸€ä¸ªã€‚ã€‚ã€‚ã€‚å¥½ä¸¢è„¸ã€‚ã€‚ã€‚ã€‚
+16000é‚£ä¸ªã€‚ã€‚ã€‚ã€‚ã€‚æŠ±æ­‰å› ä¸ºæˆ‘åœ¨æ ¡å›­é‡Œé€›å¾—å¤ªhighå°±æ™šäº†ã€‚ã€‚ã€‚ã€‚ã€‚
+65000ç®—å•¦ç®—å•¦ï¼Œè¿™æ¬¡å…ˆåŽŸè°…ä½ äº†ï¼ŒçŽ°åœ¨æ˜¯å­¦ç”Ÿä»£è¡¨å‘è¨€ï¼Œä½ å…ˆå¸®å¿™å¬ç€ï¼Œæˆ‘çŽ©ä¼šæ‰‹æœºå…ˆ~
+00000å­¦ç”Ÿä»£è¡¨ï¼šã€‚ã€‚ã€‚ã€‚å¾ˆæ—©ä¹‹å‰ï¼Œæˆ‘å°±ååˆ†ä»°æ…•å·å¤§ï¼Œå› ä¸ºè¿™é‡Œæ›¾ç»åŸ¹å…»å‡ºè®¸å¤šä¼˜ç§€çš„æ ¡å‹ï¼Œæ¯”å¦‚éƒ­æ²«è‹¥ï¼Œå·´é‡‘ï¼Œå½­å’æ¢§ï¼Œæœ±å¾·ï¼Œæ±Ÿå§ã€‚ã€‚ã€‚ã€‚ã€‚
+14000è¿™ä¸ªå½­å’æ¢§æ˜¯ä»€ä¹ˆäººå‘ï¼Ÿæ„Ÿè§‰åå­—å¾ˆæœ‰éŸµå‘³é‚£ã€‚ã€‚
+55000å“¦ï¼Œå¥½åƒæ˜¯é©å‘½çƒˆå£«çš„è¯´ï¼Œä¸è¿‡æœ€åŽæ­»çš„å¾ˆæƒ¨ï¼Œè„‘è¢‹è¢«é‚£äº›å›½æ°‘å…šç ä¸‹æ¥ç¤ºä¼—ä¸€å‘¨å•Šã€‚ã€‚ã€‚
+61000è¿˜æœ‰é‚£ä¸ªæ±Ÿå§å•Šï¼Œå¬è¯´ç”Ÿå‰ç»åŽ†äº†å„ç§æ¯”æ»¡æ¸…åå¤§é…·åˆ‘è¿˜å˜æ€çš„æŠ˜ç£¨é‚£ï¼ï¼
+75000ï¼šã€‚ã€‚ã€‚ã€‚ã€‚ã€‚å¥½ææ€–ã€‚ã€‚ã€‚
+62000ä¸è¯´è¿™ä¸ªäº†ã€‚å“Žä½ ä»¬çŸ¥é“å—ï¼Œé‚£ä¸ªæ–‡å­¦å·¨åŒ éƒ­æ²«è‹¥ï¼Œå»ºå›½ä¹‹åŽè¿˜æœ‰å››ä¸ªè€å©†å‘¢ã€‚ã€‚å…¶ä¸­ä¸¤ä¸ªè¿˜æ˜¯æ—¥æœ¬äººã€‚ã€‚ã€‚
+77000å•§å•§ã€‚ã€‚ã€‚ã€‚ã€‚
+00000å­¦ç”Ÿä»£è¡¨ï¼šè€ŒçŽ°åœ¨çš„å·å¤§ï¼Œä¸ä»…æœ‰ä¸Šå¸‚å¸‚å€¼4äº¿å…ƒçš„å·å¤§æ™ºèƒœå…¬å¸ï¼Œè¿˜æœ‰å…¶ä»–å„ç§å›½å®¶é‡ç‚¹ç ”ç©¶æ‰€ã€‚æˆ‘ä»¬çš„æ ¡æ——ï¼Œé£žä¸Šè¿‡å¤ªç©ºï¼Œé©»è¶³åœ¨å—æžï¼Œæ›´å‘ç€æ— é™å…‰è¾‰çš„æœªæ¥è¿›å‘ã€‚ã€‚ã€‚ã€‚
+10500æ¼«ä¸ç»å¿ƒçš„å¬ç€å­¦ç”Ÿä»£è¡¨å……æ»¡æ­£èƒ½é‡çš„å‘è¨€ï¼Œå›žæƒ³ç€è¿™ä¸€å¤©é‡è§çš„äººå’Œäº‹å„¿ï¼Œå¯¹å°†æ¥çš„å¤§å­¦ç”Ÿæ´»å……æ»¡äº†æœŸå¾…å‘€ã€‚
+00010
\ No newline at end of file
diff --git a/Resources/txt/Script9 b/Resources/txt/Script9
new file mode 100644
index 0000000..f13a687
--- /dev/null
+++ b/Resources/txt/Script9
@@ -0,0 +1,19 @@
+10300ï¼ˆåœ¨æ ¡å›­é€›äº†ä¸€æ•´å¤©çš„æˆ‘æœ‰ç‚¹ç–²æƒ«äº†ï¼Œé‚£ä¹ˆä¸‹é¢è¦åŽ»å“ªé‡Œé€›å‘¢ï¼Ÿï¼‰
+0000Bï¼ˆæ‰‹æœºçŸ­ä¿¡é“ƒå£°ï¼‰
+10000æœ‰çŸ­ä¿¡æ¥äº†ï¼
+00000â€˜XXï¼Œä¸Šæ¬¡å’Œä½ äº¤è°ˆååˆ†æ„‰å¿«ï¼Œæˆ‘è§‰å¾—ä½ æ˜¯ä¸€ä¸ªååˆ†å¯çˆ±çš„å¥³å­©ï¼Œæˆ‘ä»¬äº¤å¾€å§ï¼æˆ‘åœ¨ä¸é«˜å±±ç­‰ä½ ï¼ï¼ï¼ï¼â€™
+11000ï¼ï¼ï¼ï¼
+16000è¯´ä¸ç´§å¼ ä¸€å®šæ˜¯å‡çš„ï¼Œä½†å‘çŸ­ä¿¡çš„äººä¼šæ˜¯è°å‘¢ï¼Ÿä»Šå¤©ä¸ºæ­¢æˆ‘åªç»™äº†ä¸‰ä¸ªå¼‚æ€§æ‰‹æœºå·å•Šï¼Œ
+16000åˆ°åº•è¦ä¸è¦åŽ»å‘¢ï¼Ÿ
+83400
+13000å•Šâ€”â€”â€”â€”â€”â€”
+81000å­©å­ï¼Œçœ‹ä½ åˆšæ‰çŠ¹è±«çš„æ ·å­æ˜¯é‡åˆ°äº†ä»€ä¹ˆéš¾é¢˜å—ï¼Ÿ
+10000(ä¸€æ®µè§£é‡Šï¼Œåœ¨æ­¤çœç•¥ã€‚ã€‚ã€‚)
+85000åŽŸæ¥æ˜¯è¿™æ ·ï¼Œä¸ç®¡æ˜¯è°ï¼Œä¸ç®¡ä½ æ˜¯å¦ç­”åº”ï¼Œæœ€å¥½éƒ½æ˜¯è¦è·Ÿäººå®¶è¯´æ¸…æ¥šä½ çš„å¿ƒæ„å•Šã€‚ã€‚ã€‚ã€‚
+82000è‡³äºŽåˆ°åº•æ˜¯è°å‘çš„è¿™ä¸ªçŸ­ä¿¡ã€‚ã€‚ã€‚æƒ³æƒ³ä½ å¿ƒé‡ŒæœŸæœ›çš„é‚£ä¸ªäººæ˜¯è°ï¼Œå†åŽ»èµ´çº¦å§ï¼ï¼ï¼
+10400çˆ·çˆ·è¯´çš„è¯æœ‰é“ç†å•Šï¼ŒXXï¼Œé¼“èµ·å‹‡æ°”æ¥ï¼ä½ å¯ä»¥çš„ï¼ï¼
+10000(è¿˜æœ‰ï¼Œæˆ‘åˆ°åº•å¸Œæœ›æ˜¯è°å‘çš„é‚£æ¡çŸ­ä¿¡å‘¢ï¼Ÿ)
+25400æ˜¯çƒ­æƒ…é˜³å…‰è€Œåˆä¹äºŽåŠ©äººçš„å­è½©ï¼Ÿ
+31000è¿˜æ˜¯ä¿Šç¾Žå¿§éƒåˆå¯Œæœ‰æµªæ¼«æ°”è´¨çš„å°‘æ°ï¼Ÿ
+47000è¿˜æ˜¯æ†¨åŽšè€å®žåˆæ·³æœ´çš„å»ºå›½ï¼Ÿ
+16130æˆ‘å¿ƒé‡Œå¸Œæœ›é‚£ä¸ªäººæ˜¯â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
\ No newline at end of file
diff --git a/Resources/txt/names.txt b/Resources/txt/names.txt
new file mode 100644
index 0000000..263dde9
--- /dev/null
+++ b/Resources/txt/names.txt
@@ -0,0 +1,10 @@
+
+ÄÂæº:
+×ÓÐù:
+ÉÙ½Ü:
+½¨¹ú:
+Â·ÈËA:
+Â·ÈËB:
+Â·ÈËC:
+ÀÏÒ¯Ò¯:
+½­½ã:
diff --git "a/doc/function/~$\344\273\266CSV\345\256\232\344\271\211.docx" "b/doc/function/~$\344\273\266CSV\345\256\232\344\271\211.docx"
deleted file mode 100644
index acb9a89..0000000
diff --git "a/doc/function/\344\272\213\344\273\266CSV\345\256\232\344\271\211.docx" "b/doc/function/\344\272\213\344\273\266CSV\345\256\232\344\271\211.docx"
index e6d2d1d..dfb331d 100644
--- "a/doc/function/\344\272\213\344\273\266CSV\345\256\232\344\271\211.docx"
+++ "b/doc/function/\344\272\213\344\273\266CSV\345\256\232\344\271\211.docx"
@@ -6,7 +6,7 @@ CSVå±žæ€§è¯´æ˜Ž
 * Descriptionï¼šäº‹ä»¶æè¿°ï¼Œç”¨ä½œæ³¨é‡Š
 * Idï¼šäº‹ä»¶id
 * Categoryï¼šNPCç±»åž‹ã€‚æœ‰notï¼ˆ-1ï¼‰ã€standï¼ˆ0ï¼‰ã€turnï¼ˆ1ï¼‰å’Œwalkï¼ˆ2ï¼‰ä¸­çš„ä¸€ä¸ª
-* Typeï¼šTypeï¼šäº‹ä»¶ç±»åž‹ã€‚æœ‰TALKMAN_EVTï¼ˆ0ï¼‰ï¼ŒGET_SUP_EVTï¼ˆ1ï¼‰ï¼ŒDIALOG_EVTï¼ˆ2ï¼‰
+* Typeï¼šTypeï¼šäº‹ä»¶ç±»åž‹ã€‚æœ‰TALKMAN_EVTï¼ˆ0ï¼‰ï¼ŒGET_SUP_EVTï¼ˆ1ï¼‰ï¼ŒDIALOG_EVTï¼ˆ2ï¼‰ï¼ŒSHADOW_EVTï¼ˆ3ï¼‰ï¼ŒRELOAD_EVTï¼ˆ4ï¼‰
 * imgNoï¼šNPCå›¾ç‰‡idã€‚æœ‰ATRIG_NO_MAN_IMGNOï¼ˆ-1ï¼‰ã€STAND_TRIG_IMGNOï¼ˆ-10ï¼‰ã€å›¾ç‰‡id
 * nextï¼šåŽç»­äº‹ä»¶idã€‚æœ‰æ— åŽç»­äº‹ä»¶ï¼ˆ-1ï¼‰ã€åŽç»­äº‹ä»¶id
 * nPreConditionï¼šæœ‰å¤šå°‘ä¸ªå‰å¯¼äº‹ä»¶ã€‚
@@ -18,16 +18,15 @@ CSVå±žæ€§è¯´æ˜Ž
 * Presï¼šnPreConditionä¸ªå‰å¯¼äº‹ä»¶idã€‚
 æ¸©é¦¨æç¤ºï¼š
 * æœªå¼€æ”¾ä½¿ç”¨åŠŸèƒ½çš„å±žæ€§åº”å‚ç…§ä¾‹å­å¡«å†™
-* XYåæ ‡å¯ä»¥æ‰“å¼€TileMapé¼ æ ‡é€‰ç‚¹æŸ¥çœ‹
+* XYåæ ‡å¯ä»¥æ‰“å¼€TileMapé¼ æ ‡é€‰ç‚¹æŸ¥çœ‹ï¼Œä¸Žä½ç½®æ— å…³äº‹ä»¶XYåº”å¡«å†™0,0
 * Descriptionä¸å¡«å†™å¯¹äºŽæ¸¸æˆè¿è¡Œæ²¡æœ‰å½±å“
 * äº‹ä»¶idå¯ä»¥é€šè¿‡excelæ‹–åŠ¨é¼ æ ‡è‡ªåŠ¨ç´¯åŠ ç”Ÿæˆ
 * å¯¹äºŽimgNoå±žæ€§ï¼Œå›¾ç‰‡å¯ä»¥åœ¨Resources/img/man/ç›®å½•ä¸‹æŒ‘é€‰
 * æ¯ä¸€æ¡è®°å½•å±žæ€§çš„ä¸ªæ•°ä¼šå› ï¼ˆnPreCondition+ nDialog+ nArgumentï¼‰ä¸åŒè€Œæœ‰æ‰€å·®å¼‚
-
 Argsåè®®ï¼š
 * WalkingManï¼ˆType 0ï¼ŒCategory 3ï¼‰argsä¸­å®šä¹‰è¡Œèµ°è·¯å¾„ï¼Œåº”åŒ…æ‹¬æ‰€æœ‰è½¬æŠ˜ç‚¹ï¼Œå¹¶æž„æˆå›žè·¯
 * StandingManï¼ˆType 0ï¼ŒCategory 1ï¼‰argsä¸­å®šä¹‰é¢æœæ–¹å‘ï¼Œä¸ºä¸‹0å·¦1å³2ä¸Š3
-
+* GetShadowï¼ˆType 3ï¼‰argsä¸­å®šä¹‰ç”·æœ‹å‹å‡ºçŽ°ä½ç½®æ–¹å‘ï¼Œä¸ºä¸‹0å·¦1å³2ä¸Š3ï¼Œé»˜è®¤ä¸ºå³
 Dialogsåè®®
 * TALKMAN_EVTï¼ˆType 0ï¼‰åŒ…å«å¯¹è¯
 * DIALOG_EVTï¼ˆType 2ï¼‰åŒ…å«å¯¹è¯
